<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIT IMPRESE - Assistente Compilazione Domanda</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #0066cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .container-main {
            max-width: 1200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 0;
            overflow: hidden;
        }
        
        .header-section {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header-section h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header-section p {
            margin: 0;
            opacity: 0.9;
        }
        
        .progress-section {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 0;
        }
        
        .step-item {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #dee2e6;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .step-item.active .step-circle {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .step-item.completed .step-circle {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .step-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .step-item.active .step-label {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .content-section {
            padding: 40px 30px;
        }
        
        .fase-container {
            display: none;
        }
        
        .fase-container.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fase-title {
            color: var(--primary-color);
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .fase-subtitle {
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1.05rem;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .form-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .required::after {
            content: ' *';
            color: var(--danger-color);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25);
        }
        
        .alert-info-custom {
            background: #e7f3ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .alert-warning-custom {
            background: #fff3cd;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .alert-danger-custom {
            background: #f8d7da;
            border-left: 4px solid var(--danger-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .result-box {
            background: white;
            border: 2px solid var(--success-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .result-box h4 {
            color: var(--success-color);
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: #495057;
        }
        
        .result-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .btn-primary-custom {
            background: var(--primary-color);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 5px;
            transition: all 0.3s;
            color: white;
        }
        
        .btn-primary-custom:hover {
            background: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
        }
        
        .btn-secondary-custom {
            background: #6c757d;
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 5px;
            color: white;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .preventivo-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .preventivo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .preventivo-tipologia {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .badge-qualificato {
            background: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        .badge-standard {
            background: #6c757d;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        .checklist-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .checklist-item.completed {
            border-color: var(--success-color);
            background: #f0fff4;
        }
        
        .checklist-checkbox {
            width: 30px;
            height: 30px;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .checklist-content {
            flex: 1;
        }
        
        .checklist-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .checklist-description {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .export-btn {
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .export-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .export-btn i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .summary-card h5 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .table-preventivi {
            font-size: 0.95rem;
        }
        
        .table-preventivi th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="container-main">
           <!-- Header -->
<div class="header-section">
    <h1><i class="fas fa-laptop-code"></i> DIGIT IMPRESE</h1>
    <p>Assistente per la Compilazione della Domanda - Azione 1.2.2</p>
    <p class="mt-2"><small>FSC Sicilia 2021-2027 | Periodo presentazione: 13-27 Novembre 2025</small></p>
    <div class="mt-3">
        <button class="btn btn-sm btn-outline-light" onclick="document.getElementById('fileCaricaProgetto').click()" title="Carica un progetto salvato">
            <i class="fas fa-folder-open"></i> Carica Progetto
        </button>
        <input type="file" id="fileCaricaProgetto" accept=".json" style="display: none;" onchange="caricaProgettoDaFile(event)">
        
        <button class="btn btn-sm btn-outline-light" onclick="salvaProgettoSuFile()" title="Salva il progetto corrente">
            <i class="fas fa-save"></i> Salva Progetto
        </button>
        
        <button class="btn btn-sm btn-outline-light" onclick="nuovoProgetto()" title="Inizia un nuovo progetto">
            <i class="fas fa-file"></i> Nuovo Progetto
        </button>
    </div>
</div>
            
            <!-- Progress Indicator -->
            <div class="progress-section">
                <div class="step-indicator" id="stepIndicator">
                    <div class="step-item active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Ammissibilità</div>
                    </div>
                    <div class="step-item" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Calcolo MOL</div>
                    </div>
                    <div class="step-item" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Preventivi</div>
                    </div>
                    <div class="step-item" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Istanza 2.1</div>
                    </div>
                    <div class="step-item" data-step="5">
                        <div class="step-circle">5</div>
                        <div class="step-label">Formulario F</div>
                    </div>
                    <div class="step-item" data-step="6">
                        <div class="step-circle">6</div>
                        <div class="step-label">Checklist</div>
                    </div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="content-section">
                <!-- FASE 1: Ammissibilità e Dati Base -->
                <div class="fase-container active" id="fase1">
                    <h2 class="fase-title">FASE 1: Verifica Ammissibilità e Dati Anagrafici</h2>
                    <p class="fase-subtitle">Verifica dei requisiti preliminari per l'accesso al bando</p>
                    
                    <div class="alert-info-custom">
                        <i class="fas fa-info-circle"></i> <strong>Importante:</strong> L'impresa deve essere costituita e attiva da almeno un anno e avere sede legale o unità operativa in Sicilia.
                    </div>
                    
                    <!-- Dati Impresa -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-building"></i> Dati Impresa</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Ragione Sociale</label>
                                <input type="text" class="form-control" id="ragioneSociale" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label required">Partita IVA</label>
                                <input type="text" class="form-control" id="partitaIva" maxlength="11" pattern="[0-9]{11}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label required">Codice Fiscale</label>
                                <input type="text" class="form-control" id="codiceFiscale" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">PEC</label>
                                <input type="email" class="form-control" id="pec" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Anno Costituzione</label>
                                <input type="number" class="form-control" id="annoCostituzione" min="1900" max="2024" required>
                                <small class="text-muted">Deve essere attiva da almeno 1 anno</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label required">Sede Legale (Indirizzo completo)</label>
                                <input type="text" class="form-control" id="sedeLegale" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Sede in Sicilia?</label>
                                <select class="form-select" id="sedeSicilia" required>
                                    <option value="">Seleziona...</option>
                                    <option value="si">Sì - Sede legale in Sicilia</option>
                                    <option value="unita">Sì - Unità operativa in Sicilia</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Dimensione Impresa</label>
                                <select class="form-select" id="dimensioneImpresa" required>
                                    <option value="">Seleziona...</option>
                                    <option value="micro">Microimpresa (< 10 dipendenti, ≤ 2M€ fatturato)</option>
                                    <option value="piccola">Piccola Impresa (< 50 dipendenti, ≤ 10M€ fatturato)</option>
                                    <option value="media">Media Impresa (< 250 dipendenti, ≤ 50M€ fatturato)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dati Legale Rappresentante -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-user-tie"></i> Legale Rappresentante</h4>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Nome</label>
                                <input type="text" class="form-control" id="lrNome" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Cognome</label>
                                <input type="text" class="form-control" id="lrCognome" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Codice Fiscale</label>
                                <input type="text" class="form-control" id="lrCF" maxlength="16" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Luogo di Nascita</label>
                                <input type="text" class="form-control" id="lrLuogoNascita" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Data di Nascita</label>
                                <input type="date" class="form-control" id="lrDataNascita" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label required">Residenza</label>
                                <input type="text" class="form-control" id="lrResidenza" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Verifica Ammissibilità -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-check-circle"></i> Verifica Requisiti di Ammissibilità</h4>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkDURC" required>
                            <label class="form-check-label" for="checkDURC">
                                <strong>DURC Regolare:</strong> L'impresa è in regola con il versamento dei contributi previdenziali e assistenziali
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkAntimafia" required>
                            <label class="form-check-label" for="checkAntimafia">
                                <strong>Antimafia:</strong> L'impresa non ha cause di decadenza, sospensione o divieto previste dall'art. 67 del D.Lgs 159/2011
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkRevoche" required>
                            <label class="form-check-label" for="checkRevoche">
                                <strong>Assenza Revoche:</strong> L'impresa non è destinataria di provvedimenti di revoca per indebita percezione nei 3 anni precedenti
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkProgettoDiverso" required>
                            <label class="form-check-label" for="checkProgettoDiverso">
                                <strong>Progetto Diverso:</strong> Il programma di investimento è diverso da quelli finanziati nell'ambito dell'Azione 1.1.2
                            </label>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <div></div>
                        <button class="btn btn-primary-custom" onclick="goToStep(2)">
                            Avanti <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- FASE 2: Dichiarazione MOL -->
                <div class="fase-container" id="fase2">
                    <h2 class="fase-title">FASE 2: Dichiarazione Sostitutiva MOL (Allegato B)</h2>
                    <p class="fase-subtitle">Calcolo del Margine Operativo Lordo e dell'Indicatore Ordinatore</p>
                    
                    <div class="alert-warning-custom">
                        <i class="fas fa-exclamation-triangle"></i> <strong>ATTENZIONE:</strong> Questa dichiarazione deve essere asseverata da un Commercialista iscritto all'Albo, da un Revisore Legale dei Conti o da un CAF.
                    </div>
                    
                    <!-- Dati di Riferimento -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-calendar-alt"></i> Periodo di Riferimento</h4>
                        
                        <div class="alert-info-custom">
                            <i class="fas fa-info-circle"></i> Utilizzare i dati dell'ultimo bilancio approvato e depositato presso il Registro delle Imprese (o ultima dichiarazione dei redditi per imprese individuali/società di persone).
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Anno di Riferimento Bilancio</label>
                                <input type="number" class="form-control" id="annoRiferimento" min="2020" max="2024" value="2023" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Tipo di Documento</label>
                                <select class="form-select" id="tipoDocumento" required>
                                    <option value="bilancio">Bilancio approvato e depositato</option>
                                    <option value="dichiarazione">Dichiarazione dei redditi</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calcolo MOL -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-calculator"></i> Dati Contabili per Calcolo MOL</h4>
                        
                        <div class="alert-info-custom">
                            <i class="fas fa-info-circle"></i> <strong>Formula MOL:</strong> Valore della Produzione - Materie Prime - Costi Servizi - Godimento Beni Terzi - Spese Personale - Variazioni Rimanenze - Oneri Diversi
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">A) Valore della Produzione €</label>
                                <input type="number" class="form-control" id="valoreProduzione" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">B) Materie prime, sussidiarie, di consumo e merci €</label>
                                <input type="number" class="form-control" id="materiePrime" step="0.01" min="0" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">C) Costi dei servizi €</label>
                                <input type="number" class="form-control" id="costiServizi" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">D) Costi godimento beni di terzi €</label>
                                <input type="number" class="form-control" id="costiBeniTerzi" step="0.01" min="0" required>
                                <small class="text-muted">Affitti, leasing, noleggi</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">E) Spese per il personale €</label>
                                <input type="number" class="form-control" id="spesePersonale" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">F) Variazioni rimanenze materie prime €</label>
                                <input type="number" class="form-control" id="variazioniRimanenze" step="0.01" value="0">
                                <small class="text-muted">Inserire senza segno algebrico</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">G) Oneri diversi di gestione €</label>
                                <input type="number" class="form-control" id="oneriDiversi" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ammortamenti €</label>
                                <input type="number" class="form-control" id="ammortamenti" step="0.01" min="0">
                                <small class="text-muted">Per informazione (non incluso nel calcolo MOL)</small>
                            </div>
                        </div>
                        
                        <!-- Risultato MOL -->
                        <div class="result-box mt-4">
                            <h4><i class="fas fa-calculator"></i> Margine Operativo Lordo (MOL) Calcolato</h4>
                            <div class="result-item">
                                <span class="result-label">MOL =</span>
                                <span class="result-value" id="molCalcolato" style="font-size: 1.8rem;">€ 0,00</span>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    Formula: (A) - (B) - (C) - (D) - (E) - (F) - (G) = <span id="formulaMOL">...</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Costo Progetto e Indicatore -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-euro-sign"></i> Costo del Progetto e Indicatore Ordinatore</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Costo Totale Ammissibile €</label>
                                <input type="number" class="form-control" id="costoTotale" step="0.01" min="20000" required>
                                <small class="text-muted">Minimo: €20.000 - Massimo: varia per dimensione</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Massimale per la tua dimensione €</label>
                                <input type="text" class="form-control" id="massimaleAmmissibile" readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contributo Richiesto (80%) €</label>
                                <input type="text" class="form-control" id="contributoRichiesto" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cofinanziamento (20%) €</label>
                                <input type="text" class="form-control" id="cofinanziamento" readonly>
                            </div>
                        </div>
                        
                        <!-- Indicatore Ordinatore -->
                        <div class="result-box mt-4" style="border-color: #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                            <h4 style="color: #155724;"><i class="fas fa-trophy"></i> INDICATORE ORDINATORE (Criterio di Graduatoria)</h4>
                            <div class="result-item">
                                <span class="result-label">MOL / Costo Investimento =</span>
                                <span class="result-value" id="indicatoreOrdinatore" style="font-size: 2rem; color: #155724;">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Posizionamento Stimato:</span>
                                <span class="result-value" id="posizionamentoStimato" style="color: #155724;">-</span>
                            </div>
                            <div class="mt-3 p-3" style="background: rgba(255,255,255,0.7); border-radius: 5px;">
                                <small><strong>Nota:</strong> Le domande sono ordinate per valore DECRESCENTE di questo indicatore. Più alto è meglio! L'ordine cronologico è usato solo in caso di parità.</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modalità di Erogazione -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-hand-holding-usd"></i> Modalità di Erogazione del Contributo</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Modalità di Erogazione</label>
                                <select class="form-select" id="modalitaErogazione" required>
                                    <option value="">Seleziona...</option>
                                    <option value="sal">Stati di Avanzamento Lavori (SAL)</option>
                                    <option value="saldo">A Saldo (solo se costo ≤ €100.000)</option>
                                </select>
                                <small class="text-muted" id="modalitaNote"></small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Richiesta Anticipo (40%)?</label>
                                <select class="form-select" id="richiestaAnticipo">
                                    <option value="no">No</option>
                                    <option value="si">Sì (richiede fideiussione bancaria)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Capacità Finanziaria -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-university"></i> Capacità Finanziaria (Allegato C)</h4>
                        
                        <div class="alert-info-custom">
                            <i class="fas fa-info-circle"></i> L'impresa deve dimostrare disponibilità finanziaria ≥ 30% del costo totale tramite attestazione bancaria.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Disponibilità Finanziaria Certificata €</label>
                                <input type="number" class="form-control" id="disponibilitaFinanziaria" step="0.01" min="0">
                                <small class="text-muted">Da attestazione bancaria</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Capacità Minima Richiesta (30%) €</label>
                                <input type="text" class="form-control" id="capacitaMinima" readonly>
                            </div>
                        </div>
                        
                        <div id="alertCapacita"></div>
                    </div>
                    
                    <!-- Professionista Asseverante -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-user-check"></i> Professionista Asseverante</h4>
                        
                        <div class="alert-danger-custom">
                            <i class="fas fa-exclamation-triangle"></i> <strong>OBBLIGATORIO:</strong> L'Allegato B deve essere asseverato da:
                            <ul class="mb-0 mt-2">
                                <li>Dottore Commercialista iscritto all'Albo, oppure</li>
                                <li>Revisore Legale dei Conti, oppure</li>
                                <li>Centro di Assistenza Fiscale (CAF)</li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Tipologia Professionista</label>
                                <select class="form-select" id="tipoProfessionista" required>
                                    <option value="">Seleziona...</option>
                                    <option value="commercialista">Dottore Commercialista</option>
                                    <option value="revisore">Revisore Legale dei Conti</option>
                                    <option value="caf">Centro di Assistenza Fiscale (CAF)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Nome e Cognome / Denominazione</label>
                                <input type="text" class="form-control" id="nomeProfessionista" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Codice Fiscale</label>
                                <input type="text" class="form-control" id="cfProfessionista" maxlength="16">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">N. Iscrizione Albo</label>
                                <input type="text" class="form-control" id="iscrizioneAlbo">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Sede</label>
                                <input type="text" class="form-control" id="sedeProfessionista">
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn btn-secondary-custom" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left"></i> Indietro
                        </button>
                        <button class="btn btn-primary-custom" onclick="goToStep(3)">
                            Avanti <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- FASE 3: Preventivi -->
                <div class="fase-container" id="fase3">
                    <h2 class="fase-title">FASE 3: Preventivi e Fornitori Qualificati</h2>
                    <p class="fase-subtitle">Gestione preventivi di spesa e verifica fornitori</p>
                    
                    <div class="alert-info-custom">
                        <i class="fas fa-info-circle"></i> <strong>Importante:</strong> Per le categorie di spesa a, b, c, d è obbligatorio utilizzare fornitori qualificati (DIH, Start-up innovative, Innovation Manager, etc.)
                    </div>
                    
                    <!-- Form Aggiunta Preventivo -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-file-invoice"></i> Aggiungi Preventivo</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Tipologia di Spesa</label>
                                <select class="form-select" id="tipologiaSpesa">
                                    <option value="">Seleziona...</option>
                                    <option value="lett_a">a) Consulenze specialistiche per diagnosi digitale</option>
                                    <option value="lett_b">b) Servizi di consulenza specialistica/innovazione (S3)</option>
                                    <option value="lett_c">c) Acquisizione tecnologie digitali di base</option>
                                    <option value="lett_d">d) Acquisizione tecnologie digitali evolute (S3)</option>
                                    <option value="lett_e">e) Acquisto software standard/attrezzature</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Descrizione Voce di Spesa</label>
                                <input type="text" class="form-control" id="descrizioneSpesa" placeholder="Es: Piattaforma e-commerce personalizzata">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Fornitore</label>
                                <input type="text" class="form-control" id="nomeFornitore" placeholder="Ragione sociale fornitore">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">P.IVA Fornitore</label>
                                <input type="text" class="form-control" id="pivaFornitore" maxlength="11">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Importo Preventivo €</label>
                                <input type="number" class="form-control" id="importoPreventivo" step="0.01" min="0" placeholder="0.00">
                                <small class="text-muted">Inserire l'importo in euro</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Data Preventivo</label>
                                <input type="date" class="form-control" id="dataPreventivo">
                                <small class="text-muted">Deve essere successiva alla pubblicazione del bando</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Fornitore Qualificato?</label>
                                <select class="form-select" id="fornitoreQualificato">
                                    <option value="">Seleziona...</option>
                                    <option value="dih">Digital Innovation Hub (DIH)</option>
                                    <option value="startup">Start-up innovativa</option>
                                    <option value="manager">Innovation Manager</option>
                                    <option value="consulente">Consulente qualificato</option>
                                    <option value="standard">No - Fornitore standard</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="aggiungiPreventivo()">
                            <i class="fas fa-plus"></i> Aggiungi Preventivo
                        </button>
                    </div>
                    
    <!-- Lista Preventivi -->
<div class="form-section">
    <h4 class="form-section-title"><i class="fas fa-list"></i> Preventivi Inseriti</h4>
    
    <div id="listaPreventivi">
        <div class="alert alert-secondary text-center">
            <i class="fas fa-inbox"></i> Nessun preventivo inserito. Aggiungi almeno un preventivo.
        </div>
    </div>
    
    <div class="result-box mt-3" id="totaliPreventivi" style="display: none;">
        <h4><i class="fas fa-calculator"></i> Riepilogo Spese</h4>
        <div id="riepilogoSpese"></div>
        <div class="result-item mt-3">
            <span class="result-label">TOTALE PREVENTIVI:</span>
            <span class="result-value" id="totalePreventivi">€ 0,00</span>
        </div>
    </div>
</div>

<!-- Modal Modifica Preventivo -->
<div class="modal fade" id="modalModificaPreventivo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Modifica Preventivo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPreventivoIndex">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Tipologia di Spesa</label>
                        <select class="form-select" id="editTipologiaSpesa">
                            <option value="lett_a">a) Consulenze specialistiche per diagnosi digitale</option>
                            <option value="lett_b">b) Servizi di consulenza specialistica/innovazione (S3)</option>
                            <option value="lett_c">c) Acquisizione tecnologie digitali di base</option>
                            <option value="lett_d">d) Acquisizione tecnologie digitali evolute (S3)</option>
                            <option value="lett_e">e) Acquisto software standard/attrezzature</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Descrizione Voce di Spesa</label>
                        <input type="text" class="form-control" id="editDescrizioneSpesa">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Fornitore</label>
                        <input type="text" class="form-control" id="editNomeFornitore">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">P.IVA Fornitore</label>
                        <input type="text" class="form-control" id="editPivaFornitore" maxlength="11">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label required">Importo Preventivo €</label>
                        <input type="number" class="form-control" id="editImportoPreventivo" step="0.01" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label required">Data Preventivo</label>
                        <input type="date" class="form-control" id="editDataPreventivo">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fornitore Qualificato?</label>
                        <select class="form-select" id="editFornitoreQualificato">
                            <option value="">Seleziona...</option>
                            <option value="dih">Digital Innovation Hub (DIH)</option>
                            <option value="startup">Start-up innovativa</option>
                            <option value="manager">Innovation Manager</option>
                            <option value="consulente">Consulente qualificato</option>
                            <option value="standard">No - Fornitore standard</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" onclick="salvaModificaPreventivo()">
                    <i class="fas fa-save"></i> Salva Modifiche
                </button>
            </div>
        </div>
    </div>
</div>
                    
                    <div class="navigation-buttons">
                        <button class="btn btn-secondary-custom" onclick="goToStep(2)">
                            <i class="fas fa-arrow-left"></i> Indietro
                        </button>
                        <button class="btn btn-primary-custom" onclick="goToStep(4)">
                            Avanti <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- FASE 4: Allegato 2.1 -->
                <div class="fase-container" id="fase4">
                    <h2 class="fase-title">FASE 4: Allegato 2.1 - Istanza di Finanziamento</h2>
                    <p class="fase-subtitle">Domanda di ammissione alle agevolazioni con dichiarazioni sostitutive</p>
                    
                    <div class="alert-danger-custom">
                        <i class="fas fa-exclamation-circle"></i> <strong>IMPORTANTE:</strong> Questo documento richiede:
                        <ul class="mb-0 mt-2">
                            <li>Firma digitale del Legale Rappresentante</li>
                            <li>Marca da bollo da €16,00</li>
                            <li>Allegazione bilanci ultimi 2 esercizi</li>
                        </ul>
                    </div>
                    
                    <!-- Riepilogo Dati Domanda -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-file-signature"></i> CHIEDE - Riepilogo Domanda</h4>
                        
                        <div class="card">
                            <div class="card-body">
                                <p><strong>Impresa:</strong> <span id="recap_ragioneSociale"></span></p>
                                <p><strong>Sede legale:</strong> <span id="recap_sedeLegale"></span></p>
                                <p><strong>P.IVA:</strong> <span id="recap_piva"></span> | <strong>C.F.:</strong> <span id="recap_cf"></span></p>
                                <p><strong>PEC:</strong> <span id="recap_pec"></span></p>
                                <hr>
                                <p class="mb-2"><strong>Progetto:</strong></p>
                                <input type="text" class="form-control mb-3" id="titoloProgettoIstanza" placeholder="Titolo del progetto di digitalizzazione">
                                <p><strong>Costo totale ammissibile:</strong> <span id="recap_costoTotale" class="text-primary fw-bold"></span></p>
                                <p><strong>Contributo richiesto (80%):</strong> <span id="recap_contributo" class="text-success fw-bold"></span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dichiarazioni -->
              <!-- Dichiarazioni -->
<div class="form-section">
    <h4 class="form-section-title"><i class="fas fa-file-contract"></i> DICHIARA (Requisiti di Ammissibilità)</h4>
    
    <div class="alert-warning-custom mb-3">
        <i class="fas fa-balance-scale"></i> Dichiarazioni sostitutive ai sensi dell'art. 47 del D.P.R. 445/2000. Consapevolezza responsabilità penali ex art. 76.
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichA" required>
        <div class="checklist-content">
            <div class="checklist-title">a) DURC Regolare</div>
            <div class="checklist-description">Di essere in regola con gli obblighi relativi al pagamento dei contributi previdenziali e assistenziali</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichB" required>
        <div class="checklist-content">
            <div class="checklist-title">b) Normativa Antimafia</div>
            <div class="checklist-description">Di non trovarsi in alcuna delle cause di decadenza, sospensione o divieto previste dall'art. 67 del D.Lgs 159/2011</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichC" required>
        <div class="checklist-content">
            <div class="checklist-title">c) Capacità Economico-Finanziaria</div>
            <div class="checklist-description">Di possedere la capacità economico-finanziaria documentata mediante Allegato C (attestazione bancaria)</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichD" required>
        <div class="checklist-content">
            <div class="checklist-title">d) Assenza Revoche</div>
            <div class="checklist-description">Di non essere destinatario di provvedimenti di revoca per indebita percezione nei 3 anni precedenti la data di presentazione</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichE" required>
        <div class="checklist-content">
            <div class="checklist-title">e) Progetto Diverso</div>
            <div class="checklist-description">Che il programma di investimento è diverso da quelli già finanziati nell'ambito dell'Azione 1.1.2</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichF" required>
        <div class="checklist-content">
            <div class="checklist-title">f) Veridicità Dati</div>
            <div class="checklist-description">Che i dati forniti nell'istanza e negli allegati corrispondono al vero</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichG" required>
        <div class="checklist-content">
            <div class="checklist-title">g) Rispetto Normativa Ambientale e Sicurezza</div>
            <div class="checklist-description">Di essere in regola con le norme in materia di tutela dell'ambiente, sicurezza e salute sui luoghi di lavoro</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichH" required>
        <div class="checklist-content">
            <div class="checklist-title">h) Assenza Cause Ostative</div>
            <div class="checklist-description">Di non trovarsi in alcuna delle condizioni ostative previste dall'art. 53 del D.Lgs. 165/2001 e ss.mm.ii.</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichI" required>
        <div class="checklist-content">
            <div class="checklist-title">i) Informativa Privacy</div>
            <div class="checklist-description">Di aver preso visione dell'informativa sul trattamento dei dati personali ai sensi del Reg. UE 679/2016 (GDPR)</div>
        </div>
    </div>
    
    <div class="checklist-item">
        <input type="checkbox" class="checklist-checkbox" id="dichL" required>
        <div class="checklist-content">
            <div class="checklist-title">l) Impegno Comunicazioni</div>
            <div class="checklist-description">Di impegnarsi a comunicare tempestivamente ogni variazione che dovesse intervenire</div>
        </div>
    </div>
</div>
                    
                    <!-- Dimensione Aziendale -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-chart-pie"></i> Dimensione Aziendale (Reg. CE 651/2014)</h4>
                        
                        <div class="alert-info-custom">
                            <i class="fas fa-info-circle"></i> Compilare tabella con dati dell'ultimo bilancio approvato
                        </div>
                        
                        <table class="table table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th>IMPRESE</th>
                                    <th>N. Occupati (ULA)</th>
                                    <th>Fatturato (milioni €)</th>
                                    <th>Totale Bilancio (milioni €)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Dichiarante</strong></td>
                                    <td><input type="number" class="form-control form-control-sm" id="ula_dichiarante" min="0" step="0.01"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="fatturato_dichiarante" min="0" step="0.01"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="bilancio_dichiarante" min="0" step="0.01"></td>
                                </tr>
                                <tr>
                                    <td>Associate</td>
                                    <td><input type="number" class="form-control form-control-sm" id="ula_associate" min="0" step="0.01" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="fatturato_associate" min="0" step="0.01" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="bilancio_associate" min="0" step="0.01" value="0"></td>
                                </tr>
                                <tr>
                                    <td>Collegate / Consolidato</td>
                                    <td><input type="number" class="form-control form-control-sm" id="ula_collegate" min="0" step="0.01" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="fatturato_collegate" min="0" step="0.01" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm" id="bilancio_collegate" min="0" step="0.01" value="0"></td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>TOTALE</strong></td>
                                    <td><strong><span id="ula_totale">0</span></strong></td>
                                    <td><strong><span id="fatturato_totale">0</span></strong></td>
                                    <td><strong><span id="bilancio_totale">0</span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <button class="btn btn-info" onclick="calcolaTotaliDimensione()">
                            <i class="fas fa-calculator"></i> Calcola Totali
                        </button>
                    </div>
                    
                    <!-- Classificazione Impresa -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-sitemap"></i> Classificazione Impresa</h4>
                        
                        <div class="mb-3">
                            <label class="form-label required">Tipo di Impresa</label>
                            <select class="form-select" id="tipoImpresa" required>
                                <option value="">Seleziona...</option>
                                <option value="autonoma">Impresa AUTONOMA</option>
                                <option value="associata">Impresa ASSOCIATA</option>
                                <option value="collegata">Impresa COLLEGATA</option>
                                <option value="grande">Grande Impresa (non PMI)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- De Minimis -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-balance-scale"></i> Regime De Minimis (Reg. UE 2023/2831)</h4>
                        
                        <div class="alert-warning-custom">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Limite massimo:</strong> €300.000 nell'esercizio in corso + 2 esercizi precedenti (impresa unica)
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">L'impresa ha già beneficiato di aiuti De Minimis?</label>
                            <select class="form-select" id="haDeMinimis" onchange="toggleDeMinimisTable()">
                                <option value="no">No</option>
                                <option value="si">Sì</option>
                            </select>
                        </div>
                        
                        <div id="deMinimisTable" style="display: none;">
                            <table class="table table-bordered">
                                <thead class="table-warning">
                                    <tr>
                                        <th>Ente Erogante</th>
                                        <th>Normativa</th>
                                        <th>Data Concessione</th>
                                        <th>Importo €</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="deMinimisRows">
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" placeholder="Es: Regione Siciliana"></td>
                                        <td><input type="text" class="form-control form-control-sm" placeholder="Es: Reg. UE 1407/2013"></td>
                                        <td><input type="date" class="form-control form-control-sm"></td>
                                        <td><input type="number" class="form-control form-control-sm" step="0.01"></td>
                                        <td><button class="btn btn-sm btn-danger" onclick="rimuoviRigaDeMinimis(this)"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="btn btn-sm btn-secondary" onclick="aggiungiRigaDeMinimis()">
                                <i class="fas fa-plus"></i> Aggiungi Aiuto De Minimis
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">L'impresa è stata interessata da fusioni/acquisizioni?</label>
                            <select class="form-select" id="fusioni">
                                <option value="no">No</option>
                                <option value="si">Sì</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Marca da Bollo -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-stamp"></i> Marca da Bollo</h4>
                        
                        <div class="alert-danger-custom">
                            <i class="fas fa-exclamation-circle"></i> <strong>OBBLIGATORIO:</strong> Marca da bollo da €16,00
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Numero Identificativo Marca da Bollo</label>
                                <input type="text" class="form-control" id="numeroMarcaBollo" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Data Marca da Bollo</label>
                                <input type="date" class="form-control" id="dataMarcaBollo" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn btn-secondary-custom" onclick="goToStep(3)">
                            <i class="fas fa-arrow-left"></i> Indietro
                        </button>
                        <button class="btn btn-primary-custom" onclick="goToStep(5)">
                            Avanti <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- FASE 5: Formulario F COMPLETO -->
<div class="fase-container" id="fase5">
    <h2 class="fase-title">FASE 5: Formulario Proposta Progettuale (Allegato F)</h2>
    <p class="fase-subtitle">Descrizione dettagliata del progetto secondo lo schema ufficiale</p>
    
    <div class="alert-info-custom">
        <i class="fas fa-info-circle"></i> Il Formulario è il documento chiave per la valutazione di merito. Compilare tutte le sezioni in modo accurato.
    </div>
    
    <!-- SEZIONE A: INFORMAZIONI GENERALI -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-info-circle"></i> A. INFORMAZIONI GENERALI</h4>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label required">A.1 Titolo progetto</label>
                <input type="text" class="form-control" id="titoloProgetto" readonly>
                <small class="text-muted">Sincronizzato dalla Fase 4 - Istanza di Finanziamento</small>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">A.2 Acronimo del progetto</label>
                <input type="text" class="form-control" id="acronimoProgetto">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label required">A.3 Durata (mesi)</label>
                <input type="number" class="form-control" id="durataProgetto" min="1" max="12" value="12">
                <small class="text-muted">Massimo 12 mesi</small>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">A.4 Costo totale ammissibile €</label>
                <input type="text" class="form-control" id="costoTotaleFormulario" readonly>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">A.5 Contributo richiesto €</label>
                <input type="text" class="form-control" id="contributoFormulario" readonly>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">A.6 Soggetto proponente</label>
                <input type="text" class="form-control" id="soggettoProponenteForm" readonly>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">A.7 Breve presentazione: mission e attività</label>
            <textarea class="form-control" id="missionAttivita" rows="3" placeholder="Descrivere brevemente mission e attività dell'impresa"></textarea>
        </div>
    </div>
    
    <!-- SEZIONE B: DESCRIZIONE SOGGETTO PROPONENTE -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-building"></i> B. DESCRIZIONE DEL SOGGETTO PROPONENTE</h4>
        
        <div class="mb-3">
            <label class="form-label required">B.1 Attività economica svolta e profili di innovazione</label>
            <textarea class="form-control" id="attivitaEconomica" rows="5" placeholder="Descrivere sinteticamente l'attività economica svolta e i principali profili di innovazione nei processi produttivi e/o di erogazione dei servizi"></textarea>
            <small class="text-muted"><span id="attivitaEconomicaCount">0</span> caratteri</small>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">B.2 Posizionamento competitivo</label>
            <textarea class="form-control" id="posizionamentoCompetitivo" rows="4" placeholder="Descrivere il posizionamento competitivo dell'impresa nel contesto geografico e settoriale di riferimento"></textarea>
            <small class="text-muted"><span id="posizionamentoCompetitivoCount">0</span> caratteri</small>
        </div>
    </div>
    
    <!-- SEZIONE C: FABBISOGNI DI INNOVAZIONE -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-lightbulb"></i> C. FABBISOGNI DI INNOVAZIONE IN RELAZIONE AI TREND SETTORIALI</h4>
        
        <div class="mb-3">
            <label class="form-label required">C.1 Contestualizzazione dei fabbisogni di innovazione</label>
            <textarea class="form-control" id="contestualizzazioneFabbisogni" rows="6" placeholder="- Analizzare lo stato dell'arte delle innovazioni tecnologiche nel settore&#10;- Descrivere gli specifici fabbisogni di innovazione connessi con l'ammodernamento digitale dei processi"></textarea>
            <small class="text-muted"><span id="contestualizzazioneFabbisogniCount">0</span> caratteri</small>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">C.2 Descrizione degli obiettivi perseguiti</label>
            <textarea class="form-control" id="obiettiviPerseguiti" rows="6" placeholder="- Descrivere gli impatti attesi dalla realizzazione degli interventi&#10;- Identificare le lacune o opportunità di mercato che il progetto intende affrontare"></textarea>
            <small class="text-muted"><span id="obiettiviPerseguitiCount">0</span> caratteri</small>
        </div>
    </div>
    
    <!-- SEZIONE D: CAPACITÀ AMMINISTRATIVA ED OPERATIVA -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-users"></i> D. CAPACITÀ AMMINISTRATIVA ED OPERATIVA</h4>
        
        <div class="mb-3">
            <label class="form-label required">D.1 Capacità amministrativa ed operativa</label>
            <textarea class="form-control" id="capacitaAmministrativa" rows="6" placeholder="- Track-record in attività affini&#10;- Strutture operative e attrezzature già disponibili"></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">D.2 Figure professionali chiave - Gruppo di lavoro</label>
            <textarea class="form-control" id="gruppoDiLavoro" rows="6" placeholder="- Personale amministrativo dedicato&#10;- Competenze professionali di ciascun componente&#10;- Organigramma delle figure professionali"></textarea>
        </div>
    </div>
    
    <!-- SEZIONE E: DESCRIZIONE PROGETTO E IMPLEMENTAZIONE -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-project-diagram"></i> E. DESCRIZIONE DEL PROGETTO E IMPLEMENTAZIONE SOLUZIONI DIGITALI</h4>
        
        <div class="mb-3">
            <label class="form-label required">E.1.i Obiettivi generali e specifici</label>
            <textarea class="form-control" id="obiettiviGeneraliSpecifici" rows="4" placeholder="Descrivere gli obiettivi generali (OG) e specifici (OS) del progetto"></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">E.1.ii Quadro logico (relazione obiettivi-azioni)</label>
            <textarea class="form-control" id="quadroLogico" rows="4" placeholder="Mettere in relazione obiettivi con le azioni/attività/task"></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">E.1.iii Descrizione dettagliata implementazione innovazioni</label>
            <textarea class="form-control" id="implementazioneInnovazioni" rows="6" placeholder="Descrivere il processo di implementazione con evidenza delle fasi principali e risultati attesi"></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label">E.1.iv Modalità di coinvolgimento utilizzatori finali</label>
            <textarea class="form-control" id="coinvolgimentoUtilizzatori" rows="4" placeholder="Descrivere le modalità/processi di coinvolgimento degli utilizzatori finali"></textarea>
        </div>
        
        <div class="mb-3">
            <button type="button" class="btn btn-success" onclick="compilaAutomaticaWP()">
                <i class="fas fa-magic"></i> Genera Automaticamente Piano di Lavoro e Cronoprogramma
            </button>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-info-circle"></i> Il sistema genererà automaticamente WP e cronoprogramma basandosi sui preventivi inseriti
            </small>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">E.1.v Piano di lavoro - Matrice WP</label>
            <textarea class="form-control" id="matriceWP" rows="10" placeholder="Compilare la matrice:&#10;OG | OS | WP | Azioni/Task | Deliverable | Output/Risultati | Budget | KPI&#10;&#10;Esempio:&#10;OG1: Digitalizzazione processi | OS1.1: Implementare ERP | WP1: Analisi e design | A1.1: Analisi requisiti | D1.1: Report analisi | R1.1: Requisiti definiti | €5.000 | KPI1: Requisiti completati"></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">E.1.v Cronoprogramma (M1-M12)</label>
            <textarea class="form-control" id="cronoprogramma" rows="8" placeholder="Indicare per ogni WP/Task i mesi di svolgimento e le milestone:&#10;&#10;WP1 - Task A1.1: M1-M2 | Milestone 1: Requisiti approvati&#10;WP2 - Task A2.1: M3-M6 | Milestone 2: Sistema installato&#10;WP3 - Task A3.1: M7-M10 | Milestone 3: Formazione completata&#10;WP4 - Task A4.1: M11-M12 | Milestone 4: Go-live"></textarea>
        </div>
    </div>
    
    <!-- SEZIONE F: MONITORAGGIO E KPI -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-chart-line"></i> F. GESTIONE DEL MONITORAGGIO, KPI E VALUTAZIONE</h4>
        
        <div class="mb-3">
            <label class="form-label required">F.1 Sistema di monitoraggio</label>
            <textarea class="form-control" id="sistemaMonitoraggio" rows="5" placeholder="- Struttura organizzativa responsabile&#10;- Processi di raccolta dati e reporting&#10;- Meccanismi di feedback per miglioramento continuo"></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label required">F.2 Valutazione impatto a lungo termine</label>
            <textarea class="form-control" id="valutazioneImpatto" rows="4" placeholder="- Approccio per valutare l'impatto oltre la durata del progetto&#10;- Piano per studi di follow-up e valutazioni ex-post"></textarea>
        </div>
    </div>
    
    <!-- Sezione G  -->
<div class="form-section">
    <h4 class="form-section-title"><i class="fas fa-award"></i> G. CRITERI PREMIALI</h4>
    
    <div class="mb-3">
        <label class="form-label">G.1 Ricadute occupazionali femminili e/o giovanili</label>
        <textarea class="form-control" id="ricaduteOccupazionali" rows="4" placeholder="Descrivere le ricadute occupazionali per donne e giovani (<36 anni) entro 3 anni dal completamento"></textarea>
    </div>
    
    <div class="mb-3">
        <label class="form-label">G.5 Contributo S3 - Quota investimento tecnologie abilitanti</label>
        <div class="alert-info-custom mb-2">
            <i class="fas fa-info-circle"></i> Inserire l'importo degli investimenti in tecnologie abilitanti S3 (lett. a e c). La percentuale verrà calcolata automaticamente sul costo totale del progetto.
        </div>
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Importo investimento tecnologie S3 €</label>
                <input type="number" class="form-control" id="quotaTecnologieAbilitanti" step="0.01" min="0" placeholder="0.00" onchange="calcolaPercentualeS3()" oninput="calcolaPercentualeS3()">
                <small class="text-muted">Somma preventivi lett. b) e d)</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">Percentuale sul totale investimento</label>
                <input type="text" class="form-control" id="percentualeTecnologieS3" readonly style="background-color: #f8f9fa; font-weight: bold; font-size: 1.1rem;">
                <small class="text-muted">Calcolato automaticamente</small>
            </div>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-info btn-sm" onclick="calcolaAutomaticoS3DaPreventivi()">
                <i class="fas fa-magic"></i> Calcola Automaticamente dai Preventivi
            </button>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-lightbulb"></i> Questo pulsante sommerà automaticamente tutti i preventivi di tipo lett. a) e lett. c) (tecnologie S3)
            </small>
        </div>
    </div>
</div>
    
   <!-- SEZIONE H: BUDGET E PIANO FINANZIARIO - COMPLETO -->
<div class="form-section">
    <h4 class="form-section-title"><i class="fas fa-euro-sign"></i> H. BUDGET E PIANO FINANZIARIO</h4>
    
    <div class="alert-info-custom">
        <i class="fas fa-info-circle"></i> <strong>H.1 Budget dettagliato:</strong> Generato automaticamente dai preventivi inseriti in Fase 3
    </div>
    
    <div id="budgetDettagliatoH1"></div>
    
    <div class="mb-4">
        <label class="form-label required">H.1 Giustificazione delle spese</label>
        <textarea class="form-control" id="giustificazioneSpese" rows="4" placeholder="Illustrare il prospetto analitico dei costi relativi ai servizi e attrezzature"></textarea>
    </div>
    
    <!-- H.2 PIANO DELLE COPERTURE FINANZIARIE -->
    <h5 class="mt-5 mb-3" style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 10px;">
        <i class="fas fa-coins"></i> H.2 Piano delle Coperture Finanziarie
    </h5>
    
    <div class="mb-3">
        <label class="form-label required">Dettaglio fonti di finanziamento</label>
        <textarea class="form-control" id="fontiFinanziamento" rows="3" placeholder="Dettagliare le fonti di finanziamento: contributo richiesto, cofinanziamenti e altre fonti"></textarea>
    </div>
    
    <div class="alert-warning-custom">
        <i class="fas fa-exclamation-triangle"></i> <strong>IMPORTANTE:</strong> Il totale delle FONTI deve essere uguale al totale degli IMPIEGHI
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered" id="tabellaH2">
            <thead class="table-primary">
                <tr>
                    <th style="width: 50%;">Prospetto "Impieghi/Fonti"</th>
                    <th style="width: 20%;">Anno 1 (€)</th>
                    <th style="width: 15%;">Totale (€)</th>
                    <th style="width: 15%;">% sul totale</th>
                </tr>
            </thead>
            <tbody>
                <!-- IMPIEGHI -->
                <tr class="table-secondary">
                    <td colspan="4"><strong>IMPIEGHI (fabbisogni finanziari)</strong></td>
                </tr>
                <tr>
                    <td>Programma di investimento</td>
                    <td colspan="3" class="table-light"><em>Dettaglio sotto:</em></td>
                </tr>
                <tr>
                    <td class="ps-4">• Investimenti immateriali</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_immat_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_immat_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_inv_immat_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td class="ps-4">• Investimenti materiali</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_mat_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_inv_mat_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_inv_mat_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td class="ps-4">• IVA sugli investimenti</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_iva_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_iva_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_iva_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr class="table-warning">
                    <td><strong>A - TOTALE PROGRAMMA DI INVESTIMENTO</strong></td>
                    <td><strong><span id="h2_tot_impieghi_anno1">€ 0,00</span></strong></td>
                    <td><strong><span id="h2_tot_impieghi_tot">€ 0,00</span></strong></td>
                    <td><strong>100%</strong></td>
                </tr>
                
                <!-- FONTI -->
                <tr class="table-secondary">
                    <td colspan="4"><strong>FONTI (coperture finanziarie)</strong></td>
                </tr>
                <tr>
                    <td>Contributo pubblico richiesto su Avviso</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_contributo_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_contributo_tot" readonly style="background-color: #f8f9fa;"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_contributo_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td><strong>Cofinanziamento proprio:</strong></td>
                    <td colspan="3" class="table-light"><em>Dettaglio sotto:</em></td>
                </tr>
                <tr>
                    <td class="ps-4">• Incremento Capitale Sociale/Fondo dotazione</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_cap_sociale_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_cap_sociale_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_cap_sociale_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td class="ps-4">• Finanziamento soci</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_soci_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_soci_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_soci_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td class="ps-4">• Utilizzo di riserve disponibili</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_riserve_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_riserve_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_riserve_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td class="ps-4">• Finanziamento a m/l termine</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_ml_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_ml_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_ml_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr>
                    <td class="ps-4">• Finanziamento a breve termine</td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_breve_anno1" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm" id="h2_finanz_breve_tot" step="0.01" min="0" onchange="calcolaH2()" placeholder="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm" id="h2_finanz_breve_perc" readonly style="background-color: #f8f9fa;"></td>
                </tr>
                <tr class="table-success">
                    <td><strong>TOTALE COPERTURE FINANZIARIE</strong></td>
                    <td><strong><span id="h2_tot_fonti_anno1">€ 0,00</span></strong></td>
                    <td><strong><span id="h2_tot_fonti_tot">€ 0,00</span></strong></td>
                    <td><strong><span id="h2_tot_fonti_perc">0%</span></strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Alert bilanciamento -->
    <div id="alertBilanciamentoH2"></div>
    
    <button class="btn btn-info mb-4" onclick="precompilaDatiH2()">
        <i class="fas fa-magic"></i> Pre-compila con dati del progetto
    </button>
    
    <!-- H.3 STRATEGIA DI SOSTENIBILITÀ ECONOMICO-FINANZIARIA -->
    <h5 class="mt-5 mb-3" style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 10px;">
        <i class="fas fa-chart-area"></i> H.3 Strategia di Sostenibilità Economico-Finanziaria
    </h5>
    
    <div class="mb-3">
        <label class="form-label required">Descrizione strategia di sostenibilità</label>
        <textarea class="form-control" id="strategiaSostenibilita" rows="4" placeholder="Descrivere la strategia per garantire la sostenibilità economico-finanziaria nel lungo termine"></textarea>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="tabellaH3">
            <thead class="table-info">
                <tr>
                    <th style="width: 25%;">Conto Economico</th>
                    <th style="width: 15%;">2023</th>
                    <th style="width: 15%;">2024</th>
                    <th style="width: 15%;">Anno n+1</th>
                    <th style="width: 15%;">Anno n+2</th>
                    <th style="width: 15%;">Anno n+3</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Fatturato/entrate</strong></td>
                    <td><input type="number" class="form-control form-control-sm h3-fatt" id="h3_fatt_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fatt" id="h3_fatt_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fatt" id="h3_fatt_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fatt" id="h3_fatt_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fatt" id="h3_fatt_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr>
                    <td>Altri ricavi/entrate</td>
                    <td><input type="number" class="form-control form-control-sm h3-altri" id="h3_altri_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-altri" id="h3_altri_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-altri" id="h3_altri_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-altri" id="h3_altri_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-altri" id="h3_altri_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr class="table-light">
                    <td><strong>Valore della produzione</strong></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_vp_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_vp_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_vp_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_vp_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_vp_n3" readonly></td>
                </tr>
                <tr>
                    <td>Consumo MP (acquisti +/- Var. rimanenze)</td>
                    <td><input type="number" class="form-control form-control-sm h3-mp" id="h3_mp_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-mp" id="h3_mp_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-mp" id="h3_mp_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-mp" id="h3_mp_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-mp" id="h3_mp_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr>
                    <td>Servizi</td>
                    <td><input type="number" class="form-control form-control-sm h3-serv" id="h3_serv_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-serv" id="h3_serv_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-serv" id="h3_serv_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-serv" id="h3_serv_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-serv" id="h3_serv_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr>
                    <td>Godimento beni di terzi</td>
                    <td><input type="number" class="form-control form-control-sm h3-god" id="h3_god_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-god" id="h3_god_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-god" id="h3_god_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-god" id="h3_god_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-god" id="h3_god_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr>
                    <td>Personale</td>
                    <td><input type="number" class="form-control form-control-sm h3-pers" id="h3_pers_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-pers" id="h3_pers_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-pers" id="h3_pers_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-pers" id="h3_pers_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-pers" id="h3_pers_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr class="table-success">
                    <td><strong>MOL</strong></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_mol_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_mol_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_mol_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_mol_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_mol_n3" readonly></td>
                </tr>
                <tr>
                    <td>Ammortamenti</td>
                    <td><input type="number" class="form-control form-control-sm h3-amm" id="h3_amm_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-amm" id="h3_amm_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-amm" id="h3_amm_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-amm" id="h3_amm_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-amm" id="h3_amm_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr class="table-light">
                    <td><strong>Risultato Operativo</strong></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_ro_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_ro_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_ro_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_ro_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_ro_n3" readonly></td>
                </tr>
                <tr>
                    <td>(+/-) Gestione Finanziaria</td>
                    <td><input type="number" class="form-control form-control-sm h3-fin" id="h3_fin_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fin" id="h3_fin_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fin" id="h3_fin_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fin" id="h3_fin_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-fin" id="h3_fin_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr>
                    <td>(+/-) Gestione Straordinaria</td>
                    <td><input type="number" class="form-control form-control-sm h3-straord" id="h3_straord_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-straord" id="h3_straord_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-straord" id="h3_straord_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-straord" id="h3_straord_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-straord" id="h3_straord_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr class="table-light">
                    <td><strong>Risultato lordo</strong></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_rl_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_rl_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_rl_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_rl_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h3_rl_n3" readonly></td>
                </tr>
                <tr>
                    <td>Imposte e tasse (-)</td>
                    <td><input type="number" class="form-control form-control-sm h3-imp" id="h3_imp_2023" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-imp" id="h3_imp_2024" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-imp" id="h3_imp_n1" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-imp" id="h3_imp_n2" step="0.01" onchange="calcolaH3()"></td>
                    <td><input type="number" class="form-control form-control-sm h3-imp" id="h3_imp_n3" step="0.01" onchange="calcolaH3()"></td>
                </tr>
                <tr class="table-warning">
                    <td><strong>Risultato netto</strong></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_rn_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_rn_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_rn_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_rn_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold" id="h3_rn_n3" readonly></td>
                </tr>
<tr class="table-info">
    <td><strong>Totale Attivo (Cap. Investito)</strong></td>
    <td><input type="number" class="form-control form-control-sm h3-attivo" id="h3_attivo_2023" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
    <td><input type="number" class="form-control form-control-sm h3-attivo" id="h3_attivo_2024" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
    <td><input type="number" class="form-control form-control-sm h3-attivo" id="h3_attivo_n1" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
    <td><input type="number" class="form-control form-control-sm h3-attivo" id="h3_attivo_n2" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
    <td><input type="number" class="form-control form-control-sm h3-attivo" id="h3_attivo_n3" step="0.01" onchange="calcolaH3()" placeholder="0.00"></td>
</tr>
            </tbody>
        </table>
    </div>
    
    <div class="d-flex gap-2 mb-4">
        <button class="btn btn-primary" onclick="proiettaEserciziPrevisionali()">
            <i class="fas fa-magic"></i> Proietta Automaticamente n+1, n+2, n+3
        </button>
    </div>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i> <strong>Proiezione Automatica:</strong>
        <ul class="mb-0 mt-2">
            <li>Analizza i dati storici 2023-2024</li>
            <li>Calcola tassi di crescita</li>
            <li>Aggiunge impatto digitalizzazione (aumento ricavi + riduzione costi)</li>
            <li>Include ammortamento investimento progetto</li>
            <li>Proietta 3 anni futuri con effetti crescenti</li>
        </ul>
    </div>
    
  <!-- H.4 ANALISI PER INDICI -->
<h5 class="mt-5 mb-3" style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 10px;">
    <i class="fas fa-chart-line"></i> H.4 Analisi per Indici
</h5>

<div class="alert-info-custom">
    <i class="fas fa-magic"></i> Gli indici vengono calcolati automaticamente dai dati inseriti in H.3
    <br>
    <strong>Nota:</strong> Il ROI è calcolato come Risultato Operativo (EBIT) / Totale Attivo (Capitale Investito)
    <br>
    <small>Inserire il Totale Attivo nella tabella H.3 per ogni anno di riferimento</small>
</div>
    
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-primary">
                <tr>
                    <th style="width: 30%;">Indicatore</th>
                    <th>2023</th>
                    <th>2024</th>
                    <th>Anno n+1</th>
                    <th>Anno n+2</th>
                    <th>Anno n+3</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>ROI</strong></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_roi_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_roi_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_roi_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_roi_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_roi_n3" readonly></td>
                </tr>
                <tr>
                    <td><strong>Margine di contribuzione % (MOL/ricavi)</strong></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_marg_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_marg_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_marg_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_marg_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_marg_n3" readonly></td>
                </tr>
                <tr>
                    <td><strong>Rapporto Risultato netto / Contributo pubblico</strong></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_rapp_2023" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_rapp_2024" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_rapp_n1" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_rapp_n2" readonly></td>
                    <td><input type="text" class="form-control form-control-sm" id="h4_rapp_n3" readonly></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <h5 class="mt-4">H.5 Analisi costi-benefici</h5>
    <div class="mb-3">
        <textarea class="form-control" id="h5_costibenefici" rows="5" placeholder="Fornire un'analisi dettagliata dei costi e benefici attesi"></textarea>
    </div>
    
    <h5 class="mt-4">H.6 Piano occupazionale (entro 3 anni dal completamento)</h5>
    <table class="table table-bordered">
        <thead class="table-warning">
            <tr>
                <th>Qualifica</th>
                <th>ULA 2024</th>
                <th>ULA previste</th>
                <th>Variazione</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Dirigenti</td>
                <td><input type="number" class="form-control form-control-sm" id="h6_dir_2024" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="number" class="form-control form-control-sm" id="h6_dir_prev" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="text" class="form-control form-control-sm" id="h6_dir_var" readonly></td>
            </tr>
            <tr>
                <td>Quadri</td>
                <td><input type="number" class="form-control form-control-sm" id="h6_quad_2024" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="number" class="form-control form-control-sm" id="h6_quad_prev" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="text" class="form-control form-control-sm" id="h6_quad_var" readonly></td>
            </tr>
            <tr>
                <td>Impiegati</td>
                <td><input type="number" class="form-control form-control-sm" id="h6_imp_2024" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="number" class="form-control form-control-sm" id="h6_imp_prev" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="text" class="form-control form-control-sm" id="h6_imp_var" readonly></td>
            </tr>
            <tr>
                <td>Operai</td>
                <td><input type="number" class="form-control form-control-sm" id="h6_op_2024" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="number" class="form-control form-control-sm" id="h6_op_prev" step="0.01" onchange="calcolaVariazioniH6()"></td>
                <td><input type="text" class="form-control form-control-sm" id="h6_op_var" readonly></td>
            </tr>
        </tbody>
    </table>
    
    <h5 class="mt-4">H.7 Piano di gestione dei rischi finanziari</h5>
    <div class="mb-3">
        <textarea class="form-control" id="h7_rischi" rows="4" placeholder="Identificare i principali rischi finanziari e strategie di mitigazione"></textarea>
    </div>
    
    <h5 class="mt-4">H.8 Strategia di ottimizzazione dei costi</h5>
    <div class="mb-3">
        <textarea class="form-control" id="h8_ottimizzazione" rows="4" placeholder="Strategie per ottimizzare i costi operativi"></textarea>
    </div>
</div>
    
    <!-- SEZIONE I: ALLEGATI -->
    <div class="form-section">
        <h4 class="form-section-title"><i class="fas fa-paperclip"></i> I. ALLEGATI</h4>
        
        <div class="alert-info-custom">
            <strong>Documentazione da allegare:</strong>
            <ul class="mb-0 mt-2">
                <li>CV dei principali membri del Gruppo di Lavoro</li>
                <li>Documentazione probatoria per criteri di valutazione e premialità</li>
                <li>Documentazione tecnica aggiuntiva</li>
                <li>Altri documenti rilevanti</li>
            </ul>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Note sugli allegati previsti</label>
            <textarea class="form-control" id="noteAllegati" rows="3" placeholder="Elencare gli allegati che verranno inclusi nella domanda"></textarea>
        </div>
    </div>
    
    <div class="navigation-buttons">
        <button class="btn btn-secondary-custom" onclick="goToStep(4)">
            <i class="fas fa-arrow-left"></i> Indietro
        </button>
        <button class="btn btn-primary-custom" onclick="goToStep(6)">
            Avanti <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>
                
                <!-- FASE 6: Checklist e Export -->
                <div class="fase-container" id="fase6">
                    <h2 class="fase-title">FASE 6: Checklist Documentale e Finalizzazione</h2>
                    <p class="fase-subtitle">Verifica completezza documenti e preparazione per l'invio</p>
                    
                    <!-- Summary -->
                    <div class="summary-section">
                        <h3><i class="fas fa-check-circle"></i> Riepilogo Finale</h3>
                        <div class="summary-grid" id="summaryGrid"></div>
                    </div>
                    
                    <!-- Checklist Documenti -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-clipboard-list"></i> Checklist Documenti Obbligatori</h4>
                        
                        <div class="alert-danger-custom mb-4">
                            <i class="fas fa-exclamation-circle"></i> <strong>CRITICO:</strong> La mancanza di anche un solo documento comporta l'IRRICEVIBILITÀ della domanda!
                        </div>
                        
                        <div id="checklistDocumenti"></div>
                    </div>
                    
                    <!-- Export -->
                    <div class="form-section">
                        <h4 class="form-section-title"><i class="fas fa-download"></i> Esporta Dati</h4>
                        
                        <p>Esporta tutti i dati inseriti per conservazione e compilazione dei documenti ufficiali:</p>
                        
                                                  
                            <div class="export-btn" onclick="esportaPDF()">
                                <i class="fas fa-file-pdf"></i>
                                <h5>PDF Riepilogativo</h5>
                                <p>Report completo</p>
                            </div>
                            
                            <div class="export-btn" onclick="esportaExcel()">
                                <i class="fas fa-file-excel"></i>
                                <h5>Excel</h5>
                                <p>Budget e preventivi</p>
                            </div>
                            
                            <div class="export-btn" onclick="stampaIstanza()">
                                <i class="fas fa-print"></i>
                                <h5>Stampa Istanza</h5>
                                <p>Allegato 2.1</p>
                            </div>
                        </div>
                    <div class="navigation-buttons">
    <button class="btn btn-secondary-custom" onclick="goToStep(5)">
        <i class="fas fa-arrow-left"></i> Indietro
    </button>
    <button class="btn btn-success btn-lg" onclick="salvaEFinalizza()">
        <i class="fas fa-save"></i> Salva e Genera Documenti
    </button>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ============================================
        // CONFIGURAZIONE GLOBALE
        // ============================================
        
        const config = {
            limiti: {
                micro: 60000,
                piccola: 100000,
                media: 150000
            },
            percentualeContributo: 0.80,
            minimoInvestimento: 20000,
            limiteDeMinimis: 300000,
            capacitaFinanziariaMinima: 0.30,
            dataPubblicazioneBando: '2025-08-05'
        };
        
        // Storage dati
        let datiDomanda = {
            impresa: {},
            legaleRappresentante: {},
            economia: {},
            preventivi: [],
            formulario: {},
            checklist: []
        };
        
        let currentStep = 1;
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatEuro(value) {
            if (!value && value !== 0) return '€ 0,00';
            const num = parseFloat(value) || 0;
            return '€ ' + num.toLocaleString('it-IT', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }
        
        function getValoreNumerico(elementId) {
            const elemento = document.getElementById(elementId);
            if (!elemento) return 0;
            return parseFloat(elemento.value) || 0;
        }
        
        // ============================================
        // INIZIALIZZAZIONE APP
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ App inizializzata');
            inizializzaApp();
            aggiungiEventListeners();
            caricaDatiSalvati();
        });
        
        function inizializzaApp() {
            // Character counters
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const countId = this.id + 'Count';
                    const counter = document.getElementById(countId);
                    if (counter) {
                        counter.textContent = this.value.length;
                    }
                });
            });
            
            // Auto-save ogni 30 secondi
            setInterval(salvaAutomaticamente, 30000);
        }
        
        function aggiungiEventListeners() {
            // Eventi calcolo MOL
            ['valoreProduzione', 'materiePrime', 'costiServizi', 'costiBeniTerzi', 
             'spesePersonale', 'variazioniRimanenze', 'oneriDiversi'].forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', calcolaMOLAutomatico);
                }
            });
            
            // Eventi calcolo progetto
            const costoTotale = document.getElementById('costoTotale');
            if (costoTotale) {
                costoTotale.addEventListener('input', aggiornaCalcoliProgetto);
            }
            
            const dimensione = document.getElementById('dimensioneImpresa');
            if (dimensione) {
                dimensione.addEventListener('change', function() {
                    aggiornaMassimale();
                    verificaLimitiSpesa();
                });
            }
            
            // Validazione anno costituzione
            const annoCostituzione = document.getElementById('annoCostituzione');
            if (annoCostituzione) {
                annoCostituzione.addEventListener('input', function() {
                    const annoCorrente = new Date().getFullYear();
                    const anno = parseInt(this.value);
                    
                    if (anno && (annoCorrente - anno < 1)) {
                        alert('⚠️ L\'impresa deve essere costituita e attiva da almeno 1 anno!');
                        this.value = '';
                    }
                });
            }
            
            // Disponibilità finanziaria
            const disponibilita = document.getElementById('disponibilitaFinanziaria');
            if (disponibilita) {
                disponibilita.addEventListener('input', verificaCapacitaFinanziaria);
            }
        }
        
        // ============================================
        // FASE 2: CALCOLI MOL E INDICATORE
        // ============================================
        
        function calcolaMOLAutomatico() {
            const valoreProduzione = getValoreNumerico('valoreProduzione');
            const materiePrime = getValoreNumerico('materiePrime');
            const costiServizi = getValoreNumerico('costiServizi');
            const costiBeniTerzi = getValoreNumerico('costiBeniTerzi');
            const spesePersonale = getValoreNumerico('spesePersonale');
            const variazioniRimanenze = getValoreNumerico('variazioniRimanenze');
            const oneriDiversi = getValoreNumerico('oneriDiversi');
            
            // Calcola MOL
            const mol = valoreProduzione - materiePrime - costiServizi - costiBeniTerzi 
                       - spesePersonale - variazioniRimanenze - oneriDiversi;
            
            // Mostra risultato
            document.getElementById('molCalcolato').textContent = formatEuro(mol);
            document.getElementById('formulaMOL').textContent = 
                `${formatEuro(valoreProduzione)} - ${formatEuro(materiePrime)} - ${formatEuro(costiServizi)} - ${formatEuro(costiBeniTerzi)} - ${formatEuro(spesePersonale)} - ${formatEuro(variazioniRimanenze)} - ${formatEuro(oneriDiversi)}`;
            
            // Salva MOL
            datiDomanda.economia.mol = mol;
            datiDomanda.economia.componentiMOL = {
                valoreProduzione,
                materiePrime,
                costiServizi,
                costiBeniTerzi,
                spesePersonale,
                variazioniRimanenze,
                oneriDiversi
            };
            
            // Ricalcola indicatore se c'è il costo totale
            if (document.getElementById('costoTotale').value) {
                calcolaIndicatoreOrdinatore();
            }
            
            salvaLocalmente();
        }
        
        function aggiornaCalcoliProgetto() {
            aggiornaMassimale();
            aggiornaContributoRichiesto();
            aggiornaModalitaErogazione();
            aggiornaCapacitaMinima();
            calcolaIndicatoreOrdinatore();
            verificaLimitiSpesa();
        }
        
        function aggiornaMassimale() {
            const dimensione = document.getElementById('dimensioneImpresa').value;
            const massimaleElement = document.getElementById('massimaleAmmissibile');
            
            if (dimensione && massimaleElement) {
                const massimale = config.limiti[dimensione];
                massimaleElement.value = formatEuro(massimale);
            }
        }
        
        function aggiornaContributoRichiesto() {
            const costoTotale = getValoreNumerico('costoTotale');
            const contributo = costoTotale * config.percentualeContributo;
            const cofinanziamento = costoTotale - contributo;
            
            document.getElementById('contributoRichiesto').value = formatEuro(contributo);
            document.getElementById('cofinanziamento').value = formatEuro(cofinanziamento);
        }
        
        function aggiornaModalitaErogazione() {
            const costoTotale = getValoreNumerico('costoTotale');
            const modalitaSelect = document.getElementById('modalitaErogazione');
            const note = document.getElementById('modalitaNote');
            
            if (!modalitaSelect || !note) return;
            
            if (costoTotale > 100000) {
                const optionSaldo = modalitaSelect.querySelector('option[value="saldo"]');
                if (optionSaldo) {
                    optionSaldo.disabled = true;
                    if (modalitaSelect.value === 'saldo') {
                        modalitaSelect.value = 'sal';
                    }
                }
                note.textContent = '⚠️ Con costo > €100.000 è obbligatoria l\'erogazione a SAL';
                note.style.color = 'red';
            } else {
                const optionSaldo = modalitaSelect.querySelector('option[value="saldo"]');
                if (optionSaldo) {
                    optionSaldo.disabled = false;
                }
                note.textContent = '✓ Entrambe le modalità disponibili';
                note.style.color = 'green';
            }
        }
        
        function aggiornaCapacitaMinima() {
            const costoTotale = getValoreNumerico('costoTotale');
            const capacitaMinima = costoTotale * config.capacitaFinanziariaMinima;
            
            const element = document.getElementById('capacitaMinima');
            if (element) {
                element.value = formatEuro(capacitaMinima);
            }
        }
        
        function calcolaIndicatoreOrdinatore() {
            const mol = datiDomanda.economia?.mol || 0;
            const costoTotale = getValoreNumerico('costoTotale');
            const dimensione = document.getElementById('dimensioneImpresa').value;
            
            if (mol <= 0 || costoTotale <= 0) {
                document.getElementById('indicatoreOrdinatore').textContent = '-';
                document.getElementById('posizionamentoStimato').textContent = '-';
                return;
            }
            
            // Verifica limiti
            const massimale = config.limiti[dimensione] || 0;
            const dentroLimiti = costoTotale <= massimale;
            
            const indicatore = (mol / costoTotale).toFixed(4);
            
            // Stima posizionamento
            let posizionamento = '';
            let colore = '';
            if (indicatore > 0.5) {
                posizionamento = 'ECCELLENTE (Top 10%)';
                colore = '#155724';
            } else if (indicatore > 0.3) {
                posizionamento = 'OTTIMO (Top 30%)';
                colore = '#28a745';
            } else if (indicatore > 0.15) {
                posizionamento = 'BUONO (Top 50%)';
                colore = '#ffc107';
            } else if (indicatore > 0.05) {
                posizionamento = 'MEDIO';
                colore = '#fd7e14';
            } else {
                posizionamento = 'BASSO - RISCHIO';
                colore = '#dc3545';
            }
            
            document.getElementById('indicatoreOrdinatore').textContent = indicatore;
            document.getElementById('indicatoreOrdinatore').style.color = colore;
            document.getElementById('posizionamentoStimato').textContent = posizionamento;
            document.getElementById('posizionamentoStimato').style.color = colore;
            
            // SALVA
            datiDomanda.economia = {
                ...datiDomanda.economia,
                mol: mol,
                costoTotale: costoTotale,
                indicatoreOrdinatore: indicatore,
                posizionamento: posizionamento,
                dentroLimiti: dentroLimiti,
                massimale: massimale,
                contributoRichiesto: costoTotale * config.percentualeContributo
            };
            
            salvaLocalmente();
        }
        
        function verificaLimitiSpesa() {
            const dimensione = document.getElementById('dimensioneImpresa').value;
            const costoTotale = getValoreNumerico('costoTotale');
            
            if (!dimensione || costoTotale === 0) return;
            
            const massimale = config.limiti[dimensione];
            const dentroLimiti = costoTotale <= massimale;
            
            datiDomanda.economia.dentroLimiti = dentroLimiti;
            datiDomanda.economia.massimale = massimale;
            
            salvaLocalmente();
        }
        
        function verificaCapacitaFinanziaria() {
            const disponibilita = getValoreNumerico('disponibilitaFinanziaria');
            const capacitaMinimaStr = document.getElementById('capacitaMinima').value;
            const capacitaMinima = parseFloat(capacitaMinimaStr.replace(/[€\s.]/g, '').replace(',', '.')) || 0;
            
            const alertDiv = document.getElementById('alertCapacita');
            if (!alertDiv) return;
            
            if (disponibilita >= capacitaMinima) {
                alertDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <strong>CAPACITÀ FINANZIARIA SUFFICIENTE</strong><br>
                        Disponibilità: ${formatEuro(disponibilita)} ≥ Minimo richiesto: ${formatEuro(capacitaMinima)}
                    </div>
                `;
            } else {
                alertDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> <strong>CAPACITÀ FINANZIARIA INSUFFICIENTE</strong><br>
                        Disponibilità: ${formatEuro(disponibilita)} < Minimo richiesto: ${formatEuro(capacitaMinima)}<br>
                        Mancano: ${formatEuro(capacitaMinima - disponibilita)}
                    </div>
                `;
            }
        }
        
        // ============================================
        // FASE 3: GESTIONE PREVENTIVI
        // ============================================
        
        function aggiungiPreventivo() {
            const tipologia = document.getElementById('tipologiaSpesa').value;
            const descrizione = document.getElementById('descrizioneSpesa').value;
            const fornitore = document.getElementById('nomeFornitore').value;
            const piva = document.getElementById('pivaFornitore').value;
            const importo = getValoreNumerico('importoPreventivo');
            const data = document.getElementById('dataPreventivo').value;
            const qualificato = document.getElementById('fornitoreQualificato').value;
            
            // Validazioni
            if (!tipologia || !descrizione || !fornitore || !importo || !data) {
                alert('⚠️ Compilare tutti i campi obbligatori!');
                return;
            }
            
            if (importo <= 0) {
                alert('⚠️ L\'importo deve essere maggiore di zero!');
                document.getElementById('importoPreventivo').focus();
                return;
            }
            
            // Validazione data preventivo
            const dataPreventivo = new Date(data);
            const dataPubblicazione = new Date(config.dataPubblicazioneBando);
            
            if (dataPreventivo < dataPubblicazione) {
                alert(
                    '⚠️ DATA PREVENTIVO NON VALIDA!\n\n' +
                    'La data del preventivo deve essere successiva alla pubblicazione del bando.\n\n' +
                    'Data pubblicazione bando: ' + formatDate(config.dataPubblicazioneBando) + '\n' +
                    'Data preventivo inserita: ' + formatDate(data) + '\n\n' +
                    'Modificare la data del preventivo.'
                );
                document.getElementById('dataPreventivo').focus();
                return;
            }
            
            // Verifica fornitore qualificato
            const richiedeQualificato = ['lett_a', 'lett_b', 'lett_c', 'lett_d'].includes(tipologia);
            if (richiedeQualificato && (!qualificato || qualificato === 'standard')) {
                if (!confirm('⚠️ ATTENZIONE: Per questa tipologia di spesa è obbligatorio un fornitore qualificato.\n\nContinuare comunque?')) {
                    return;
                }
            }
            
            // Aggiungi preventivo
            const preventivo = {
                id: Date.now(),
                tipologia: tipologia,
                descrizione: descrizione,
                fornitore: fornitore,
                piva: piva,
                importo: importo,
                data: data,
                qualificato: qualificato,
                richiedeQualificato: richiedeQualificato
            };
            
            datiDomanda.preventivi.push(preventivo);
            
            // Reset form
            document.getElementById('tipologiaSpesa').value = '';
            document.getElementById('descrizioneSpesa').value = '';
            document.getElementById('nomeFornitore').value = '';
            document.getElementById('pivaFornitore').value = '';
            document.getElementById('importoPreventivo').value = '';
            document.getElementById('dataPreventivo').value = '';
            document.getElementById('fornitoreQualificato').value = '';
            
            // Aggiorna visualizzazione
            mostraPreventivi();
            salvaLocalmente();
            
            alert('✅ Preventivo aggiunto con successo!');
        }
        
function mostraPreventivi() {
    const container = document.getElementById('listaPreventivi');
    
    if (datiDomanda.preventivi.length === 0) {
        container.innerHTML = `
            <div class="alert alert-secondary text-center">
                <i class="fas fa-inbox"></i> Nessun preventivo inserito. Aggiungi almeno un preventivo.
            </div>
        `;
        document.getElementById('totaliPreventivi').style.display = 'none';
        return;
    }
    
    const tipologieNomi = {
        'lett_a': 'Consulenza per dignosi digitale',
        'lett_b': 'Consulenza specialistica (S3)',
        'lett_c': 'Tecnologie digitali base',
        'lett_d': 'Tecnologie evolute (S3)',
        'lett_e': 'Software standard/attrezzature'
    };
    
    const qualificatiNomi = {
        'dih': 'Digital Innovation Hub',
        'startup': 'Start-up innovativa',
        'manager': 'Innovation Manager',
        'consulente': 'Consulente qualificato',
        'standard': 'Fornitore standard'
    };
    
    let html = '';
    let totale = 0;
    let totaliPerTipologia = {};
    
    datiDomanda.preventivi.forEach((prev, index) => {
        totale += prev.importo;
        totaliPerTipologia[prev.tipologia] = (totaliPerTipologia[prev.tipologia] || 0) + prev.importo;
        
        const badgeQualificato = prev.richiedeQualificato && prev.qualificato !== 'standard'
            ? `<span class="badge-qualificato"><i class="fas fa-check"></i> ${qualificatiNomi[prev.qualificato]}</span>`
            : `<span class="badge-standard">Standard</span>`;
        
        html += `
            <div class="preventivo-item">
                <div class="preventivo-header">
                    <span class="preventivo-tipologia">${tipologieNomi[prev.tipologia]}</span>
                    ${badgeQualificato}
                </div>
                <div class="mb-2"><strong>${prev.descrizione}</strong></div>
                <div class="row">
                    <div class="col-md-4"><small>Fornitore:</small> ${prev.fornitore}</div>
                    <div class="col-md-2"><small>Data:</small> ${formatDate(prev.data)}</div>
                    <div class="col-md-2"><strong>${formatEuro(prev.importo)}</strong></div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-info me-2" onclick="modificaPreventivo(${index})" title="Modifica">
                            <i class="fas fa-edit"></i> Modifica
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rimuoviPreventivo(${index})" title="Elimina">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Mostra totali
    let riepilogoHtml = '';
    Object.keys(totaliPerTipologia).forEach(tip => {
        riepilogoHtml += `
            <div class="result-item">
                <span class="result-label">${tipologieNomi[tip]}:</span>
                <span class="result-value">${formatEuro(totaliPerTipologia[tip])}</span>
            </div>
        `;
    });
    
    document.getElementById('riepilogoSpese').innerHTML = riepilogoHtml;
    document.getElementById('totalePreventivi').textContent = formatEuro(totale);
    document.getElementById('totaliPreventivi').style.display = 'block';
}

function modificaPreventivo(index) {
    const prev = datiDomanda.preventivi[index];
    
    document.getElementById('editPreventivoIndex').value = index;
    document.getElementById('editTipologiaSpesa').value = prev.tipologia;
    document.getElementById('editDescrizioneSpesa').value = prev.descrizione;
    document.getElementById('editNomeFornitore').value = prev.fornitore;
    document.getElementById('editPivaFornitore').value = prev.piva;
    document.getElementById('editImportoPreventivo').value = prev.importo;
    document.getElementById('editDataPreventivo').value = prev.data;
    document.getElementById('editFornitoreQualificato').value = prev.qualificato;
    
    const modal = new bootstrap.Modal(document.getElementById('modalModificaPreventivo'));
    modal.show();
}

function salvaModificaPreventivo() {
    const index = parseInt(document.getElementById('editPreventivoIndex').value);
    const tipologia = document.getElementById('editTipologiaSpesa').value;
    const descrizione = document.getElementById('editDescrizioneSpesa').value;
    const fornitore = document.getElementById('editNomeFornitore').value;
    const piva = document.getElementById('editPivaFornitore').value;
    const importo = parseFloat(document.getElementById('editImportoPreventivo').value);
    const data = document.getElementById('editDataPreventivo').value;
    const qualificato = document.getElementById('editFornitoreQualificato').value;
    
    if (!tipologia || !descrizione || !fornitore || !importo || !data) {
        alert('⚠️ Compilare tutti i campi obbligatori!');
        return;
    }
    
    const richiedeQualificato = ['lett_a', 'lett_b', 'lett_c', 'lett_d'].includes(tipologia);
    
    datiDomanda.preventivi[index] = {
        ...datiDomanda.preventivi[index],
        tipologia,
        descrizione,
        fornitore,
        piva,
        importo,
        data,
        qualificato,
        richiedeQualificato
    };
    
    mostraPreventivi();
    salvaLocalmente();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalModificaPreventivo'));
    modal.hide();
    
    alert('✅ Preventivo modificato con successo!');
}

window.modificaPreventivo = modificaPreventivo;
window.salvaModificaPreventivo = salvaModificaPreventivo;
        
        // ============================================
        // NAVIGAZIONE TRA FASI
        // ============================================
        
        function goToStep(step) {
            console.log(`🚀 Navigazione verso step ${step}`);
            
            // Validazione fase corrente
            if (step > currentStep) {
                if (!validaFaseCorrente()) {
                    return;
                }
            }
            
            // Salva dati fase corrente
            salvaDatiFase(currentStep);
            
            // Nascondi tutte le fasi
            document.querySelectorAll('.fase-container').forEach(fase => {
                fase.classList.remove('active');
            });
            
            // Mostra fase richiesta
            const faseElement = document.getElementById(`fase${step}`);
            if (faseElement) {
                faseElement.classList.add('active');
            }
            
            // Aggiorna indicatore progresso
            document.querySelectorAll('.step-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    item.classList.add('completed');
                } else if (index + 1 === step) {
                    item.classList.add('active');
                }
            });
            
            currentStep = step;
            
            // Popola dati se necessario
            if (step === 4) popolaAllegato21();
            if (step === 5) {
            popolaFormularioF();
            // CALCOLA AUTOMATICAMENTE S3 dai preventivi se non già fatto
            setTimeout(() => {
                if (!document.getElementById('quotaTecnologieAbilitanti').value) {
                    const hasS3 = datiDomanda.preventivi?.some(p => p.tipologia === 'lett_a' || p.tipologia === 'lett_c');
                    if (hasS3) {
                        calcolaAutomaticoS3DaPreventivi();
                    }
                } else {
                    calcolaPercentualeS3();
                }
            }, 200);
    }
            if (step === 6) popolaChecklist();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log(`✅ Navigato a step ${step}`);
        }
        
        function validaFaseCorrente() {
            switch(currentStep) {
                case 1:
                    if (!document.getElementById('ragioneSociale').value) {
                        alert('⚠️ Compilare la ragione sociale!');
                        return false;
                    }
                    if (!document.getElementById('partitaIva').value) {
                        alert('⚠️ Compilare la Partita IVA!');
                        return false;
                    }
                    if (!document.getElementById('dimensioneImpresa').value) {
                        alert('⚠️ Selezionare la dimensione dell\'impresa!');
                        return false;
                    }
                    const sedeSicilia = document.getElementById('sedeSicilia').value;
                    if (!sedeSicilia || sedeSicilia === 'no') {
                        alert('⚠️ L\'impresa deve avere sede legale o unità operativa in Sicilia!');
                        return false;
                    }
                    if (!document.getElementById('checkDURC').checked || !document.getElementById('checkAntimafia').checked) {
                        alert('⚠️ Confermare tutti i requisiti di ammissibilità!');
                        return false;
                    }
                    break;
                    
                case 2:
                    const valoreProduzione = getValoreNumerico('valoreProduzione');
                    
                    if (valoreProduzione <= 0) {
                        alert('⚠️ CAMPO OBBLIGATORIO!\n\nInserire il Valore della Produzione (campo A) per calcolare il MOL.');
                        document.getElementById('valoreProduzione').focus();
                        return false;
                    }
                    
                    if (!datiDomanda.economia?.mol || datiDomanda.economia.mol === 0) {
                        calcolaMOLAutomatico();
                    }
                    
                    const mol = datiDomanda.economia?.mol || 0;
                    
                    if (mol <= 0) {
                        alert('❌ MOL NON VALIDO!\n\nIl Margine Operativo Lordo è ' + formatEuro(mol) + '\n\nVerificare i dati contabili.');
                        return false;
                    }
                    
                    const costoTotale = getValoreNumerico('costoTotale');
                    if (costoTotale < config.minimoInvestimento) {
                        alert(`⚠️ Il costo minimo è ${formatEuro(config.minimoInvestimento)}`);
                        document.getElementById('costoTotale').focus();
                        return false;
                    }
                    
                    const dimensione = document.getElementById('dimensioneImpresa').value;
                    if (!dimensione) {
                        alert('⚠️ Selezionare la dimensione dell\'impresa nella Fase 1!');
                        return false;
                    }
                    
                    const massimale = config.limiti[dimensione];
                    if (costoTotale > massimale) {
                        alert(`⚠️ Il costo supera il massimale di ${formatEuro(massimale)}!`);
                        return false;
                    }
                    
                    if (!document.getElementById('modalitaErogazione').value) {
                        alert('⚠️ Selezionare la modalità di erogazione!');
                        return false;
                    }
                    break;
                    
                case 3:
                    if (datiDomanda.preventivi.length === 0) {
                        alert('⚠️ Inserire almeno un preventivo di spesa!');
                        return false;
                    }
                    break;
                    
                case 4:
                    if (!document.getElementById('numeroMarcaBollo').value || !document.getElementById('dataMarcaBollo').value) {
                        alert('⚠️ Inserire i dati della marca da bollo!');
                        return false;
                    }
                    if (!document.getElementById('titoloProgettoIstanza').value) {
                        alert('⚠️ Inserire il titolo del progetto!');
                        return false;
                    }
                    break;
            }
            
            return true;
        }
        
        function salvaDatiFase(fase) {
            switch(fase) {
                case 1:
                    datiDomanda.impresa = {
                        ragioneSociale: document.getElementById('ragioneSociale').value,
                        partitaIva: document.getElementById('partitaIva').value,
                        codiceFiscale: document.getElementById('codiceFiscale').value,
                        pec: document.getElementById('pec').value,
                        annoCostituzione: document.getElementById('annoCostituzione').value,
                        sedeLegale: document.getElementById('sedeLegale').value,
                        sedeSicilia: document.getElementById('sedeSicilia').value,
                        dimensione: document.getElementById('dimensioneImpresa').value
                    };
                    
                    datiDomanda.legaleRappresentante = {
                        nome: document.getElementById('lrNome').value,
                        cognome: document.getElementById('lrCognome').value,
                        codiceFiscale: document.getElementById('lrCF').value,
                        luogoNascita: document.getElementById('lrLuogoNascita').value,
                        dataNascita: document.getElementById('lrDataNascita').value,
                        residenza: document.getElementById('lrResidenza').value
                    };
                    break;
                    
                case 2:
                    datiDomanda.economia = {
                        ...datiDomanda.economia,
                        annoRiferimento: document.getElementById('annoRiferimento').value,
                        tipoDocumento: document.getElementById('tipoDocumento').value,
                        valoreProduzione: getValoreNumerico('valoreProduzione'),
                        materiePrime: getValoreNumerico('materiePrime'),
                        costiServizi: getValoreNumerico('costiServizi'),
                        costiBeniTerzi: getValoreNumerico('costiBeniTerzi'),
                        spesePersonale: getValoreNumerico('spesePersonale'),
                        variazioniRimanenze: getValoreNumerico('variazioniRimanenze'),
                        oneriDiversi: getValoreNumerico('oneriDiversi'),
                        ammortamenti: getValoreNumerico('ammortamenti'),
                        costoTotale: getValoreNumerico('costoTotale'),
                        modalitaErogazione: document.getElementById('modalitaErogazione').value,
                        richiestaAnticipo: document.getElementById('richiestaAnticipo').value,
                        disponibilitaFinanziaria: getValoreNumerico('disponibilitaFinanziaria'),
                        tipoProfessionista: document.getElementById('tipoProfessionista').value,
                        nomeProfessionista: document.getElementById('nomeProfessionista').value,
                        cfProfessionista: document.getElementById('cfProfessionista').value,
                        iscrizioneAlbo: document.getElementById('iscrizioneAlbo').value,
                        sedeProfessionista: document.getElementById('sedeProfessionista').value
                    };
                    break;
                    
                case 4:
                    datiDomanda.allegato21 = {
                        numeroMarcaBollo: document.getElementById('numeroMarcaBollo').value,
                        dataMarcaBollo: document.getElementById('dataMarcaBollo').value,
                        tipoImpresa: document.getElementById('tipoImpresa').value,
                        haDeMinimis: document.getElementById('haDeMinimis').value,
                        fusioni: document.getElementById('fusioni').value,
                        ula_dichiarante: getValoreNumerico('ula_dichiarante'),
                        fatturato_dichiarante: getValoreNumerico('fatturato_dichiarante'),
                        bilancio_dichiarante: getValoreNumerico('bilancio_dichiarante')
                    };
                    break;
                    
                case 5:
                    datiDomanda.formulario = {
                        titoloProgetto: document.getElementById('titoloProgetto').value,
                        acronimoProgetto: document.getElementById('acronimoProgetto').value,
                        durataProgetto: document.getElementById('durataProgetto').value,
                        attivitaEconomica: document.getElementById('attivitaEconomica').value,
                        posizionamentoCompetitivo: document.getElementById('posizionamentoCompetitivo').value
                    };
                    break;
            }
            
            salvaLocalmente();
        }
        
        function popolaAllegato21() {
            document.getElementById('recap_ragioneSociale').textContent = datiDomanda.impresa.ragioneSociale || '';
            document.getElementById('recap_sedeLegale').textContent = datiDomanda.impresa.sedeLegale || '';
            document.getElementById('recap_piva').textContent = datiDomanda.impresa.partitaIva || '';
            document.getElementById('recap_cf').textContent = datiDomanda.impresa.codiceFiscale || '';
            document.getElementById('recap_pec').textContent = datiDomanda.impresa.pec || '';
            document.getElementById('recap_costoTotale').textContent = formatEuro(datiDomanda.economia.costoTotale);
            document.getElementById('recap_contributo').textContent = formatEuro(datiDomanda.economia.contributoRichiesto);
            
            if (datiDomanda.formulario?.titoloProgetto) {
                document.getElementById('titoloProgettoIstanza').value = datiDomanda.formulario.titoloProgetto;
            }
        }
        
     function popolaFormularioF() {
    document.getElementById('costoTotaleFormulario').value = formatEuro(datiDomanda.economia.costoTotale);
    document.getElementById('contributoFormulario').value = formatEuro(datiDomanda.economia.contributoRichiesto);
    document.getElementById('soggettoProponenteForm').value = datiDomanda.impresa.ragioneSociale;
    
    const titoloIstanza = document.getElementById('titoloProgettoIstanza')?.value;
    const titoloForm = document.getElementById('titoloProgetto');
    
    if (titoloForm) {
        if (titoloIstanza) {
            titoloForm.value = titoloIstanza;
            titoloForm.readOnly = true;
            titoloForm.style.backgroundColor = '#f0f0f0';
        } else if (datiDomanda.formulario?.titoloProgetto) {
            titoloForm.value = datiDomanda.formulario.titoloProgetto;
        }
    }
    
    // Genera budget H.1
    generaBudgetH1();

    if (document.getElementById('quotaTecnologieAbilitanti').value) {
        setTimeout(() => calcolaPercentualeS3(), 100);
    }
}

// Aggiungi alla funzione popolaFormularioF
function generaBudgetH1() {
    const tipologieNomi = {
        'lett_a': 'Consulenza per dignosi digitale',
        'lett_b': 'Consulenza specialistica (S3)',
        'lett_c': 'Tecnologie digitali base',
        'lett_d': 'Tecnologie evolute (S3)',
        'lett_e': 'Software standard/attrezzature'
    };
    
    let budgetHtml = '<table class="table table-bordered table-hover"><thead class="table-primary"><tr><th>Tipologia</th><th class="text-end">Costo €</th><th class="text-end">Contributo 80% €</th></tr></thead><tbody>';
    
    let totaliPerTipologia = {};
    
    datiDomanda.preventivi.forEach(prev => {
        totaliPerTipologia[prev.tipologia] = (totaliPerTipologia[prev.tipologia] || 0) + prev.importo;
    });
    
    Object.keys(tipologieNomi).forEach(tip => {
        const costo = totaliPerTipologia[tip] || 0;
        const contributo = costo * 0.80;
        if (costo > 0) {
            budgetHtml += `
                <tr>
                    <td>${tipologieNomi[tip]}</td>
                    <td class="text-end">${formatEuro(costo)}</td>
                    <td class="text-end">${formatEuro(contributo)}</td>
                </tr>
            `;
        }
    });
    
    budgetHtml += `
        <tr class="table-success fw-bold">
            <td>TOTALE</td>
            <td class="text-end">${formatEuro(datiDomanda.economia.costoTotale)}</td>
            <td class="text-end">${formatEuro(datiDomanda.economia.contributoRichiesto)}</td>
        </tr>
    `;
    budgetHtml += '</tbody></table>';
    
    document.getElementById('budgetDettagliatoH1').innerHTML = budgetHtml;
}
        
function popolaChecklist() {
    const summaryHtml = `
        <div class="summary-card">
            <h5>Impresa</h5>
            <div class="value">${datiDomanda.impresa.ragioneSociale}</div>
        </div>
        <div class="summary-card">
            <h5>Costo Totale</h5>
            <div class="value">${formatEuro(datiDomanda.economia.costoTotale)}</div>
        </div>
        <div class="summary-card">
            <h5>Contributo Richiesto</h5>
            <div class="value">${formatEuro(datiDomanda.economia.contributoRichiesto)}</div>
        </div>
        <div class="summary-card">
            <h5>Indicatore Ordinatore</h5>
            <div class="value">${datiDomanda.economia.indicatoreOrdinatore}</div>
        </div>
    `;
    document.getElementById('summaryGrid').innerHTML = summaryHtml;
    
    const documenti = [
        {
            nome: 'Allegato 2.1 - Istanza di finanziamento',
            descrizione: 'Firmato digitalmente dal Legale Rappresentante con marca da bollo da €16,00',
            obbligatorio: true
        },
        {
            nome: 'Allegato B - Dichiarazione sostitutiva MOL',
            descrizione: 'Asseverato da Dottore Commercialista, Revisore Legale o CAF',
            obbligatorio: true
        },
        {
            nome: 'Allegato C - Attestazione capacità finanziaria',
            descrizione: 'Certificazione bancaria con disponibilità ≥ 30% del costo totale',
            obbligatorio: true
        },
        {
            nome: 'Allegato F - Formulario proposta progettuale',
            descrizione: 'Firmato digitalmente dal Legale Rappresentante',
            obbligatorio: true
        },
        {
            nome: 'Preventivi di spesa',
            descrizione: `${datiDomanda.preventivi.length} preventivi datati e firmati dai fornitori`,
            obbligatorio: true
        },
        {
            nome: 'Bilanci ultimi 2 esercizi',
            descrizione: 'Bilanci approvati e depositati al Registro Imprese (o dichiarazioni redditi)',
            obbligatorio: true
        },
        {
            nome: 'Visura Camerale aggiornata',
            descrizione: 'Risalente a non più di 30 giorni dalla data di presentazione',
            obbligatorio: true
        },
        {
            nome: 'Documento identità Legale Rappresentante',
            descrizione: 'Carta d\'identità o patente in corso di validità',
            obbligatorio: true
        },
        {
            nome: 'Fideiussione bancaria (se richiesto anticipo)',
            descrizione: 'Garanzia fideiussoria per il 100% dell\'anticipo richiesto',
            obbligatorio: datiDomanda.economia?.richiestaAnticipo === 'si'
        },
        {
            nome: 'Certificazioni qualifica fornitori',
            descrizione: 'Documentazione che attesta la qualifica dei fornitori (DIH, Start-up, ecc.)',
            obbligatorio: false
        },
        {
            nome: 'CV membri gruppo di lavoro',
            descrizione: 'Curriculum delle figure professionali chiave coinvolte nel progetto',
            obbligatorio: false
        },
        {
            nome: 'Lettere di impegno fornitori',
            descrizione: 'Lettere di impegno dei fornitori a realizzare le forniture proposte',
            obbligatorio: false
        },
        {
            nome: 'Documentazione criterio premiale G.1',
            descrizione: 'Evidenze per ricadute occupazionali femminili/giovanili',
            obbligatorio: false
        },
        {
            nome: 'Altra documentazione tecnica',
            descrizione: 'Schede tecniche, cataloghi, brochure prodotti/servizi',
            obbligatorio: false
        }
    ];
    
    let checklistHtml = '';
    documenti.forEach((doc, index) => {
        if (doc.obbligatorio || doc.obbligatorio === false) {
            const badgeObbligatorio = doc.obbligatorio 
                ? '<span class="badge bg-danger ms-2">OBBLIGATORIO</span>' 
                : '<span class="badge bg-secondary ms-2">Facoltativo</span>';
            
            checklistHtml += `
                <div class="checklist-item" id="checkItem${index}">
                    <input type="checkbox" class="checklist-checkbox" id="check${index}" onchange="aggiornaChecklist(${index})">
                    <div class="checklist-content">
                        <div class="checklist-title">
                            ${doc.nome}
                            ${badgeObbligatorio}
                        </div>
                        <div class="checklist-description">${doc.descrizione}</div>
                    </div>
                </div>
            `;
        }
    });
    
    document.getElementById('checklistDocumenti').innerHTML = checklistHtml;
    datiDomanda.checklist = documenti.map(d => ({ ...d, completato: false }));
}
        
        function aggiornaChecklist(index) {
            const checkbox = document.getElementById(`check${index}`);
            const item = document.getElementById(`checkItem${index}`);
            
            if (checkbox.checked) {
                item.classList.add('completed');
                datiDomanda.checklist[index].completato = true;
            } else {
                item.classList.remove('completed');
                datiDomanda.checklist[index].completato = false;
            }
            
            salvaLocalmente();
        }
        
        // ============================================
        // FUNZIONI FASE 4
        // ============================================
        
        function calcolaTotaliDimensione() {
            const ula_dich = getValoreNumerico('ula_dichiarante');
            const ula_ass = getValoreNumerico('ula_associate');
            const ula_coll = getValoreNumerico('ula_collegate');
            
            const fatt_dich = getValoreNumerico('fatturato_dichiarante');
            const fatt_ass = getValoreNumerico('fatturato_associate');
            const fatt_coll = getValoreNumerico('fatturato_collegate');
            
            const bil_dich = getValoreNumerico('bilancio_dichiarante');
            const bil_ass = getValoreNumerico('bilancio_associate');
            const bil_coll = getValoreNumerico('bilancio_collegate');
            
            document.getElementById('ula_totale').textContent = (ula_dich + ula_ass + ula_coll).toFixed(2);
            document.getElementById('fatturato_totale').textContent = (fatt_dich + fatt_ass + fatt_coll).toFixed(2);
            document.getElementById('bilancio_totale').textContent = (bil_dich + bil_ass + bil_coll).toFixed(2);
        }
        
        function toggleDeMinimisTable() {
            const select = document.getElementById('haDeMinimis').value;
            document.getElementById('deMinimisTable').style.display = select === 'si' ? 'block' : 'none';
        }
        
        function aggiungiRigaDeMinimis() {
            const tbody = document.getElementById('deMinimisRows');
            const newRow = tbody.rows[0].cloneNode(true);
            newRow.querySelectorAll('input').forEach(input => input.value = '');
            tbody.appendChild(newRow);
        }
        
        function rimuoviRigaDeMinimis(btn) {
            const tbody = document.getElementById('deMinimisRows');
            if (tbody.rows.length > 1) {
                btn.closest('tr').remove();
            }
        }
        
     // ============================================
// EXPORT EXCEL COMPLETO - TUTTE LE FASI
// ============================================

function esportaExcel() {
    try {
        // Genera codice identificativo
        const codiceId = generaCodiceIdentificativo();
        
        // Crea workbook
        const wb = XLSX.utils.book_new();
        
        // ==========================================
        // SHEET 1: FASE 1 - AMMISSIBILITÀ E DATI BASE
        // ==========================================
        const wsFase1 = XLSX.utils.aoa_to_sheet([
            ['DIGIT IMPRESE - FASE 1: AMMISSIBILITÀ E DATI ANAGRAFICI'],
            ['Codice Domanda:', codiceId],
            ['Data Generazione:', new Date().toLocaleString('it-IT')],
            [],
            ['DATI IMPRESA'],
            ['Ragione Sociale', datiDomanda.impresa.ragioneSociale || ''],
            ['Partita IVA', datiDomanda.impresa.partitaIva || ''],
            ['Codice Fiscale', datiDomanda.impresa.codiceFiscale || ''],
            ['PEC', datiDomanda.impresa.pec || ''],
            ['Anno Costituzione', datiDomanda.impresa.annoCostituzione || ''],
            ['Sede Legale', datiDomanda.impresa.sedeLegale || ''],
            ['Sede in Sicilia', datiDomanda.impresa.sedeSicilia || ''],
            ['Dimensione Impresa', datiDomanda.impresa.dimensione || ''],
            [],
            ['LEGALE RAPPRESENTANTE'],
            ['Nome', datiDomanda.legaleRappresentante.nome || ''],
            ['Cognome', datiDomanda.legaleRappresentante.cognome || ''],
            ['Codice Fiscale', datiDomanda.legaleRappresentante.codiceFiscale || ''],
            ['Luogo di Nascita', datiDomanda.legaleRappresentante.luogoNascita || ''],
            ['Data di Nascita', datiDomanda.legaleRappresentante.dataNascita || ''],
            ['Residenza', datiDomanda.legaleRappresentante.residenza || ''],
            [],
            ['REQUISITI DI AMMISSIBILITÀ'],
            ['DURC Regolare', document.getElementById('checkDURC')?.checked ? 'SÌ' : 'NO'],
            ['Antimafia', document.getElementById('checkAntimafia')?.checked ? 'SÌ' : 'NO'],
            ['Assenza Revoche', document.getElementById('checkRevoche')?.checked ? 'SÌ' : 'NO'],
            ['Progetto Diverso Azione 1.1.2', document.getElementById('checkProgettoDiverso')?.checked ? 'SÌ' : 'NO']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase1, 'Fase 1 - Ammissibilità');
        
        // ==========================================
        // SHEET 2: FASE 2 - CALCOLO MOL
        // ==========================================
        const wsFase2 = XLSX.utils.aoa_to_sheet([
            ['FASE 2: DICHIARAZIONE SOSTITUTIVA MOL (Allegato B)'],
            [],
            ['PERIODO DI RIFERIMENTO'],
            ['Anno di Riferimento Bilancio', datiDomanda.economia.annoRiferimento || ''],
            ['Tipo di Documento', datiDomanda.economia.tipoDocumento || ''],
            [],
            ['DATI CONTABILI PER CALCOLO MOL'],
            ['Voce', 'Importo €'],
            ['A) Valore della Produzione', datiDomanda.economia.valoreProduzione || 0],
            ['B) Materie prime, sussidiarie, consumo e merci', datiDomanda.economia.materiePrime || 0],
            ['C) Costi dei servizi', datiDomanda.economia.costiServizi || 0],
            ['D) Costi godimento beni di terzi', datiDomanda.economia.costiBeniTerzi || 0],
            ['E) Spese per il personale', datiDomanda.economia.spesePersonale || 0],
            ['F) Variazioni rimanenze materie prime', datiDomanda.economia.variazioniRimanenze || 0],
            ['G) Oneri diversi di gestione', datiDomanda.economia.oneriDiversi || 0],
            ['Ammortamenti (non nel MOL)', datiDomanda.economia.ammortamenti || 0],
            [],
            ['MOL CALCOLATO', datiDomanda.economia.mol || 0],
            ['Formula', 'A - B - C - D - E - F - G'],
            [],
            ['COSTO DEL PROGETTO'],
            ['Costo Totale Ammissibile €', datiDomanda.economia.costoTotale || 0],
            ['Massimale per dimensione €', datiDomanda.economia.massimale || 0],
            ['Contributo Richiesto (80%) €', datiDomanda.economia.contributoRichiesto || 0],
            ['Cofinanziamento (20%) €', (datiDomanda.economia.costoTotale || 0) * 0.20],
            [],
            ['INDICATORE ORDINATORE (CRITERIO DI GRADUATORIA)'],
            ['MOL / Costo Investimento', datiDomanda.economia.indicatoreOrdinatore || ''],
            ['Posizionamento Stimato', datiDomanda.economia.posizionamento || ''],
            [],
            ['MODALITÀ DI EROGAZIONE'],
            ['Modalità Erogazione', datiDomanda.economia.modalitaErogazione || ''],
            ['Richiesta Anticipo 40%', datiDomanda.economia.richiestaAnticipo || ''],
            [],
            ['CAPACITÀ FINANZIARIA (Allegato C)'],
            ['Disponibilità Finanziaria Certificata €', datiDomanda.economia.disponibilitaFinanziaria || 0],
            ['Capacità Minima Richiesta (30%) €', (datiDomanda.economia.costoTotale || 0) * 0.30],
            ['Esito Verifica', (datiDomanda.economia.disponibilitaFinanziaria || 0) >= ((datiDomanda.economia.costoTotale || 0) * 0.30) ? 'CONFORME' : 'NON CONFORME'],
            [],
            ['PROFESSIONISTA ASSEVERANTE'],
            ['Tipologia Professionista', datiDomanda.economia.tipoProfessionista || ''],
            ['Nome/Denominazione', datiDomanda.economia.nomeProfessionista || ''],
            ['Codice Fiscale', datiDomanda.economia.cfProfessionista || ''],
            ['N. Iscrizione Albo', datiDomanda.economia.iscrizioneAlbo || ''],
            ['Sede', datiDomanda.economia.sedeProfessionista || '']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase2, 'Fase 2 - MOL');
        
        // ==========================================
        // SHEET 3: FASE 3 - PREVENTIVI
        // ==========================================
        const tipologieNomi = {
            'lett_a': 'a) Consulenza per dignosi digitale',
            'lett_b': 'b) Consulenza specialistica/innovazione (S3)',
            'lett_c': 'c) Tecnologie digitali base',
            'lett_d': 'd) Tecnologie digitali evolute (S3)',
            'lett_e': 'e) Software standard/attrezzature'
        };
        
        const qualificatiNomi = {
            'dih': 'Digital Innovation Hub',
            'startup': 'Start-up innovativa',
            'manager': 'Innovation Manager',
            'consulente': 'Consulente qualificato',
            'standard': 'Fornitore standard'
        };
        
        const preventiviData = [
            ['FASE 3: PREVENTIVI E FORNITORI QUALIFICATI'],
            [],
            ['N.', 'Tipologia Spesa', 'Descrizione', 'Fornitore', 'P.IVA', 'Data', 'Importo €', 'Fornitore Qualificato', 'Richiede Qualifica']
        ];
        
        if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
            datiDomanda.preventivi.forEach((p, idx) => {
                preventiviData.push([
                    idx + 1,
                    tipologieNomi[p.tipologia] || p.tipologia,
                    p.descrizione,
                    p.fornitore,
                    p.piva || '',
                    p.data,
                    p.importo,
                    qualificatiNomi[p.qualificato] || p.qualificato,
                    p.richiedeQualificato ? 'SÌ' : 'NO'
                ]);
            });
            
            preventiviData.push([]);
            
            // Totali per tipologia
            const totaliPerTipologia = {};
            datiDomanda.preventivi.forEach(p => {
                totaliPerTipologia[p.tipologia] = (totaliPerTipologia[p.tipologia] || 0) + p.importo;
            });
            
            preventiviData.push(['RIEPILOGO PER TIPOLOGIA']);
            Object.keys(totaliPerTipologia).forEach(tip => {
                preventiviData.push(['', tipologieNomi[tip], '', '', '', '', totaliPerTipologia[tip], '', '']);
            });
            
            preventiviData.push([]);
            const totale = datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0);
            preventiviData.push(['', 'TOTALE PREVENTIVI', '', '', '', '', totale, '', '']);
        } else {
            preventiviData.push(['Nessun preventivo inserito']);
        }
        
        const wsFase3 = XLSX.utils.aoa_to_sheet(preventiviData);
        XLSX.utils.book_append_sheet(wb, wsFase3, 'Fase 3 - Preventivi');
        
        // ==========================================
        // SHEET 4: FASE 4 - ISTANZA 2.1
        // ==========================================
        const wsFase4 = XLSX.utils.aoa_to_sheet([
            ['FASE 4: ALLEGATO 2.1 - ISTANZA DI FINANZIAMENTO'],
            [],
            ['RIEPILOGO DOMANDA'],
            ['Impresa', datiDomanda.impresa.ragioneSociale || ''],
            ['Sede Legale', datiDomanda.impresa.sedeLegale || ''],
            ['P.IVA', datiDomanda.impresa.partitaIva || ''],
            ['C.F.', datiDomanda.impresa.codiceFiscale || ''],
            ['PEC', datiDomanda.impresa.pec || ''],
            [],
            ['PROGETTO'],
            ['Titolo Progetto', document.getElementById('titoloProgettoIstanza')?.value || ''],
            ['Costo Totale Ammissibile €', datiDomanda.economia.costoTotale || 0],
            ['Contributo Richiesto (80%) €', datiDomanda.economia.contributoRichiesto || 0],
            ['Cofinanziamento (20%) €', (datiDomanda.economia.costoTotale || 0) * 0.20],
            [],
            ['DICHIARAZIONI (Art. 47 D.P.R. 445/2000)'],
            ['a) DURC Regolare', document.getElementById('dichA')?.checked ? '☑ SÌ' : '☐ NO'],
            ['b) Normativa Antimafia', document.getElementById('dichB')?.checked ? '☑ SÌ' : '☐ NO'],
            ['c) Capacità Economico-Finanziaria', document.getElementById('dichC')?.checked ? '☑ SÌ' : '☐ NO'],
            ['d) Assenza Revoche', document.getElementById('dichD')?.checked ? '☑ SÌ' : '☐ NO'],
            ['e) Progetto Diverso', document.getElementById('dichE')?.checked ? '☑ SÌ' : '☐ NO'],
            ['f) Veridicità Dati', document.getElementById('dichF')?.checked ? '☑ SÌ' : '☐ NO'],
            ['g) Normativa Ambientale e Sicurezza', document.getElementById('dichG')?.checked ? '☑ SÌ' : '☐ NO'],
            ['h) Assenza Cause Ostative', document.getElementById('dichH')?.checked ? '☑ SÌ' : '☐ NO'],
            ['i) Informativa Privacy', document.getElementById('dichI')?.checked ? '☑ SÌ' : '☐ NO'],
            ['l) Impegno Comunicazioni', document.getElementById('dichL')?.checked ? '☑ SÌ' : '☐ NO'],
            [],
            ['DIMENSIONE AZIENDALE (Reg. CE 651/2014)'],
            ['Categoria', 'N. Occupati (ULA)', 'Fatturato (M€)', 'Totale Bilancio (M€)'],
            ['Impresa Dichiarante', getValoreNumerico('ula_dichiarante'), getValoreNumerico('fatturato_dichiarante'), getValoreNumerico('bilancio_dichiarante')],
            ['Imprese Associate', getValoreNumerico('ula_associate'), getValoreNumerico('fatturato_associate'), getValoreNumerico('bilancio_associate')],
            ['Imprese Collegate', getValoreNumerico('ula_collegate'), getValoreNumerico('fatturato_collegate'), getValoreNumerico('bilancio_collegate')],
            ['TOTALE', document.getElementById('ula_totale')?.textContent || 0, document.getElementById('fatturato_totale')?.textContent || 0, document.getElementById('bilancio_totale')?.textContent || 0],
            [],
            ['CLASSIFICAZIONE IMPRESA'],
            ['Tipo di Impresa', document.getElementById('tipoImpresa')?.value || ''],
            [],
            ['REGIME DE MINIMIS (Reg. UE 2023/2831)'],
            ['Ha già beneficiato di aiuti De Minimis?', document.getElementById('haDeMinimis')?.value || ''],
            ['Fusioni/Acquisizioni negli ultimi 3 anni?', document.getElementById('fusioni')?.value || ''],
            [],
            ['MARCA DA BOLLO'],
            ['Numero Identificativo', document.getElementById('numeroMarcaBollo')?.value || ''],
            ['Data Marca da Bollo', document.getElementById('dataMarcaBollo')?.value || '']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase4, 'Fase 4 - Istanza 2.1');
        
        // ==========================================
        // SHEET 5: FASE 5 - FORMULARIO (Parte 1)
        // ==========================================
        const wsFase5_1 = XLSX.utils.aoa_to_sheet([
            ['FASE 5: FORMULARIO PROPOSTA PROGETTUALE (Allegato F) - Parte 1'],
            [],
            ['A. INFORMAZIONI GENERALI'],
            ['A.1 Titolo progetto', document.getElementById('titoloProgetto')?.value || ''],
            ['A.2 Acronimo del progetto', document.getElementById('acronimoProgetto')?.value || ''],
            ['A.3 Durata (mesi)', document.getElementById('durataProgetto')?.value || ''],
            ['A.4 Costo totale ammissibile €', datiDomanda.economia.costoTotale || 0],
            ['A.5 Contributo richiesto €', datiDomanda.economia.contributoRichiesto || 0],
            ['A.6 Soggetto proponente', datiDomanda.impresa.ragioneSociale || ''],
            ['A.7 Breve presentazione', document.getElementById('missionAttivita')?.value || ''],
            [],
            ['B. DESCRIZIONE DEL SOGGETTO PROPONENTE'],
            ['B.1 Attività economica e innovazione', document.getElementById('attivitaEconomica')?.value || ''],
            ['B.2 Posizionamento competitivo', document.getElementById('posizionamentoCompetitivo')?.value || ''],
            [],
            ['C. FABBISOGNI DI INNOVAZIONE'],
            ['C.1 Contestualizzazione fabbisogni', document.getElementById('contestualizzazioneFabbisogni')?.value || ''],
            ['C.2 Obiettivi perseguiti', document.getElementById('obiettiviPerseguiti')?.value || ''],
            [],
            ['D. CAPACITÀ AMMINISTRATIVA ED OPERATIVA'],
            ['D.1 Capacità amministrativa', document.getElementById('capacitaAmministrativa')?.value || ''],
            ['D.2 Gruppo di lavoro', document.getElementById('gruppoDiLavoro')?.value || '']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase5_1, 'Fase 5A - Formulario 1');
        
        // ==========================================
        // SHEET 6: FASE 5 - FORMULARIO (Parte 2)
        // ==========================================
        const wsFase5_2 = XLSX.utils.aoa_to_sheet([
            ['FASE 5: FORMULARIO PROPOSTA PROGETTUALE - Parte 2'],
            [],
            ['E. DESCRIZIONE PROGETTO E IMPLEMENTAZIONE'],
            ['E.1.i Obiettivi generali e specifici', document.getElementById('obiettiviGeneraliSpecifici')?.value || ''],
            ['E.1.ii Quadro logico', document.getElementById('quadroLogico')?.value || ''],
            ['E.1.iii Implementazione innovazioni', document.getElementById('implementazioneInnovazioni')?.value || ''],
            ['E.1.iv Coinvolgimento utilizzatori', document.getElementById('coinvolgimentoUtilizzatori')?.value || ''],
            [],
            ['E.1.v PIANO DI LAVORO - MATRICE WP'],
            [document.getElementById('matriceWP')?.value || ''],
            [],
            ['E.1.v CRONOPROGRAMMA'],
            [document.getElementById('cronoprogramma')?.value || ''],
            [],
            ['F. MONITORAGGIO E KPI'],
            ['F.1 Sistema di monitoraggio', document.getElementById('sistemaMonitoraggio')?.value || ''],
            ['F.2 Valutazione impatto', document.getElementById('valutazioneImpatto')?.value || ''],
            [],
            ['G. CRITERI PREMIALI'],
            ['G.1 Ricadute occupazionali', document.getElementById('ricaduteOccupazionali')?.value || ''],
            ['G.5 Quota investimento S3 €', getValoreNumerico('quotaTecnologieAbilitanti')],
            ['G.5 Percentuale S3 %', document.getElementById('percentualeTecnologieS3')?.value || '']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase5_2, 'Fase 5B - Formulario 2');
        
        // ==========================================
        // SHEET 7: FASE 5 - PIANO FINANZIARIO H.2
        // ==========================================
        const wsFase5_H2 = XLSX.utils.aoa_to_sheet([
            ['H.2 PIANO DELLE COPERTURE FINANZIARIE'],
            [],
            ['Prospetto Impieghi/Fonti', 'Anno 1 €', 'Totale €', '% sul totale'],
            [],
            ['IMPIEGHI (fabbisogni finanziari)'],
            ['• Investimenti immateriali', getValoreNumerico('h2_inv_immat_anno1'), getValoreNumerico('h2_inv_immat_tot'), document.getElementById('h2_inv_immat_perc')?.value || ''],
            ['• Investimenti materiali', getValoreNumerico('h2_inv_mat_anno1'), getValoreNumerico('h2_inv_mat_tot'), document.getElementById('h2_inv_mat_perc')?.value || ''],
            ['• IVA sugli investimenti', getValoreNumerico('h2_iva_anno1'), getValoreNumerico('h2_iva_tot'), document.getElementById('h2_iva_perc')?.value || ''],
            ['TOTALE IMPIEGHI', '', document.getElementById('h2_tot_impieghi_tot')?.textContent?.replace(/[€\s.]/g, '').replace(',', '.') || 0, '100%'],
            [],
            ['FONTI (coperture finanziarie)'],
            ['Contributo pubblico richiesto', getValoreNumerico('h2_contributo_anno1'), document.getElementById('h2_contributo_tot')?.value?.replace(/[€\s.]/g, '').replace(',', '.') || 0, document.getElementById('h2_contributo_perc')?.value || ''],
            ['Cofinanziamento proprio:'],
            ['• Incremento Capitale Sociale', getValoreNumerico('h2_cap_sociale_anno1'), getValoreNumerico('h2_cap_sociale_tot'), document.getElementById('h2_cap_sociale_perc')?.value || ''],
            ['• Finanziamento soci', getValoreNumerico('h2_finanz_soci_anno1'), getValoreNumerico('h2_finanz_soci_tot'), document.getElementById('h2_finanz_soci_perc')?.value || ''],
            ['• Utilizzo riserve disponibili', getValoreNumerico('h2_riserve_anno1'), getValoreNumerico('h2_riserve_tot'), document.getElementById('h2_riserve_perc')?.value || ''],
            ['• Finanziamento m/l termine', getValoreNumerico('h2_finanz_ml_anno1'), getValoreNumerico('h2_finanz_ml_tot'), document.getElementById('h2_finanz_ml_perc')?.value || ''],
            ['• Finanziamento breve termine', getValoreNumerico('h2_finanz_breve_anno1'), getValoreNumerico('h2_finanz_breve_tot'), document.getElementById('h2_finanz_breve_perc')?.value || ''],
            ['TOTALE FONTI', '', document.getElementById('h2_tot_fonti_tot')?.textContent?.replace(/[€\s.]/g, '').replace(',', '.') || 0, document.getElementById('h2_tot_fonti_perc')?.textContent || ''],
            [],
            ['Dettaglio fonti', document.getElementById('fontiFinanziamento')?.value || '']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase5_H2, 'Fase 5C - Piano H.2');
        
        // ==========================================
        // SHEET 8: FASE 5 - CONTO ECONOMICO H.3
        // ==========================================
        const wsFase5_H3 = XLSX.utils.aoa_to_sheet([
            ['H.3 STRATEGIA DI SOSTENIBILITÀ ECONOMICO-FINANZIARIA'],
            [],
            ['Descrizione strategia', document.getElementById('strategiaSostenibilita')?.value || ''],
            [],
            ['CONTO ECONOMICO PREVISIONALE'],
            ['Voce', '2023', '2024', 'Anno n+1', 'Anno n+2', 'Anno n+3'],
            ['Fatturato/entrate', getValoreNumerico('h3_fatt_2023'), getValoreNumerico('h3_fatt_2024'), getValoreNumerico('h3_fatt_n1'), getValoreNumerico('h3_fatt_n2'), getValoreNumerico('h3_fatt_n3')],
            ['Altri ricavi/entrate', getValoreNumerico('h3_altri_2023'), getValoreNumerico('h3_altri_2024'), getValoreNumerico('h3_altri_n1'), getValoreNumerico('h3_altri_n2'), getValoreNumerico('h3_altri_n3')],
            ['Valore della produzione', document.getElementById('h3_vp_2023')?.dataset?.value || 0, document.getElementById('h3_vp_2024')?.dataset?.value || 0, document.getElementById('h3_vp_n1')?.dataset?.value || 0, document.getElementById('h3_vp_n2')?.dataset?.value || 0, document.getElementById('h3_vp_n3')?.dataset?.value || 0],
            ['Consumo MP', getValoreNumerico('h3_mp_2023'), getValoreNumerico('h3_mp_2024'), getValoreNumerico('h3_mp_n1'), getValoreNumerico('h3_mp_n2'), getValoreNumerico('h3_mp_n3')],
            ['Servizi', getValoreNumerico('h3_serv_2023'), getValoreNumerico('h3_serv_2024'), getValoreNumerico('h3_serv_n1'), getValoreNumerico('h3_serv_n2'), getValoreNumerico('h3_serv_n3')],
            ['Godimento beni terzi', getValoreNumerico('h3_god_2023'), getValoreNumerico('h3_god_2024'), getValoreNumerico('h3_god_n1'), getValoreNumerico('h3_god_n2'), getValoreNumerico('h3_god_n3')],
            ['Personale', getValoreNumerico('h3_pers_2023'), getValoreNumerico('h3_pers_2024'), getValoreNumerico('h3_pers_n1'), getValoreNumerico('h3_pers_n2'), getValoreNumerico('h3_pers_n3')],
            ['MOL', document.getElementById('h3_mol_2023')?.dataset?.value || 0, document.getElementById('h3_mol_2024')?.dataset?.value || 0, document.getElementById('h3_mol_n1')?.dataset?.value || 0, document.getElementById('h3_mol_n2')?.dataset?.value || 0, document.getElementById('h3_mol_n3')?.dataset?.value || 0],
            ['Ammortamenti', getValoreNumerico('h3_amm_2023'), getValoreNumerico('h3_amm_2024'), getValoreNumerico('h3_amm_n1'), getValoreNumerico('h3_amm_n2'), getValoreNumerico('h3_amm_n3')],
            ['Risultato Operativo', document.getElementById('h3_ro_2023')?.dataset?.value || 0, document.getElementById('h3_ro_2024')?.dataset?.value || 0, document.getElementById('h3_ro_n1')?.dataset?.value || 0, document.getElementById('h3_ro_n2')?.dataset?.value || 0, document.getElementById('h3_ro_n3')?.dataset?.value || 0],
            ['Gestione Finanziaria', getValoreNumerico('h3_fin_2023'), getValoreNumerico('h3_fin_2024'), getValoreNumerico('h3_fin_n1'), getValoreNumerico('h3_fin_n2'), getValoreNumerico('h3_fin_n3')],
            ['Gestione Straordinaria', getValoreNumerico('h3_straord_2023'), getValoreNumerico('h3_straord_2024'), getValoreNumerico('h3_straord_n1'), getValoreNumerico('h3_straord_n2'), getValoreNumerico('h3_straord_n3')],
            ['Risultato lordo', document.getElementById('h3_rl_2023')?.dataset?.value || 0, document.getElementById('h3_rl_2024')?.dataset?.value || 0, document.getElementById('h3_rl_n1')?.dataset?.value || 0, document.getElementById('h3_rl_n2')?.dataset?.value || 0, document.getElementById('h3_rl_n3')?.dataset?.value || 0],
            ['Imposte e tasse', getValoreNumerico('h3_imp_2023'), getValoreNumerico('h3_imp_2024'), getValoreNumerico('h3_imp_n1'), getValoreNumerico('h3_imp_n2'), getValoreNumerico('h3_imp_n3')],
            ['Risultato netto', document.getElementById('h3_rn_2023')?.dataset?.value || 0, document.getElementById('h3_rn_2024')?.dataset?.value || 0, document.getElementById('h3_rn_n1')?.dataset?.value || 0, document.getElementById('h3_rn_n2')?.dataset?.value || 0, document.getElementById('h3_rn_n3')?.dataset?.value || 0],
            [],
            ['H.4 ANALISI PER INDICI'],
            ['Indicatore', '2023', '2024', 'Anno n+1', 'Anno n+2', 'Anno n+3'],
            ['ROI', document.getElementById('h4_roi_2023')?.value || '', document.getElementById('h4_roi_2024')?.value || '', document.getElementById('h4_roi_n1')?.value || '', document.getElementById('h4_roi_n2')?.value || '', document.getElementById('h4_roi_n3')?.value || ''],
            ['Margine contribuzione %', document.getElementById('h4_marg_2023')?.value || '', document.getElementById('h4_marg_2024')?.value || '', document.getElementById('h4_marg_n1')?.value || '', document.getElementById('h4_marg_n2')?.value || '', document.getElementById('h4_marg_n3')?.value || ''],
            ['Rapporto RN/Contributo', document.getElementById('h4_rapp_2023')?.value || '', document.getElementById('h4_rapp_2024')?.value || '', document.getElementById('h4_rapp_n1')?.value || '', document.getElementById('h4_rapp_n2')?.value || '', document.getElementById('h4_rapp_n3')?.value || ''],
            [],
            ['H.5 ANALISI COSTI-BENEFICI'],
            [document.getElementById('h5_costibenefici')?.value || ''],
            [],
            ['H.6 PIANO OCCUPAZIONALE'],
            ['Qualifica', 'ULA 2024', 'ULA previste', 'Variazione'],
            ['Dirigenti', getValoreNumerico('h6_dir_2024'), getValoreNumerico('h6_dir_prev'), document.getElementById('h6_dir_var')?.value || ''],
            ['Quadri', getValoreNumerico('h6_quad_2024'), getValoreNumerico('h6_quad_prev'), document.getElementById('h6_quad_var')?.value || ''],
            ['Impiegati', getValoreNumerico('h6_imp_2024'), getValoreNumerico('h6_imp_prev'), document.getElementById('h6_imp_var')?.value || ''],
            ['Operai', getValoreNumerico('h6_op_2024'), getValoreNumerico('h6_op_prev'), document.getElementById('h6_op_var')?.value || ''],
            [],
            ['H.7 GESTIONE RISCHI FINANZIARI'],
            [document.getElementById('h7_rischi')?.value || ''],
            [],
            ['H.8 OTTIMIZZAZIONE COSTI'],
            [document.getElementById('h8_ottimizzazione')?.value || '']
        ]);
        XLSX.utils.book_append_sheet(wb, wsFase5_H3, 'Fase 5D - Piano H.3-H.8');
        
        // ==========================================
        // SHEET 9: FASE 6 - CHECKLIST DOCUMENTI
        // ==========================================
        const checklistData = [
            ['FASE 6: CHECKLIST DOCUMENTALE'],
            ['Codice Domanda:', codiceId],
            [],
            ['N.', 'Documento', 'Descrizione', 'Obbligatorio', 'Verificato']
        ];
        
        if (datiDomanda.checklist && datiDomanda.checklist.length > 0) {
            datiDomanda.checklist.forEach((doc, idx) => {
                checklistData.push([
                    idx + 1,
                    doc.nome,
                    doc.descrizione,
                    doc.obbligatorio ? 'SÌ' : 'NO',
                    doc.completato ? '☑' : '☐'
                ]);
            });
            
            checklistData.push([]);
            const obbligatoriCompletati = datiDomanda.checklist.filter(d => d.obbligatorio && d.completato).length;
            const obbligatoriTotali = datiDomanda.checklist.filter(d => d.obbligatorio).length;
            checklistData.push(['STATO COMPLETAMENTO', '', '', `${obbligatoriCompletati}/${obbligatoriTotali} obbligatori`, obbligatoriCompletati === obbligatoriTotali ? '✓ COMPLETO' : '✗ INCOMPLETO']);
        }
        
        const wsFase6 = XLSX.utils.aoa_to_sheet(checklistData);
        XLSX.utils.book_append_sheet(wb, wsFase6, 'Fase 6 - Checklist');
        
        // ==========================================
        // SALVA FILE
        // ==========================================
        const filename = `DIGIT_IMPRESE_${codiceId}_${datiDomanda.impresa.partitaIva || 'PIVA'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        console.log('✅ Excel esportato:', filename);
        return filename;
        
    } catch (error) {
        console.error('ERRORE export Excel:', error);
        alert('❌ Errore nell\'export Excel: ' + error.message);
        return null;
    }
}

// ============================================
// EXPORT PDF COMPLETO - TUTTE LE FASI
// ============================================

// ============================================
// EXPORT PDF COMPLETO - VERSIONE ESTESA
// ============================================

function esportaPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Genera codice identificativo
        const codiceId = generaCodiceIdentificativo();
        
        let yPos = 20;
        const leftMargin = 15;
        const rightMargin = 195;
        const lineHeight = 6;
        const pageHeight = 280;
        
        // Funzione per aggiungere nuova pagina se necessario
        const checkPageBreak = (spaceNeeded = 15) => {
            if (yPos + spaceNeeded > pageHeight) {
                doc.addPage();
                yPos = 20;
                return true;
            }
            return false;
        };
        
        // Funzione per aggiungere intestazione sezione
        const addSectionHeader = (title, color = [0, 102, 204]) => {
            checkPageBreak(20);
            doc.setFillColor(...color);
            doc.rect(leftMargin - 5, yPos - 5, 185, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(title, leftMargin, yPos + 2);
            yPos += 12;
            doc.setTextColor(0, 0, 0);
        };
        
        // Funzione per aggiungere sottotitolo
        const addSubHeader = (title) => {
            checkPageBreak(12);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 102, 204);
            doc.text(title, leftMargin, yPos);
            yPos += 8;
            doc.setTextColor(0, 0, 0);
        };
        
        // Funzione per aggiungere campo
        const addField = (label, value, indent = 0) => {
            checkPageBreak(10);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(label + ':', leftMargin + indent, yPos);
            doc.setFont(undefined, 'normal');
            const labelWidth = doc.getTextWidth(label + ': ');
            const maxWidth = rightMargin - leftMargin - labelWidth - indent;
            const valueStr = String(value || 'N/D');
            const lines = doc.splitTextToSize(valueStr, maxWidth);
            doc.text(lines, leftMargin + indent + labelWidth, yPos);
            yPos += Math.max(1, lines.length) * lineHeight;
        };
        
        const addLongText = (label, value, maxLines = null) => {  // maxLines null = illimitato
    checkPageBreak(15);
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text(label + ':', leftMargin, yPos);
    yPos += 6;
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8);
    const valueStr = String(value || 'Non compilato');
    const lines = doc.splitTextToSize(valueStr, rightMargin - leftMargin - 5);
    
    // Stampa TUTTE le righe, gestendo i page break
    lines.forEach((line, index) => {
        checkPageBreak(8);  // Controlla prima di ogni riga
        doc.text(line, leftMargin + 3, yPos);
        yPos += 5;
    });
    
    yPos += 3;  // Spazio dopo il testo
    doc.setFontSize(9);
};
        
        // ==========================================
        // COPERTINA
        // ==========================================
        doc.setFillColor(0, 102, 204);
        doc.rect(0, 0, 210, 297, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(28);
        doc.setFont(undefined, 'bold');
        doc.text('DIGIT IMPRESE', 105, 70, { align: 'center' });
        doc.setFontSize(16);
        doc.text('Domanda di Finanziamento', 105, 90, { align: 'center' });
        doc.setFontSize(14);
        doc.text('FSC Sicilia 2021-2027', 105, 105, { align: 'center' });
        doc.text('Azione 1.2.2 - Digitalizzazione PMI', 105, 118, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text('Codice Domanda:', 105, 145, { align: 'center' });
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(codiceId, 105, 160, { align: 'center' });
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'normal');
        doc.text(datiDomanda.impresa.ragioneSociale || 'N/D', 105, 185, { align: 'center' });
        doc.setFontSize(11);
        doc.text(`P.IVA: ${datiDomanda.impresa.partitaIva || 'N/D'}`, 105, 197, { align: 'center' });
        
        doc.setFontSize(9);
        doc.text(`Generato il: ${new Date().toLocaleString('it-IT')}`, 105, 270, { align: 'center' });
        
        // ==========================================
        // INDICE
        // ==========================================
        doc.addPage();
        yPos = 20;
        doc.setTextColor(0, 0, 0);
        
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('INDICE', 105, yPos, { align: 'center' });
        yPos += 15;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const indice = [
            'FASE 1: Ammissibilità e Dati Anagrafici',
            'FASE 2: Calcolo MOL e Indicatore Ordinatore',
            'FASE 3: Preventivi e Fornitori Qualificati',
            'FASE 4: Istanza di Finanziamento (Allegato 2.1)',
            'FASE 5: Formulario Proposta Progettuale (Allegato F)',
            '   • Sezione A: Informazioni Generali',
            '   • Sezione B: Descrizione Soggetto Proponente',
            '   • Sezione C: Fabbisogni di Innovazione',
            '   • Sezione D: Capacità Amministrativa',
            '   • Sezione E: Descrizione Progetto',
            '   • Sezione F: Monitoraggio e KPI',
            '   • Sezione G: Criteri Premiali',
            '   • Sezione H: Budget e Piano Finanziario',
            'FASE 6: Checklist Documentale'
        ];
        
        indice.forEach(item => {
            doc.text(item, leftMargin + 5, yPos);
            yPos += 7;
        });
        
        // ==========================================
        // FASE 1: AMMISSIBILITÀ E DATI BASE
        // ==========================================
        doc.addPage();
        yPos = 20;
        addSectionHeader('FASE 1: AMMISSIBILITÀ E DATI ANAGRAFICI');
        
        addSubHeader('DATI IMPRESA');
        addField('Ragione Sociale', datiDomanda.impresa.ragioneSociale);
        addField('Partita IVA', datiDomanda.impresa.partitaIva);
        addField('Codice Fiscale', datiDomanda.impresa.codiceFiscale);
        addField('PEC', datiDomanda.impresa.pec);
        addField('Anno Costituzione', datiDomanda.impresa.annoCostituzione);
        addField('Sede Legale', datiDomanda.impresa.sedeLegale);
        addField('Sede in Sicilia', datiDomanda.impresa.sedeSicilia);
        addField('Dimensione Impresa', datiDomanda.impresa.dimensione);
        yPos += 3;
        
        addSubHeader('LEGALE RAPPRESENTANTE');
        addField('Nome e Cognome', `${datiDomanda.legaleRappresentante.nome || ''} ${datiDomanda.legaleRappresentante.cognome || ''}`);
        addField('Codice Fiscale', datiDomanda.legaleRappresentante.codiceFiscale);
        addField('Luogo di Nascita', datiDomanda.legaleRappresentante.luogoNascita);
        addField('Data di Nascita', datiDomanda.legaleRappresentante.dataNascita);
        addField('Residenza', datiDomanda.legaleRappresentante.residenza);
        yPos += 3;
        
        addSubHeader('REQUISITI DI AMMISSIBILITÀ');
        const requisiti = [
            ['DURC Regolare', document.getElementById('checkDURC')?.checked],
            ['Antimafia', document.getElementById('checkAntimafia')?.checked],
            ['Assenza Revoche', document.getElementById('checkRevoche')?.checked],
            ['Progetto Diverso', document.getElementById('checkProgettoDiverso')?.checked]
        ];
        requisiti.forEach(([label, checked]) => {
            checkPageBreak();
            doc.text(`${checked ? '☑' : '☐'} ${label}`, leftMargin + 3, yPos);
            yPos += lineHeight;
        });
        
        // ==========================================
        // FASE 2: CALCOLO MOL
        // ==========================================
        doc.addPage();
        yPos = 20;
        addSectionHeader('FASE 2: DICHIARAZIONE MOL E INDICATORE ORDINATORE');
        
        addSubHeader('PERIODO DI RIFERIMENTO');
        addField('Anno di Riferimento Bilancio', datiDomanda.economia.annoRiferimento);
        addField('Tipo di Documento', datiDomanda.economia.tipoDocumento);
        yPos += 3;
        
        addSubHeader('COMPONENTI MOL');
        doc.autoTable({
            startY: yPos,
            head: [['Voce', 'Importo €']],
            body: [
                ['A) Valore della Produzione', formatEuro(datiDomanda.economia.valoreProduzione || 0)],
                ['B) Materie Prime', formatEuro(datiDomanda.economia.materiePrime || 0)],
                ['C) Costi Servizi', formatEuro(datiDomanda.economia.costiServizi || 0)],
                ['D) Godimento Beni Terzi', formatEuro(datiDomanda.economia.costiBeniTerzi || 0)],
                ['E) Spese Personale', formatEuro(datiDomanda.economia.spesePersonale || 0)],
                ['F) Variazioni Rimanenze', formatEuro(datiDomanda.economia.variazioniRimanenze || 0)],
                ['G) Oneri Diversi', formatEuro(datiDomanda.economia.oneriDiversi || 0)],
                ['Ammortamenti (info)', formatEuro(datiDomanda.economia.ammortamenti || 0)],
                ['MOL CALCOLATO', formatEuro(datiDomanda.economia.mol || 0)]
            ],
            theme: 'grid',
            headStyles: { fillColor: [0, 102, 204], fontSize: 9 },
            styles: { fontSize: 8 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        addSubHeader('COSTO DEL PROGETTO');
        checkPageBreak(30);
        doc.autoTable({
            startY: yPos,
            head: [['Parametro', 'Valore']],
            body: [
                ['Costo Totale Ammissibile', formatEuro(datiDomanda.economia.costoTotale || 0)],
                ['Massimale Dimensione', formatEuro(datiDomanda.economia.massimale || 0)],
                ['Contributo Richiesto (80%)', formatEuro(datiDomanda.economia.contributoRichiesto || 0)],
                ['Cofinanziamento (20%)', formatEuro((datiDomanda.economia.costoTotale || 0) * 0.20)]
            ],
            theme: 'grid',
            headStyles: { fillColor: [40, 167, 69], fontSize: 9 },
            styles: { fontSize: 8 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        addSubHeader('INDICATORE ORDINATORE (Criterio Graduatoria)');
        addField('MOL / Costo Investimento', datiDomanda.economia.indicatoreOrdinatore || 'N/D');
        addField('Posizionamento Stimato', datiDomanda.economia.posizionamento || 'N/D');
        yPos += 3;
        
        addSubHeader('MODALITÀ DI EROGAZIONE');
        addField('Modalità Erogazione', datiDomanda.economia.modalitaErogazione === 'sal' ? 'Stati di Avanzamento Lavori (SAL)' : 'A Saldo');
        addField('Richiesta Anticipo 40%', datiDomanda.economia.richiestaAnticipo === 'si' ? 'SÌ (con fideiussione)' : 'NO');
        yPos += 3;
        
        addSubHeader('CAPACITÀ FINANZIARIA (Allegato C)');
        addField('Disponibilità Finanziaria Certificata', formatEuro(datiDomanda.economia.disponibilitaFinanziaria || 0));
        addField('Capacità Minima Richiesta (30%)', formatEuro((datiDomanda.economia.costoTotale || 0) * 0.30));
        const conforme = (datiDomanda.economia.disponibilitaFinanziaria || 0) >= ((datiDomanda.economia.costoTotale || 0) * 0.30);
        addField('Esito Verifica', conforme ? '✓ CONFORME' : '✗ NON CONFORME');
        yPos += 3;
        
        addSubHeader('PROFESSIONISTA ASSEVERANTE');
        const tipoProf = {
            'commercialista': 'Dottore Commercialista',
            'revisore': 'Revisore Legale dei Conti',
            'caf': 'Centro di Assistenza Fiscale (CAF)'
        };
        addField('Tipologia', tipoProf[datiDomanda.economia.tipoProfessionista] || datiDomanda.economia.tipoProfessionista);
        addField('Nome/Denominazione', datiDomanda.economia.nomeProfessionista);
        addField('Codice Fiscale', datiDomanda.economia.cfProfessionista);
        addField('N. Iscrizione Albo', datiDomanda.economia.iscrizioneAlbo);
        addField('Sede', datiDomanda.economia.sedeProfessionista);
        
        // ==========================================
        // FASE 3: PREVENTIVI
        // ==========================================
        doc.addPage();
        yPos = 20;
        addSectionHeader('FASE 3: PREVENTIVI E FORNITORI QUALIFICATI');
        
        if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
            const tipologieNomi = {
                'lett_a': 'a) Consulenza per diagnosi digitale',
                'lett_b': 'b) Consulenza specialistica (S3)',
                'lett_c': 'c) Tecnologie base',
                'lett_d': 'd) Tecnologie evolute (S3)',
                'lett_e': 'e) Software standard'
            };
            
            const tableData = datiDomanda.preventivi.map((p, idx) => [
                idx + 1,
                (tipologieNomi[p.tipologia] || p.tipologia).substring(0, 25),
                p.descrizione.substring(0, 35) + (p.descrizione.length > 35 ? '...' : ''),
                p.fornitore.substring(0, 25),
                formatEuro(p.importo)
            ]);
            
            tableData.push(['', '', '', 'TOTALE', formatEuro(datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0))]);
            
            doc.autoTable({
                startY: yPos,
                head: [['N.', 'Tipologia', 'Descrizione', 'Fornitore', 'Importo']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [0, 102, 204], fontSize: 8 },
                styles: { fontSize: 7 },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 50 },
                    3: { cellWidth: 40 },
                    4: { cellWidth: 30, halign: 'right' }
                }
            });
            yPos = doc.lastAutoTable.finalY + 8;
            
            // Riepilogo per tipologia
            addSubHeader('RIEPILOGO PER TIPOLOGIA');
            const totaliPerTipologia = {};
            datiDomanda.preventivi.forEach(p => {
                totaliPerTipologia[p.tipologia] = (totaliPerTipologia[p.tipologia] || 0) + p.importo;
            });
            
            Object.keys(totaliPerTipologia).forEach(tip => {
                addField(tipologieNomi[tip] || tip, formatEuro(totaliPerTipologia[tip]), 3);
            });
        } else {
            doc.text('Nessun preventivo inserito', leftMargin, yPos);
            yPos += 10;
        }
        
        // ==========================================
        // FASE 4: ISTANZA 2.1
        // ==========================================
        doc.addPage();
        yPos = 20;
        addSectionHeader('FASE 4: ALLEGATO 2.1 - ISTANZA DI FINANZIAMENTO');
        
        addSubHeader('RIEPILOGO DOMANDA');
        addField('Titolo Progetto', document.getElementById('titoloProgettoIstanza')?.value);
        addField('Impresa', datiDomanda.impresa.ragioneSociale);
        addField('P.IVA', datiDomanda.impresa.partitaIva);
        yPos += 3;
        
        addSubHeader('DICHIARAZIONI SOSTITUTIVE (Art. 47 D.P.R. 445/2000)');
        const dichiarazioni = [
            ['a) DURC Regolare', document.getElementById('dichA')?.checked],
            ['b) Normativa Antimafia', document.getElementById('dichB')?.checked],
            ['c) Capacità Economico-Finanziaria', document.getElementById('dichC')?.checked],
            ['d) Assenza Revoche', document.getElementById('dichD')?.checked],
            ['e) Progetto Diverso Azione 1.1.2', document.getElementById('dichE')?.checked],
            ['f) Veridicità Dati', document.getElementById('dichF')?.checked],
            ['g) Normativa Ambientale e Sicurezza', document.getElementById('dichG')?.checked],
            ['h) Assenza Cause Ostative', document.getElementById('dichH')?.checked],
            ['i) Informativa Privacy (GDPR)', document.getElementById('dichI')?.checked],
            ['l) Impegno Comunicazioni', document.getElementById('dichL')?.checked]
        ];
        
        dichiarazioni.forEach(([label, checked]) => {
            checkPageBreak();
            doc.text(`${checked ? '☑' : '☐'} ${label}`, leftMargin + 3, yPos);
            yPos += lineHeight;
        });
        yPos += 3;
        
        addSubHeader('DIMENSIONE AZIENDALE (Reg. CE 651/2014)');
        checkPageBreak(40);
        doc.autoTable({
            startY: yPos,
            head: [['Categoria', 'N. Occupati (ULA)', 'Fatturato (M€)', 'Totale Bilancio (M€)']],
            body: [
                ['Impresa Dichiarante', getValoreNumerico('ula_dichiarante'), getValoreNumerico('fatturato_dichiarante'), getValoreNumerico('bilancio_dichiarante')],
                ['Imprese Associate', getValoreNumerico('ula_associate'), getValoreNumerico('fatturato_associate'), getValoreNumerico('bilancio_associate')],
                ['Imprese Collegate', getValoreNumerico('ula_collegate'), getValoreNumerico('fatturato_collegate'), getValoreNumerico('bilancio_collegate')],
                ['TOTALE', document.getElementById('ula_totale')?.textContent || '0', document.getElementById('fatturato_totale')?.textContent || '0', document.getElementById('bilancio_totale')?.textContent || '0']
            ],
            theme: 'grid',
            headStyles: { fillColor: [0, 102, 204], fontSize: 8 },
            styles: { fontSize: 8 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        addSubHeader('CLASSIFICAZIONE IMPRESA');
        const tipoImpresa = {
            'autonoma': 'Impresa AUTONOMA',
            'associata': 'Impresa ASSOCIATA',
            'collegata': 'Impresa COLLEGATA',
            'grande': 'Grande Impresa (non PMI)'
        };
        addField('Tipo di Impresa', tipoImpresa[document.getElementById('tipoImpresa')?.value] || 'N/D');
        yPos += 3;
        
        addSubHeader('REGIME DE MINIMIS (Reg. UE 2023/2831)');
        addField('Ha già beneficiato di aiuti De Minimis?', document.getElementById('haDeMinimis')?.value?.toUpperCase() || 'N/D');
        
        if (document.getElementById('haDeMinimis')?.value === 'si') {
            yPos += 2;
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.text('Dettaglio aiuti De Minimis ricevuti (vedere tabella allegato 2.1)', leftMargin + 3, yPos);
            yPos += 6;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
        }
        
        addField('Fusioni/Acquisizioni negli ultimi 3 anni', document.getElementById('fusioni')?.value?.toUpperCase() || 'N/D');
        yPos += 3;
        
        addSubHeader('MARCA DA BOLLO');
        addField('Numero Identificativo', document.getElementById('numeroMarcaBollo')?.value || 'N/D');
        addField('Data Marca da Bollo', document.getElementById('dataMarcaBollo')?.value || 'N/D');
        addField('Importo', '€ 16,00');
        
        // ==========================================
        // FASE 5: FORMULARIO - SEZIONE A
        // ==========================================
        doc.addPage();
        yPos = 20;
        addSectionHeader('FASE 5: FORMULARIO PROPOSTA PROGETTUALE (Allegato F)');
        
        addSubHeader('A. INFORMAZIONI GENERALI');
        addField('A.1 Titolo progetto', document.getElementById('titoloProgetto')?.value);
        addField('A.2 Acronimo del progetto', document.getElementById('acronimoProgetto')?.value);
        addField('A.3 Durata (mesi)', document.getElementById('durataProgetto')?.value);
        addField('A.4 Costo totale ammissibile', formatEuro(datiDomanda.economia.costoTotale || 0));
        addField('A.5 Contributo richiesto', formatEuro(datiDomanda.economia.contributoRichiesto || 0));
        addField('A.6 Soggetto proponente', datiDomanda.impresa.ragioneSociale);
        addLongText('A.7 Breve presentazione: mission e attività', document.getElementById('missionAttivita')?.value);
        
        // SEZIONE B
        addSubHeader('B. DESCRIZIONE DEL SOGGETTO PROPONENTE');
        addLongText('B.1 Attività economica svolta e profili di innovazione', document.getElementById('attivitaEconomica')?.value);
        addLongText('B.2 Posizionamento competitivo', document.getElementById('posizionamentoCompetitivo')?.value);
        
        // SEZIONE C
        doc.addPage();
        yPos = 20;
        addSubHeader('C. FABBISOGNI DI INNOVAZIONE IN RELAZIONE AI TREND SETTORIALI');
        addLongText('C.1 Contestualizzazione dei fabbisogni di innovazione', document.getElementById('contestualizzazioneFabbisogni')?.value);
        addLongText('C.2 Descrizione degli obiettivi perseguiti', document.getElementById('obiettiviPerseguiti')?.value);
        
        // SEZIONE D
        addSubHeader('D. CAPACITÀ AMMINISTRATIVA ED OPERATIVA');
        addLongText('D.1 Capacità amministrativa ed operativa', document.getElementById('capacitaAmministrativa')?.value);
        addLongText('D.2 Figure professionali chiave - Gruppo di lavoro', document.getElementById('gruppoDiLavoro')?.value);
        
        // SEZIONE E
        doc.addPage();
        yPos = 20;
        addSubHeader('E. DESCRIZIONE DEL PROGETTO E IMPLEMENTAZIONE SOLUZIONI DIGITALI');
        addLongText('E.1.i Obiettivi generali e specifici', document.getElementById('obiettiviGeneraliSpecifici')?.value);
        addLongText('E.1.ii Quadro logico (relazione obiettivi-azioni)', document.getElementById('quadroLogico')?.value);
        addLongText('E.1.iii Descrizione dettagliata implementazione innovazioni', document.getElementById('implementazioneInnovazioni')?.value);
        addLongText('E.1.iv Modalità di coinvolgimento utilizzatori finali', document.getElementById('coinvolgimentoUtilizzatori')?.value);
        
        // Piano di lavoro
        doc.addPage();
        yPos = 20;
        addSubHeader('E.1.v PIANO DI LAVORO - MATRICE WP');
        addLongText('', document.getElementById('matriceWP')?.value);
        
        addSubHeader('E.1.v CRONOPROGRAMMA (M1-M12)');
        addLongText('', document.getElementById('cronoprogramma')?.value);
        
        // SEZIONE F
        doc.addPage();
        yPos = 20;
        addSubHeader('F. GESTIONE DEL MONITORAGGIO, KPI E VALUTAZIONE');
        addLongText('F.1 Sistema di monitoraggio', document.getElementById('sistemaMonitoraggio')?.value);
        addLongText('F.2 Valutazione impatto a lungo termine', document.getElementById('valutazioneImpatto')?.value);
        
        // SEZIONE G
        addSubHeader('G. CRITERI PREMIALI');
        addLongText('G.1 Ricadute occupazionali femminili e/o giovanili', document.getElementById('ricaduteOccupazionali')?.value);
        addField('G.5 Quota investimento tecnologie abilitanti S3', formatEuro(getValoreNumerico('quotaTecnologieAbilitanti')));
        addField('G.5 Percentuale sul totale', document.getElementById('percentualeTecnologieS3')?.value || 'N/D');
        
        // SEZIONE H - BUDGET
        doc.addPage();
        yPos = 20;
        addSubHeader('H. BUDGET E PIANO FINANZIARIO');
        
        addLongText('H.1 Giustificazione delle spese', document.getElementById('giustificazioneSpese')?.value);
        
        // H.2 Piano Coperture
        addSubHeader('H.2 PIANO DELLE COPERTURE FINANZIARIE');
        checkPageBreak(80);
        doc.autoTable({
            startY: yPos,
            head: [['Prospetto Impieghi/Fonti', 'Anno 1 €', 'Totale €']],
            body: [
                ['IMPIEGHI'],
                ['• Investimenti immateriali', formatEuro(getValoreNumerico('h2_inv_immat_anno1')), formatEuro(getValoreNumerico('h2_inv_immat_tot'))],
                ['• Investimenti materiali', formatEuro(getValoreNumerico('h2_inv_mat_anno1')), formatEuro(getValoreNumerico('h2_inv_mat_tot'))],
                ['• IVA', formatEuro(getValoreNumerico('h2_iva_anno1')), formatEuro(getValoreNumerico('h2_iva_tot'))],
                ['TOTALE IMPIEGHI', '', document.getElementById('h2_tot_impieghi_tot')?.textContent || '€ 0,00'],
                [''],
                ['FONTI'],
                ['Contributo pubblico', formatEuro(getValoreNumerico('h2_contributo_anno1')), document.getElementById('h2_contributo_tot')?.value || '€ 0,00'],
                ['Cofinanziamento proprio:'],
                ['• Capitale Sociale', formatEuro(getValoreNumerico('h2_cap_sociale_anno1')), formatEuro(getValoreNumerico('h2_cap_sociale_tot'))],
                ['• Riserve', formatEuro(getValoreNumerico('h2_riserve_anno1')), formatEuro(getValoreNumerico('h2_riserve_tot'))],
                ['• Finanz. m/l termine', formatEuro(getValoreNumerico('h2_finanz_ml_anno1')), formatEuro(getValoreNumerico('h2_finanz_ml_tot'))],
                ['TOTALE FONTI', '', document.getElementById('h2_tot_fonti_tot')?.textContent || '€ 0,00']
            ],
            theme: 'grid',
            headStyles: { fillColor: [0, 102, 204], fontSize: 8 },
            styles: { fontSize: 7 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        // H.3 Conto Economico
        doc.addPage();
        yPos = 20;
        addSubHeader('H.3 STRATEGIA DI SOSTENIBILITÀ ECONOMICO-FINANZIARIA');
        addLongText('Descrizione strategia', document.getElementById('strategiaSostenibilita')?.value);
        
        addSubHeader('CONTO ECONOMICO PREVISIONALE');
        checkPageBreak(100);
        doc.autoTable({
            startY: yPos,
            head: [['Voce', '2023', '2024', 'n+1', 'n+2', 'n+3']],
            body: [
                ['Fatturato', 
                    formatEuro(getValoreNumerico('h3_fatt_2023')),
                    formatEuro(getValoreNumerico('h3_fatt_2024')),
                    formatEuro(getValoreNumerico('h3_fatt_n1')),
                    formatEuro(getValoreNumerico('h3_fatt_n2')),
                    formatEuro(getValoreNumerico('h3_fatt_n3'))
                ],
                ['MOL',
                    formatEuro(parseFloat(document.getElementById('h3_mol_2023')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_mol_2024')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_mol_n1')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_mol_n2')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_mol_n3')?.dataset?.value || 0))
                ],
                ['Risultato Netto',
                    formatEuro(parseFloat(document.getElementById('h3_rn_2023')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_rn_2024')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_rn_n1')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_rn_n2')?.dataset?.value || 0)),
                    formatEuro(parseFloat(document.getElementById('h3_rn_n3')?.dataset?.value || 0))
                ]
            ],
            theme: 'grid',
            headStyles: { fillColor: [0, 102, 204], fontSize: 7 },
            styles: { fontSize: 7 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        // H.4 Indici
        addSubHeader('H.4 ANALISI PER INDICI');
        checkPageBreak(30);
        doc.autoTable({
            startY: yPos,
            head: [['Indicatore', '2023', '2024', 'n+1', 'n+2', 'n+3']],
            body: [
                ['ROI', 
                    document.getElementById('h4_roi_2023')?.value || '',
                    document.getElementById('h4_roi_2024')?.value || '',
                    document.getElementById('h4_roi_n1')?.value || '',
                    document.getElementById('h4_roi_n2')?.value || '',
                    document.getElementById('h4_roi_n3')?.value || ''
                ],
                ['Margine %',
                    document.getElementById('h4_marg_2023')?.value || '',
                    document.getElementById('h4_marg_2024')?.value || '',
                    document.getElementById('h4_marg_n1')?.value || '',
                    document.getElementById('h4_marg_n2')?.value || '',
                    document.getElementById('h4_marg_n3')?.value || ''
                ]
            ],
            theme: 'grid',
            headStyles: { fillColor: [0, 102, 204], fontSize: 7 },
            styles: { fontSize: 7 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        addLongText('H.5 Analisi costi-benefici', document.getElementById('h5_costibenefici')?.value);
        
        addSubHeader('H.6 PIANO OCCUPAZIONALE');
        checkPageBreak(30);
        doc.autoTable({
            startY: yPos,
            head: [['Qualifica', 'ULA 2024', 'ULA previste', 'Variazione']],
            body: [
                ['Dirigenti', getValoreNumerico('h6_dir_2024'), getValoreNumerico('h6_dir_prev'), document.getElementById('h6_dir_var')?.value || ''],
                ['Quadri', getValoreNumerico('h6_quad_2024'), getValoreNumerico('h6_quad_prev'), document.getElementById('h6_quad_var')?.value || ''],
                ['Impiegati', getValoreNumerico('h6_imp_2024'), getValoreNumerico('h6_imp_prev'), document.getElementById('h6_imp_var')?.value || ''],
                ['Operai', getValoreNumerico('h6_op_2024'), getValoreNumerico('h6_op_prev'), document.getElementById('h6_op_var')?.value || '']
            ],
            theme: 'grid',
            headStyles: { fillColor: [0, 102, 204], fontSize: 8 },
            styles: { fontSize: 8 }
        });
        yPos = doc.lastAutoTable.finalY + 8;
        
        addLongText('H.7 Piano gestione rischi finanziari', document.getElementById('h7_rischi')?.value);
        addLongText('H.8 Strategia ottimizzazione costi', document.getElementById('h8_ottimizzazione')?.value);
        
        // ==========================================
        // FASE 6: CHECKLIST
        // ==========================================
        doc.addPage();
        yPos = 20;
        addSectionHeader('FASE 6: CHECKLIST DOCUMENTALE');
        
        if (datiDomanda.checklist && datiDomanda.checklist.length > 0) {
            const obbligatori = datiDomanda.checklist.filter(d => d.obbligatorio);
            const completati = obbligatori.filter(d => d.completato).length;
            
            doc.setFont(undefined, 'bold');
            doc.text(`Stato Completamento: ${completati}/${obbligatori.length} documenti obbligatori verificati`, leftMargin, yPos);
            yPos += 10;
            
            datiDomanda.checklist.forEach(doc_item => {
                checkPageBreak(10);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                const symbol = doc_item.completato ? '☑' : '☐';
                const obbl = doc_item.obbligatorio ? ' [OBBLIGATORIO]' : ' [Facoltativo]';
                const text = `${symbol} ${doc_item.nome}${obbl}`;
                const lines = doc.splitTextToSize(text, rightMargin - leftMargin - 5);
                doc.text(lines, leftMargin, yPos);
                yPos += lines.length * 5 + 2;
                doc.setFontSize(9);
            });
        }
        
        // ==========================================
        // FOOTER SU TUTTE LE PAGINE
        // ==========================================
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(7);
            doc.setTextColor(128);
            doc.text(`Domanda ${codiceId} - Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
            if (i > 1) {
                doc.text(datiDomanda.impresa.ragioneSociale || '', 105, 285, { align: 'center' });
            }
        }
        
        // ==========================================
        // SALVA FILE
        // ==========================================
        const filename = `DIGIT_IMPRESE_${codiceId}_${datiDomanda.impresa.partitaIva || 'PIVA'}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        
        console.log('✅ PDF completo esportato:', filename);
        return filename;
        
    } catch (error) {
        console.error('ERRORE export PDF:', error);
        alert('❌ Errore nell\'export PDF: ' + error.message);
        return null;
    }
}
// ============================================
// GENERA CODICE IDENTIFICATIVO
// ============================================

function generaCodiceIdentificativo() {
    const piva = datiDomanda.impresa.partitaIva || '00000000000';
    const anno = new Date().getFullYear();
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    
    return `DIG-${anno}-${piva.slice(-4)}-${timestamp}-${random}`;
}

// ============================================
// STAMPA ISTANZA 2.1
// ============================================

function stampaIstanza() {
    try {
        // Crea finestra di stampa con contenuto formattato
        const printWindow = window.open('', '_blank');
        
        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Allegato 2.1 - Istanza di Finanziamento</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; font-size: 12pt; }
                    h1 { text-align: center; color: #0066cc; border-bottom: 3px solid #0066cc; padding-bottom: 10px; }
                    h2 { color: #0066cc; margin-top: 30px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background-color: #0066cc; color: white; font-weight: bold; }
                    .section { margin: 30px 0; }
                    .label { font-weight: bold; }
                    .value { margin-left: 20px; }
                    @media print {
                        body { margin: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <button class="no-print" onclick="window.print()" style="position: fixed; top: 10px; right: 10px; padding: 10px 20px; background: #0066cc; color: white; border: none; cursor: pointer;">
                    Stampa
                </button>
                
                <h1>ALLEGATO 2.1<br>ISTANZA DI FINANZIAMENTO<br>DIGIT IMPRESE - FSC Sicilia 2021-2027</h1>
                
                <div class="section">
                    <h2>DATI IMPRESA</h2>
                    <p><span class="label">Ragione Sociale:</span> <span class="value">${datiDomanda.impresa.ragioneSociale || 'N/D'}</span></p>
                    <p><span class="label">Sede Legale:</span> <span class="value">${datiDomanda.impresa.sedeLegale || 'N/D'}</span></p>
                    <p><span class="label">Partita IVA:</span> <span class="value">${datiDomanda.impresa.partitaIva || 'N/D'}</span></p>
                    <p><span class="label">Codice Fiscale:</span> <span class="value">${datiDomanda.impresa.codiceFiscale || 'N/D'}</span></p>
                    <p><span class="label">PEC:</span> <span class="value">${datiDomanda.impresa.pec || 'N/D'}</span></p>
                </div>
                
                <div class="section">
                    <h2>LEGALE RAPPRESENTANTE</h2>
                    <p><span class="label">Nome e Cognome:</span> <span class="value">${datiDomanda.legaleRappresentante.nome || ''} ${datiDomanda.legaleRappresentante.cognome || ''}</span></p>
                    <p><span class="label">Codice Fiscale:</span> <span class="value">${datiDomanda.legaleRappresentante.codiceFiscale || 'N/D'}</span></p>
                    <p><span class="label">Nato a:</span> <span class="value">${datiDomanda.legaleRappresentante.luogoNascita || 'N/D'} il ${datiDomanda.legaleRappresentante.dataNascita || 'N/D'}</span></p>
                    <p><span class="label">Residente in:</span> <span class="value">${datiDomanda.legaleRappresentante.residenza || 'N/D'}</span></p>
                </div>
                
                <div class="section">
                    <h2>CHIEDE</h2>
                    <p>Di essere ammesso alle agevolazioni previste dall'Avviso DIGIT IMPRESE per la realizzazione del seguente programma di investimento:</p>
                    <p><span class="label">Titolo Progetto:</span> <span class="value">${document.getElementById('titoloProgettoIstanza')?.value || 'N/D'}</span></p>
                    <table>
                        <tr>
                            <th>Costo Totale Ammissibile</th>
                            <td>${formatEuro(datiDomanda.economia.costoTotale || 0)}</td>
                        </tr>
                        <tr>
                            <th>Contributo Richiesto (80%)</th>
                            <td>${formatEuro(datiDomanda.economia.contributoRichiesto || 0)}</td>
                        </tr>
                        <tr>
                            <th>Cofinanziamento (20%)</th>
                            <td>${formatEuro((datiDomanda.economia.costoTotale || 0) * 0.20)}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="section">
                    <h2>PREVENTIVI DI SPESA</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Tipologia</th>
                                <th>Descrizione</th>
                                <th>Fornitore</th>
                                <th>Importo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${datiDomanda.preventivi.map(p => `
                                <tr>
                                    <td>${p.tipologia}</td>
                                    <td>${p.descrizione}</td>
                                    <td>${p.fornitore}</td>
                                    <td>${formatEuro(p.importo)}</td>
                                </tr>
                            `).join('')}
                            <tr style="font-weight: bold; background-color: #f0f0f0;">
                                <td colspan="3">TOTALE</td>
                                <td>${formatEuro(datiDomanda.preventivi.reduce((sum, p) => sum + p.importo, 0))}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>DICHIARAZIONI</h2>
                    <p>Il sottoscritto dichiara ai sensi degli artt. 46 e 47 del D.P.R. 445/2000, consapevole delle responsabilità penali previste dall'art. 76:</p>
                    <ul>
                        <li>Di essere in regola con gli obblighi relativi al pagamento dei contributi previdenziali e assistenziali;</li>
                        <li>Di non trovarsi in alcuna delle cause di decadenza, sospensione o divieto previste dall'art. 67 del D.Lgs 159/2011;</li>
                        <li>Di possedere la capacità economico-finanziaria documentata mediante Allegato C;</li>
                        <li>Di non essere destinatario di provvedimenti di revoca nei 3 anni precedenti;</li>
                        <li>Che il programma di investimento è diverso da quelli finanziati nell'ambito dell'Azione 1.1.2;</li>
                        <li>Che i dati forniti corrispondono al vero.</li>
                    </ul>
                </div>
                
                <div class="section" style="margin-top: 80px;">
                    <p>Data: ________________</p>
                    <br><br>
                    <p>Firma digitale del Legale Rappresentante</p>
                    <p>_______________________________</p>
                </div>
                
                <div class="section">
                    <p style="font-size: 10pt; color: #666;">
                        <strong>Marca da bollo:</strong> € 16,00<br>
                        <strong>Numero identificativo:</strong> ${document.getElementById('numeroMarcaBollo')?.value || '________________'}
                    </p>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(html);
        printWindow.document.close();
        
    } catch (error) {
        console.error('ERRORE stampa istanza:', error);
        alert('❌ Errore nella stampa: ' + error.message);
    }
}
        
        function finalizza() {
            const obbligatoriCompletati = datiDomanda.checklist
                .filter(d => d.obbligatorio)
                .every(d => d.completato);
            
            if (!obbligatoriCompletati) {
                alert('⚠️ Non tutti i documenti obbligatori sono stati verificati!');
                return;
            }
            
            alert('✅ Preparazione completata!\n\nIn bocca al lupo per la tua domanda DIGIT IMPRESE! 🚀');
        }
        
        // ============================================
        // STORAGE LOCALE
        // ============================================
        
        function salvaLocalmente() {
            try {
                localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
                console.log('💾 Dati salvati in localStorage');
            } catch (error) {
                console.error('❌ Errore salvataggio:', error);
            }
        }
        
        function caricaDatiSalvati() {
            const saved = localStorage.getItem('digitImpreseDomanda');
            if (saved) {
                console.log('💾 Dati salvati trovati (non ripristinati automaticamente)');
            }
        }
        
        function popolaCampiDaSalvataggio() {
            // Popola Fase 1
            if (datiDomanda.impresa) {
                Object.keys(datiDomanda.impresa).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) element.value = datiDomanda.impresa[key];
                });
            }
            
            if (datiDomanda.legaleRappresentante) {
                document.getElementById('lrNome').value = datiDomanda.legaleRappresentante.nome || '';
                document.getElementById('lrCognome').value = datiDomanda.legaleRappresentante.cognome || '';
                document.getElementById('lrCF').value = datiDomanda.legaleRappresentante.codiceFiscale || '';
                document.getElementById('lrLuogoNascita').value = datiDomanda.legaleRappresentante.luogoNascita || '';
                document.getElementById('lrDataNascita').value = datiDomanda.legaleRappresentante.dataNascita || '';
                document.getElementById('lrResidenza').value = datiDomanda.legaleRappresentante.residenza || '';
            }
            
            // Popola Preventivi
            if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
                mostraPreventivi();
            }
        }
        
        function salvaAutomaticamente() {
            salvaDatiFase(currentStep);
            console.log('💾 Auto-save:', new Date().toLocaleTimeString());
        }

        // ============================================
// FUNZIONE GENERAZIONE AUTOMATICA WP/CRONOPROGRAMMA
// ============================================

function compilaAutomaticaWP() {
    if (!datiDomanda.preventivi || datiDomanda.preventivi.length === 0) {
        alert('⚠️ Inserire prima i preventivi nella Fase 3!');
        return;
    }
    
    const durata = parseInt(document.getElementById('durataProgetto')?.value) || 12;
    
    const conferma = confirm(
        '🎯 COMPILAZIONE AUTOMATICA PIANO DI LAVORO\n\n' +
        'Il sistema genererà:\n' +
        '• Work Packages (WP) basati sui preventivi\n' +
        '• Cronoprogramma distribuito su ' + durata + ' mesi\n' +
        '• Deliverable e milestone\n' +
        '• KPI di realizzazione\n\n' +
        'Procedere?'
    );
    
    if (!conferma) return;
    
    // Analizza preventivi
    const tipologiePresenti = {};
    datiDomanda.preventivi.forEach(p => {
        if (!tipologiePresenti[p.tipologia]) {
            tipologiePresenti[p.tipologia] = [];
        }
        tipologiePresenti[p.tipologia].push(p);
    });
    
    // GENERA MATRICE WP
    let matriceWP = 'OBIETTIVO GENERALE | OBIETTIVO SPECIFICO | WP | AZIONI/TASK | DELIVERABLE | OUTPUT/RISULTATI | BUDGET | KPI\n\n';
    
    matriceWP += 'OG1: Digitalizzazione e innovazione tecnologica dell\'impresa | ';
    
    // WP0: Diagnosi
    matriceWP += 'OS0: Analizzare lo stato digitale attuale | WP0: Diagnosi Digitale | ';
    matriceWP += 'A0.1: Analisi AS-IS e gap analysis | D0.1: Report diagnosi digitale ex-ante | ';
    matriceWP += 'R0.1: Livello maturità digitale definito | € 1.500 | KPI0: Diagnosi completata\n\n';
    
    // WP per consulenze
    if (tipologiePresenti['lett_a'] || tipologiePresenti['lett_b']) {
        const budgetConsulenza = (tipologiePresenti['lett_a'] || [])
            .concat(tipologiePresenti['lett_b'] || [])
            .reduce((sum, p) => sum + p.importo, 0);
        
        matriceWP += 'OS1: Progettare soluzioni digitali innovative | WP1: Consulenza Strategica | ';
        matriceWP += 'A1.1: Definizione requisiti, A1.2: Design soluzioni, A1.3: Piano implementazione | ';
        matriceWP += 'D1.1: Documento requisiti, D1.2: Architettura soluzioni, D1.3: Roadmap | ';
        matriceWP += 'R1.1: Soluzioni progettate e validate | € ' + budgetConsulenza.toFixed(2) + ' | ';
        matriceWP += 'KPI1: 100% requisiti definiti\n\n';
    }
    
    // WP per tecnologie
    if (tipologiePresenti['lett_c'] || tipologiePresenti['lett_d'] || tipologiePresenti['lett_e']) {
        const budgetTecnologie = (tipologiePresenti['lett_c'] || [])
            .concat(tipologiePresenti['lett_d'] || [])
            .concat(tipologiePresenti['lett_e'] || [])
            .reduce((sum, p) => sum + p.importo, 0);
        
        matriceWP += 'OS2: Implementare tecnologie digitali | WP2: Acquisizione e Implementazione Tecnologie | ';
        matriceWP += 'A2.1: Selezione fornitori, A2.2: Acquisizione, A2.3: Installazione, A2.4: Integrazione | ';
        matriceWP += 'D2.1: Contratti, D2.2: Tecnologie acquisite, D2.3: Sistemi operativi, D2.4: Test integrazione | ';
        matriceWP += 'R2.1: Tecnologie operative e integrate | € ' + budgetTecnologie.toFixed(2) + ' | ';
        matriceWP += 'KPI2: 100% tecnologie installate\n\n';
    }
    
    // WP3: Formazione
    matriceWP += 'OS3: Formare il personale | WP3: Formazione e Change Management | ';
    matriceWP += 'A3.1: Analisi fabbisogni, A3.2: Progettazione corso, A3.3: Erogazione formazione | ';
    matriceWP += 'D3.1: Piano formativo, D3.2: Materiali didattici, D3.3: Attestati | ';
    matriceWP += 'R3.1: Personale formato | € 3.000 | KPI3: ≥80% dipendenti formati\n\n';
    
    // WP4: Go-Live
    matriceWP += 'OS4: Mettere in produzione | WP4: Test, Collaudo e Go-Live | ';
    matriceWP += 'A4.1: Test funzionali, A4.2: UAT, A4.3: Go-Live, A4.4: Supporto post go-live | ';
    matriceWP += 'D4.1: Report test, D4.2: Verbali collaudo, D4.3: Sistemi in produzione, D4.4: Manuale utente | ';
    matriceWP += 'R4.1: Sistemi operativi a regime | € 2.000 | KPI4: Uptime >95%\n\n';
    
    // WP5: Monitoraggio
    matriceWP += 'OS5: Monitorare risultati | WP5: Monitoraggio e Valutazione | ';
    matriceWP += 'A5.1: Definizione KPI, A5.2: Raccolta dati, A5.3: Analisi performance, A5.4: Diagnosi ex-post | ';
    matriceWP += 'D5.1: Dashboard KPI, D5.2: Report mensili, D5.3: Diagnosi ex-post, D5.4: Report impatti | ';
    matriceWP += 'R5.1: Obiettivi raggiunti e misurati | € 1.500 | KPI5: 100% KPI monitorati';
    
    // GENERA CRONOPROGRAMMA
    let cronoprogramma = 'WP | TASK | M1 | M2 | M3 | M4 | M5 | M6 | M7 | M8 | M9 | M10 | M11 | M12 | MILESTONE\n\n';
    
    if (durata >= 12) {
        cronoprogramma += 'WP0 | Diagnosi | ■ | ■ | | | | | | | | | | | MS0: Diagnosi completata\n';
        cronoprogramma += 'WP1 | Consulenza | | ■ | ■ | ■ | | | | | | | | | MS1: Soluzioni progettate\n';
        cronoprogramma += 'WP2 | Tecnologie | | | | ■ | ■ | ■ | ■ | ■ | | | | | MS2: Tecnologie operative\n';
        cronoprogramma += 'WP3 | Formazione | | | | | | | | ■ | ■ | ■ | | | MS3: Personale formato\n';
        cronoprogramma += 'WP4 | Go-Live | | | | | | | | | | ■ | ■ | ■ | MS4: Sistemi in produzione\n';
        cronoprogramma += 'WP5 | Monitoraggio | | | | | | | | | | | ■ | ■ | MS5: Report finale\n\n';
    } else if (durata >= 6) {
        cronoprogramma += 'WP0 | Diagnosi | ■ | | | | | | MS0: Diagnosi completata\n';
        cronoprogramma += 'WP1 | Consulenza | | ■ | ■ | | | | MS1: Soluzioni progettate\n';
        cronoprogramma += 'WP2 | Tecnologie | | | ■ | ■ | | | MS2: Tecnologie operative\n';
        cronoprogramma += 'WP3 | Formazione | | | | ■ | | | MS3: Personale formato\n';
        cronoprogramma += 'WP4 | Go-Live | | | | | ■ | ■ | MS4: Sistemi in produzione\n';
        cronoprogramma += 'WP5 | Monitoraggio | | | | | | ■ | MS5: Report finale\n\n';
    }
    
    cronoprogramma += '\nLEGENDA MILESTONE:\n';
    cronoprogramma += 'MS0: Diagnosi digitale completata\n';
    cronoprogramma += 'MS1: Soluzioni progettate e requisiti validati\n';
    cronoprogramma += 'MS2: Tecnologie installate e operative\n';
    cronoprogramma += 'MS3: Almeno 80% personale formato\n';
    cronoprogramma += 'MS4: Sistemi in produzione (uptime >95%)\n';
    cronoprogramma += 'MS5: Report finale con diagnosi ex-post';
    
    // Compila i campi
    document.getElementById('matriceWP').value = matriceWP;
    document.getElementById('cronoprogramma').value = cronoprogramma;
    
    alert('✅ Piano di lavoro e cronoprogramma generati!\n\nPersonalizza i contenuti in base al tuo progetto.');
}

// ============================================
// FUNZIONI QUADRO H.2 - PIANO COPERTURE
// ============================================

function calcolaH2() {
    try {
        // IMPIEGHI
        const invImmatAnno1 = getValoreNumerico('h2_inv_immat_anno1');
        const invImmatTot = getValoreNumerico('h2_inv_immat_tot');
        const invMatAnno1 = getValoreNumerico('h2_inv_mat_anno1');
        const invMatTot = getValoreNumerico('h2_inv_mat_tot');
        const ivaAnno1 = getValoreNumerico('h2_iva_anno1');
        const ivaTot = getValoreNumerico('h2_iva_tot');
        
        const totImpieghiAnno1 = invImmatAnno1 + invMatAnno1 + ivaAnno1;
        const totImpieghiTot = invImmatTot + invMatTot + ivaTot;
        
        document.getElementById('h2_tot_impieghi_anno1').textContent = formatEuro(totImpieghiAnno1);
        document.getElementById('h2_tot_impieghi_tot').textContent = formatEuro(totImpieghiTot);
        
        // Percentuali IMPIEGHI
        if (totImpieghiTot > 0) {
            document.getElementById('h2_inv_immat_perc').value = ((invImmatTot / totImpieghiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_inv_mat_perc').value = ((invMatTot / totImpieghiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_iva_perc').value = ((ivaTot / totImpieghiTot) * 100).toFixed(2) + '%';
        }
        
        // FONTI
        const contributoAnno1 = getValoreNumerico('h2_contributo_anno1');
        const capSocialeAnno1 = getValoreNumerico('h2_cap_sociale_anno1');
        const capSocialeTot = getValoreNumerico('h2_cap_sociale_tot');
        const finanzSociAnno1 = getValoreNumerico('h2_finanz_soci_anno1');
        const finanzSociTot = getValoreNumerico('h2_finanz_soci_tot');
        const riserveAnno1 = getValoreNumerico('h2_riserve_anno1');
        const riserveTot = getValoreNumerico('h2_riserve_tot');
        const finanzMlAnno1 = getValoreNumerico('h2_finanz_ml_anno1');
        const finanzMlTot = getValoreNumerico('h2_finanz_ml_tot');
        const finanzBreveAnno1 = getValoreNumerico('h2_finanz_breve_anno1');
        const finanzBreveTot = getValoreNumerico('h2_finanz_breve_tot');
        
        const contributoTot = contributoAnno1;
        document.getElementById('h2_contributo_tot').value = formatEuro(contributoTot);
        
        const totFontiAnno1 = contributoAnno1 + capSocialeAnno1 + finanzSociAnno1 + riserveAnno1 + finanzMlAnno1 + finanzBreveAnno1;
        const totFontiTot = contributoTot + capSocialeTot + finanzSociTot + riserveTot + finanzMlTot + finanzBreveTot;
        
        document.getElementById('h2_tot_fonti_anno1').textContent = formatEuro(totFontiAnno1);
        document.getElementById('h2_tot_fonti_tot').textContent = formatEuro(totFontiTot);
        
        // Percentuali FONTI
        if (totFontiTot > 0) {
            document.getElementById('h2_contributo_perc').value = ((contributoTot / totFontiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_cap_sociale_perc').value = ((capSocialeTot / totFontiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_finanz_soci_perc').value = ((finanzSociTot / totFontiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_riserve_perc').value = ((riserveTot / totFontiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_finanz_ml_perc').value = ((finanzMlTot / totFontiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_finanz_breve_perc').value = ((finanzBreveTot / totFontiTot) * 100).toFixed(2) + '%';
            document.getElementById('h2_tot_fonti_perc').textContent = '100%';
        }
        
        // VERIFICA BILANCIAMENTO
        const diff = Math.abs(totImpieghiTot - totFontiTot);
        const alertDiv = document.getElementById('alertBilanciamentoH2');
        
        if (diff < 0.01) {
            alertDiv.innerHTML = `
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle"></i> <strong>✅ BILANCIAMENTO OK!</strong><br>
                    Impieghi = Fonti = ${formatEuro(totImpieghiTot)}
                </div>
            `;
        } else {
            const sbilanciamento = totImpieghiTot - totFontiTot;
            alertDiv.innerHTML = `
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-triangle"></i> <strong>⚠️ SBILANCIAMENTO!</strong><br>
                    Impieghi: ${formatEuro(totImpieghiTot)}<br>
                    Fonti: ${formatEuro(totFontiTot)}<br>
                    Differenza: ${formatEuro(Math.abs(sbilanciamento))} 
                    ${sbilanciamento > 0 ? '(Aggiungere fonti)' : '(Ridurre fonti)'}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Errore calcolaH2:', error);
    }
}

function precompilaDatiH2() {
    try {
        if (!datiDomanda || !datiDomanda.economia) {
            alert('⚠️ Completare prima la Fase 2!');
            return;
        }
        
        const costoTotale = datiDomanda.economia.costoTotale || 0;
        const contributo = datiDomanda.economia.contributoRichiesto || 0;
        const cofinanziamento = costoTotale - contributo;
        
        if (costoTotale === 0) {
            alert('⚠️ Costo totale non definito!');
            return;
        }
        
        // Suddividi impieghi
        let immateriali = 0;
        let materiali = 0;
        
        if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
            datiDomanda.preventivi.forEach(prev => {
                if (prev.tipologia === 'lett_a' || prev.tipologia === 'lett_b') {
                    immateriali += prev.importo;
                } else {
                    materiali += prev.importo;
                }
            });
        } else {
            materiali = costoTotale;
        }
        
        // Compila IMPIEGHI
        document.getElementById('h2_inv_immat_anno1').value = immateriali.toFixed(2);
        document.getElementById('h2_inv_immat_tot').value = immateriali.toFixed(2);
        document.getElementById('h2_inv_mat_anno1').value = materiali.toFixed(2);
        document.getElementById('h2_inv_mat_tot').value = materiali.toFixed(2);
        
        // Compila FONTI
        document.getElementById('h2_contributo_anno1').value = contributo.toFixed(2);
        document.getElementById('h2_riserve_anno1').value = cofinanziamento.toFixed(2);
        document.getElementById('h2_riserve_tot').value = cofinanziamento.toFixed(2);
        
        // Ricalcola
        calcolaH2();
        
        alert('✅ Dati H.2 pre-compilati!\n\n' +
              'Impieghi immateriali: ' + formatEuro(immateriali) + '\n' +
              'Impieghi materiali: ' + formatEuro(materiali) + '\n' +
              'Contributo: ' + formatEuro(contributo) + '\n' +
              'Riserve: ' + formatEuro(cofinanziamento));
        
    } catch (error) {
        console.error('Errore precompilaDatiH2:', error);
        alert('❌ Errore: ' + error.message);
    }
}

// ============================================
// FUNZIONI QUADRO H.3 - CONTO ECONOMICO
// ============================================

function calcolaH3() {
    try {
        const anni = ['2023', '2024', 'n1', 'n2', 'n3'];
        
        anni.forEach(anno => {
            const fatt = getValoreNumerico(`h3_fatt_${anno}`);
            const altri = getValoreNumerico(`h3_altri_${anno}`);
            const mp = getValoreNumerico(`h3_mp_${anno}`);
            const serv = getValoreNumerico(`h3_serv_${anno}`);
            const god = getValoreNumerico(`h3_god_${anno}`);
            const pers = getValoreNumerico(`h3_pers_${anno}`);
            const amm = getValoreNumerico(`h3_amm_${anno}`);
            const fin = getValoreNumerico(`h3_fin_${anno}`);
            const straord = getValoreNumerico(`h3_straord_${anno}`);
            const imp = getValoreNumerico(`h3_imp_${anno}`);
            
            const vp = fatt + altri;
            const mol = vp - mp - serv - god - pers;
            const ro = mol - amm;
            const rl = ro + fin + straord;
            const rn = rl - imp;
            
            // Salva in data attributes per H.4
            document.getElementById(`h3_vp_${anno}`).value = formatEuro(vp);
            document.getElementById(`h3_vp_${anno}`).dataset.value = vp;
            
            document.getElementById(`h3_mol_${anno}`).value = formatEuro(mol);
            document.getElementById(`h3_mol_${anno}`).dataset.value = mol;
            
            document.getElementById(`h3_ro_${anno}`).value = formatEuro(ro);
            document.getElementById(`h3_ro_${anno}`).dataset.value = ro;
            
            document.getElementById(`h3_rl_${anno}`).value = formatEuro(rl);
            document.getElementById(`h3_rl_${anno}`).dataset.value = rl;
            
            document.getElementById(`h3_rn_${anno}`).value = formatEuro(rn);
            document.getElementById(`h3_rn_${anno}`).dataset.value = rn;
        });
        
        // Calcola H.4
        calcolaH4();
        
    } catch (error) {
        console.error('Errore calcolaH3:', error);
    }
}

function calcolaH4() {
    try {
        const anni = ['2023', '2024', 'n1', 'n2', 'n3'];
        const contributo = datiDomanda?.economia?.contributoRichiesto || 100000;
        
        anni.forEach(anno => {
            const fatt = getValoreNumerico(`h3_fatt_${anno}`);
            const molEl = document.getElementById(`h3_mol_${anno}`);
            const mol = molEl ? parseFloat(molEl.dataset.value) || 0 : 0;
            const roEl = document.getElementById(`h3_ro_${anno}`);
            const ro = roEl ? parseFloat(roEl.dataset.value) || 0 : 0;
            const rnEl = document.getElementById(`h3_rn_${anno}`);
            const rn = rnEl ? parseFloat(rnEl.dataset.value) || 0 : 0;
            
            // NUOVO: Leggi il Totale Attivo (Capitale Investito)
            const totaleAttivo = getValoreNumerico(`h3_attivo_${anno}`);
            
            // ROI = Risultato Operativo (EBIT) / Capitale Investito Totale (Totale Attivo)
            const roi = totaleAttivo > 0 ? ((ro / totaleAttivo) * 100).toFixed(2) : '0.00';
            const roiField = document.getElementById(`h4_roi_${anno}`);
            if (roiField) {
                roiField.value = roi + '%';
                
                // Colora in base al valore del ROI
                if (parseFloat(roi) >= 15) {
                    roiField.style.color = '#28a745'; // Verde per ROI eccellente
                    roiField.style.fontWeight = 'bold';
                } else if (parseFloat(roi) >= 8) {
                    roiField.style.color = '#ffc107'; // Giallo per ROI buono
                } else if (parseFloat(roi) >= 0) {
                    roiField.style.color = '#000000'; // Nero per ROI positivo
                } else {
                    roiField.style.color = '#dc3545'; // Rosso per ROI negativo
                }
            }
            
            // Margine di contribuzione (MOL/Ricavi)
            const margine = fatt > 0 ? ((mol / fatt) * 100).toFixed(2) : '0.00';
            document.getElementById(`h4_marg_${anno}`).value = margine + '%';
            
            // Rapporto Risultato netto / Contributo pubblico
            const rapporto = contributo > 0 ? (rn / contributo).toFixed(4) : '0.0000';
            document.getElementById(`h4_rapp_${anno}`).value = rapporto;
        });
        
    } catch (error) {
        console.error('Errore calcolaH4:', error);
    }
}
function proiettaEserciziPrevisionali() {
    try {
        const fatt2023 = getValoreNumerico('h3_fatt_2023');
        const fatt2024 = getValoreNumerico('h3_fatt_2024');
        
        if (fatt2023 === 0 && fatt2024 === 0) {
            alert('⚠️ Inserire Fatturato 2023 e 2024!');
            return;
        }
        
        const crescitaDig = parseFloat(prompt(
            '📊 PROIEZIONE PREVISIONALI\n\n' +
            'Inserisci % CRESCITA da digitalizzazione\n' +
            '(Valori tipici: 5-15%)\n' +
            'Numero:',
            '10'
        )) / 100;
        
        if (isNaN(crescitaDig)) return;
        
        const ridCosti = parseFloat(prompt(
            '💡 RIDUZIONE COSTI da digitalizzazione\n' +
            '(Valori tipici: 3-8%)\n' +
            'Numero:',
            '5'
        )) / 100;
        
        if (isNaN(ridCosti)) return;
        
        // Leggi tutti i dati storici
        const altri2023 = getValoreNumerico('h3_altri_2023');
        const altri2024 = getValoreNumerico('h3_altri_2024');
        const mp2023 = getValoreNumerico('h3_mp_2023');
        const mp2024 = getValoreNumerico('h3_mp_2024');
        const serv2023 = getValoreNumerico('h3_serv_2023');
        const serv2024 = getValoreNumerico('h3_serv_2024');
        const god2023 = getValoreNumerico('h3_god_2023');
        const god2024 = getValoreNumerico('h3_god_2024');
        const pers2023 = getValoreNumerico('h3_pers_2023');
        const pers2024 = getValoreNumerico('h3_pers_2024');
        const amm2024 = getValoreNumerico('h3_amm_2024');
        
        // NUOVO: Leggi il Totale Attivo storico
        const attivo2023 = getValoreNumerico('h3_attivo_2023');
        const attivo2024 = getValoreNumerico('h3_attivo_2024');
        
        // Calcola tassi
        const calcolaTasso = (v23, v24) => v23 === 0 ? 0.05 : (v24 - v23) / v23;
        const tassoFatt = calcolaTasso(fatt2023, fatt2024);
        
        // NUOVO: Calcola tasso crescita Totale Attivo
        const tassoAttivo = attivo2023 > 0 ? calcolaTasso(attivo2023, attivo2024) : tassoFatt * 0.8;
        
        // Calcola proiezioni
        const costoProgetto = datiDomanda?.economia?.costoTotale || 0;
        const ammNuovo = costoProgetto / 5;
        
        // Anno n+1
        const fattN1 = fatt2024 * (1 + tassoFatt + (crescitaDig * 0.5));
        const altriN1 = altri2024 * 1.02;
        const mpN1 = mp2024 * 1.02;
        const servN1 = serv2024 * (1 - (ridCosti * 0.3));
        const godN1 = god2024 * 1.01;
        const persN1 = pers2024 * (1 - (ridCosti * 0.2));
        const ammN1 = amm2024 + ammNuovo;
        const finN1 = 0;
        const straordN1 = 0;
        const impN1 = Math.max(0, ((fattN1 + altriN1) - mpN1 - servN1 - godN1 - persN1 - ammN1) * 0.24);
        
        // NUOVO: Proietta Totale Attivo n+1
        let attivoN1;
        if (attivo2024 > 0) {
            // Se c'è il dato storico, proietta con crescita + investimento digitale
            attivoN1 = attivo2024 * (1 + tassoAttivo + (crescitaDig * 0.3)) + (costoProgetto * 0.8);
        } else {
            // Altrimenti stima basandosi sul fatturato (rapporto tipico 1.5x)
            attivoN1 = fattN1 * 1.5;
        }
        
        // Anno n+2
        const fattN2 = fattN1 * (1 + tassoFatt + crescitaDig);
        const altriN2 = altriN1 * 1.02;
        const mpN2 = mpN1 * 1.02;
        const servN2 = servN1 * (1 - ridCosti);
        const godN2 = godN1 * 1.01;
        const persN2 = persN1 * (1 - (ridCosti * 0.5));
        const ammN2 = ammN1;
        const impN2 = Math.max(0, ((fattN2 + altriN2) - mpN2 - servN2 - godN2 - persN2 - ammN2) * 0.24);
        
        // NUOVO: Proietta Totale Attivo n+2
        let attivoN2;
        if (attivoN1 > 0) {
            attivoN2 = attivoN1 * (1 + tassoAttivo + (crescitaDig * 0.5));
        } else {
            attivoN2 = fattN2 * 1.5;
        }
        
        // Anno n+3
        const fattN3 = fattN2 * (1 + tassoFatt + (crescitaDig * 0.8));
        const altriN3 = altriN2 * 1.02;
        const mpN3 = mpN2 * 1.02;
        const servN3 = servN2 * (1 - (ridCosti * 0.8));
        const godN3 = godN2 * 1.01;
        const persN3 = persN2 * (1 - (ridCosti * 0.3));
        const ammN3 = ammN2;
        const impN3 = Math.max(0, ((fattN3 + altriN3) - mpN3 - servN3 - godN3 - persN3 - ammN3) * 0.24);
        
        // NUOVO: Proietta Totale Attivo n+3
        let attivoN3;
        if (attivoN2 > 0) {
            attivoN3 = attivoN2 * (1 + tassoAttivo + (crescitaDig * 0.3));
        } else {
            attivoN3 = fattN3 * 1.5;
        }
        
        // Conferma
        if (!confirm(
            '📈 PROIEZIONI:\n\n' +
            'Fatturato n+1: ' + formatEuro(fattN1) + '\n' +
            'Fatturato n+2: ' + formatEuro(fattN2) + '\n' +
            'Fatturato n+3: ' + formatEuro(fattN3) + '\n\n' +
            'Totale Attivo n+1: ' + formatEuro(attivoN1) + '\n' +
            'Totale Attivo n+2: ' + formatEuro(attivoN2) + '\n' +
            'Totale Attivo n+3: ' + formatEuro(attivoN3) + '\n\n' +
            'Compilare?'
        )) return;
        
        // Compila n+1
        document.getElementById('h3_fatt_n1').value = fattN1.toFixed(2);
        document.getElementById('h3_altri_n1').value = altriN1.toFixed(2);
        document.getElementById('h3_mp_n1').value = mpN1.toFixed(2);
        document.getElementById('h3_serv_n1').value = servN1.toFixed(2);
        document.getElementById('h3_god_n1').value = godN1.toFixed(2);
        document.getElementById('h3_pers_n1').value = persN1.toFixed(2);
        document.getElementById('h3_amm_n1').value = ammN1.toFixed(2);
        document.getElementById('h3_fin_n1').value = finN1.toFixed(2);
        document.getElementById('h3_straord_n1').value = straordN1.toFixed(2);
        document.getElementById('h3_imp_n1').value = impN1.toFixed(2);
        document.getElementById('h3_attivo_n1').value = attivoN1.toFixed(2); // NUOVO
        
        // Compila n+2
        document.getElementById('h3_fatt_n2').value = fattN2.toFixed(2);
        document.getElementById('h3_altri_n2').value = altriN2.toFixed(2);
        document.getElementById('h3_mp_n2').value = mpN2.toFixed(2);
        document.getElementById('h3_serv_n2').value = servN2.toFixed(2);
        document.getElementById('h3_god_n2').value = godN2.toFixed(2);
        document.getElementById('h3_pers_n2').value = persN2.toFixed(2);
        document.getElementById('h3_amm_n2').value = ammN2.toFixed(2);
        document.getElementById('h3_fin_n2').value = 0;
        document.getElementById('h3_straord_n2').value = 0;
        document.getElementById('h3_imp_n2').value = impN2.toFixed(2);
        document.getElementById('h3_attivo_n2').value = attivoN2.toFixed(2); // NUOVO
        
        // Compila n+3
        document.getElementById('h3_fatt_n3').value = fattN3.toFixed(2);
        document.getElementById('h3_altri_n3').value = altriN3.toFixed(2);
        document.getElementById('h3_mp_n3').value = mpN3.toFixed(2);
        document.getElementById('h3_serv_n3').value = servN3.toFixed(2);
        document.getElementById('h3_god_n3').value = godN3.toFixed(2);
        document.getElementById('h3_pers_n3').value = persN3.toFixed(2);
        document.getElementById('h3_amm_n3').value = ammN3.toFixed(2);
        document.getElementById('h3_fin_n3').value = 0;
        document.getElementById('h3_straord_n3').value = 0;
        document.getElementById('h3_imp_n3').value = impN3.toFixed(2);
        document.getElementById('h3_attivo_n3').value = attivoN3.toFixed(2); // NUOVO
        
        // Ricalcola
        calcolaH3();
        
        alert('✅ Proiezioni completate!\n\n' +
              'Il Totale Attivo è stato proiettato considerando:\n' +
              '• Crescita storica dell\'attivo\n' +
              '• Impatto dell\'investimento digitale\n' +
              '• Crescita del fatturato\n\n' +
              'ROI calcolato con formula corretta: EBIT / Totale Attivo');
        
    } catch (error) {
        console.error('Errore proiezione:', error);
        alert('❌ Errore: ' + error.message);
    }
}

function calcolaVariazioniH6() {
    const qualifiche = ['dir', 'quad', 'imp', 'op'];
    
    qualifiche.forEach(qual => {
        const ula2024 = getValoreNumerico(`h6_${qual}_2024`);
        const ulaPrev = getValoreNumerico(`h6_${qual}_prev`);
        const variazione = ulaPrev - ula2024;
        
        const varField = document.getElementById(`h6_${qual}_var`);
        if (varField) {
            varField.value = (variazione >= 0 ? '+' : '') + variazione.toFixed(2);
            varField.style.color = variazione > 0 ? 'green' : variazione < 0 ? 'red' : 'black';
            varField.style.fontWeight = variazione !== 0 ? 'bold' : 'normal';
        }
    });
}

function caricaProgettoDaFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) return;
        
        // Verifica estensione
        if (!file.name.endsWith('.json')) {
            alert('⚠️ Seleziona un file .json valido!');
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const contenuto = e.target.result;
                const progetto = JSON.parse(contenuto);
                
                // Verifica struttura
                if (!progetto.metadata || !progetto.datiDomanda) {
                    throw new Error('File non valido: struttura dati mancante');
                }
                
                // Verifica versione compatibilità
                if (progetto.metadata.applicazione !== 'DIGIT IMPRESE - Assistente Compilazione Domanda') {
                    const conferma = confirm('⚠️ ATTENZIONE!\n\nQuesto file potrebbe non essere compatibile.\n\nContinuare comunque?');
                    if (!conferma) return;
                }
                
                // Conferma caricamento
                const confermaCarica = confirm(
                    '📂 CARICAMENTO PROGETTO\n\n' +
                    'Progetto: ' + (progetto.metadata.nomeProgetto || 'N/D') + '\n' +
                    'P.IVA: ' + (progetto.metadata.partitaIva || 'N/D') + '\n' +
                    'Salvato il: ' + new Date(progetto.metadata.dataSalvataggio).toLocaleString('it-IT') + '\n' +
                    'Fase: ' + progetto.metadata.faseCorrente + '\n\n' +
                    'Tutti i dati correnti verranno sovrascritti.\n\n' +
                    'Continuare?'
                );
                
                if (!confermaCarica) return;
                
                // Carica dati
                datiDomanda = progetto.datiDomanda;
                
                // Ripopola tutti i campi
                popolaCampiDaSalvataggio();
                
                // Vai alla fase salvata
                const faseSalvata = progetto.metadata.faseCorrente || 1;
                goToStep(faseSalvata);
                
                // Salva in localStorage come backup
                localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
                
                alert('✅ Progetto caricato con successo!\n\n' +
                      'Progetto: ' + (progetto.metadata.nomeProgetto || 'N/D') + '\n' +
                      'Fase corrente: ' + faseSalvata);
                
                console.log('📂 Progetto caricato:', file.name);
                
            } catch (error) {
                console.error('❌ ERRORE parsing file:', error);
                alert('❌ Errore nel caricamento del file:\n\n' + error.message + '\n\nVerifica che il file sia un progetto DIGIT IMPRESE valido.');
            }
        };
        
        reader.onerror = function() {
            alert('❌ Errore nella lettura del file!');
        };
        
        reader.readAsText(file);
        
        // Reset input per permettere di caricare lo stesso file
        event.target.value = '';
        
    } catch (error) {
        console.error('❌ ERRORE caricamento file:', error);
        alert('❌ Errore: ' + error.message);
    }
}

function popolaCampiDaSalvataggio() {
    try {
        console.log('🔄 Popolamento campi da salvataggio...');
        
        // ==========================================
        // FASE 1 - DATI IMPRESA
        // ==========================================
        if (datiDomanda.impresa) {
            document.getElementById('ragioneSociale').value = datiDomanda.impresa.ragioneSociale || '';
            document.getElementById('partitaIva').value = datiDomanda.impresa.partitaIva || '';
            document.getElementById('codiceFiscale').value = datiDomanda.impresa.codiceFiscale || '';
            document.getElementById('pec').value = datiDomanda.impresa.pec || '';
            document.getElementById('annoCostituzione').value = datiDomanda.impresa.annoCostituzione || '';
            document.getElementById('sedeLegale').value = datiDomanda.impresa.sedeLegale || '';
            document.getElementById('sedeSicilia').value = datiDomanda.impresa.sedeSicilia || '';
            document.getElementById('dimensioneImpresa').value = datiDomanda.impresa.dimensione || '';
        }
        
        // LEGALE RAPPRESENTANTE
        if (datiDomanda.legaleRappresentante) {
            document.getElementById('lrNome').value = datiDomanda.legaleRappresentante.nome || '';
            document.getElementById('lrCognome').value = datiDomanda.legaleRappresentante.cognome || '';
            document.getElementById('lrCF').value = datiDomanda.legaleRappresentante.codiceFiscale || '';
            document.getElementById('lrLuogoNascita').value = datiDomanda.legaleRappresentante.luogoNascita || '';
            document.getElementById('lrDataNascita').value = datiDomanda.legaleRappresentante.dataNascita || '';
            document.getElementById('lrResidenza').value = datiDomanda.legaleRappresentante.residenza || '';
        }
        
        // REQUISITI AMMISSIBILITÀ
        if (document.getElementById('checkDURC')) document.getElementById('checkDURC').checked = true;
        if (document.getElementById('checkAntimafia')) document.getElementById('checkAntimafia').checked = true;
        if (document.getElementById('checkRevoche')) document.getElementById('checkRevoche').checked = true;
        if (document.getElementById('checkProgettoDiverso')) document.getElementById('checkProgettoDiverso').checked = true;
        
        // ==========================================
        // FASE 2 - MOL
        // ==========================================
        if (datiDomanda.economia) {
            document.getElementById('annoRiferimento').value = datiDomanda.economia.annoRiferimento || '';
            document.getElementById('tipoDocumento').value = datiDomanda.economia.tipoDocumento || '';
            
            document.getElementById('valoreProduzione').value = datiDomanda.economia.valoreProduzione || '';
            document.getElementById('materiePrime').value = datiDomanda.economia.materiePrime || '';
            document.getElementById('costiServizi').value = datiDomanda.economia.costiServizi || '';
            document.getElementById('costiBeniTerzi').value = datiDomanda.economia.costiBeniTerzi || '';
            document.getElementById('spesePersonale').value = datiDomanda.economia.spesePersonale || '';
            document.getElementById('variazioniRimanenze').value = datiDomanda.economia.variazioniRimanenze || '';
            document.getElementById('oneriDiversi').value = datiDomanda.economia.oneriDiversi || '';
            document.getElementById('ammortamenti').value = datiDomanda.economia.ammortamenti || '';
            
            document.getElementById('costoTotale').value = datiDomanda.economia.costoTotale || '';
            document.getElementById('modalitaErogazione').value = datiDomanda.economia.modalitaErogazione || '';
            document.getElementById('richiestaAnticipo').value = datiDomanda.economia.richiestaAnticipo || '';
            document.getElementById('disponibilitaFinanziaria').value = datiDomanda.economia.disponibilitaFinanziaria || '';
            
            document.getElementById('tipoProfessionista').value = datiDomanda.economia.tipoProfessionista || '';
            document.getElementById('nomeProfessionista').value = datiDomanda.economia.nomeProfessionista || '';
            document.getElementById('cfProfessionista').value = datiDomanda.economia.cfProfessionista || '';
            document.getElementById('iscrizioneAlbo').value = datiDomanda.economia.iscrizioneAlbo || '';
            document.getElementById('sedeProfessionista').value = datiDomanda.economia.sedeProfessionista || '';
            
            // Ricalcola MOL
            calcolaMOLAutomatico();
        }
        
        // ==========================================
        // FASE 3 - PREVENTIVI
        // ==========================================
        if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
            mostraPreventivi();
        }
        
        // ==========================================
        // FASE 4 - ISTANZA 2.1
        // ==========================================
        if (datiDomanda.allegato21) {
            if (document.getElementById('titoloProgettoIstanza')) {
                document.getElementById('titoloProgettoIstanza').value = datiDomanda.formulario?.titoloProgetto || '';
            }
            document.getElementById('numeroMarcaBollo').value = datiDomanda.allegato21.numeroMarcaBollo || '';
            document.getElementById('dataMarcaBollo').value = datiDomanda.allegato21.dataMarcaBollo || '';
            document.getElementById('tipoImpresa').value = datiDomanda.allegato21.tipoImpresa || '';
            document.getElementById('haDeMinimis').value = datiDomanda.allegato21.haDeMinimis || '';
            document.getElementById('fusioni').value = datiDomanda.allegato21.fusioni || '';
            
            document.getElementById('ula_dichiarante').value = datiDomanda.allegato21.ula_dichiarante || '';
            document.getElementById('fatturato_dichiarante').value = datiDomanda.allegato21.fatturato_dichiarante || '';
            document.getElementById('bilancio_dichiarante').value = datiDomanda.allegato21.bilancio_dichiarante || '';
        }
        
        // ==========================================
        // FASE 5 - FORMULARIO
        // ==========================================
        if (datiDomanda.formulario) {
            document.getElementById('titoloProgetto').value = datiDomanda.formulario.titoloProgetto || '';
            document.getElementById('acronimoProgetto').value = datiDomanda.formulario.acronimoProgetto || '';
            document.getElementById('durataProgetto').value = datiDomanda.formulario.durataProgetto || '';
            document.getElementById('missionAttivita').value = datiDomanda.formulario.missionAttivita || '';
            document.getElementById('attivitaEconomica').value = datiDomanda.formulario.attivitaEconomica || '';
            document.getElementById('posizionamentoCompetitivo').value = datiDomanda.formulario.posizionamentoCompetitivo || '';
            document.getElementById('contestualizzazioneFabbisogni').value = datiDomanda.formulario.contestualizzazioneFabbisogni || '';
            document.getElementById('obiettiviPerseguiti').value = datiDomanda.formulario.obiettiviPerseguiti || '';
            document.getElementById('capacitaAmministrativa').value = datiDomanda.formulario.capacitaAmministrativa || '';
            document.getElementById('gruppoDiLavoro').value = datiDomanda.formulario.gruppoDiLavoro || '';
            document.getElementById('obiettiviGeneraliSpecifici').value = datiDomanda.formulario.obiettiviGeneraliSpecifici || '';
            document.getElementById('quadroLogico').value = datiDomanda.formulario.quadroLogico || '';
            document.getElementById('implementazioneInnovazioni').value = datiDomanda.formulario.implementazioneInnovazioni || '';
            document.getElementById('coinvolgimentoUtilizzatori').value = datiDomanda.formulario.coinvolgimentoUtilizzatori || '';
            document.getElementById('matriceWP').value = datiDomanda.formulario.matriceWP || '';
            document.getElementById('cronoprogramma').value = datiDomanda.formulario.cronoprogramma || '';
            document.getElementById('sistemaMonitoraggio').value = datiDomanda.formulario.sistemaMonitoraggio || '';
            document.getElementById('valutazioneImpatto').value = datiDomanda.formulario.valutazioneImpatto || '';
            document.getElementById('ricaduteOccupazionali').value = datiDomanda.formulario.ricaduteOccupazionali || '';
            document.getElementById('strategiaSostenibilita').value = datiDomanda.formulario.strategiaSostenibilita || '';
        }
        
        console.log('✅ Campi popolati con successo');
        
    } catch (error) {
        console.error('❌ ERRORE popolamento campi:', error);
        alert('⚠️ Alcuni campi potrebbero non essere stati caricati correttamente.\n\nVerifica i dati inseriti.');
    }
}

function nuovoProgetto() {
    const conferma = confirm(
        '⚠️ ATTENZIONE!\n\n' +
        'Iniziare un nuovo progetto cancellerà tutti i dati correnti.\n\n' +
        'Assicurati di aver salvato il progetto corrente prima di procedere.\n\n' +
        'Continuare?'
    );
    
    if (!conferma) return;
    
    // Reset completo
    datiDomanda = {
        impresa: {},
        legaleRappresentante: {},
        economia: {},
        preventivi: [],
        formulario: {},
        checklist: []
    };
    
    // Pulisci localStorage
    localStorage.removeItem('digitImpreseDomanda');
    localStorage.removeItem('digitImpreseLastSave');
    
    // Ricarica pagina
    location.reload();
}

function salvaEFinalizza() {
    try {
        // Verifica completamento
        const obbligatoriCompletati = datiDomanda.checklist
            ?.filter(d => d.obbligatorio)
            .every(d => d.completato);
        
        if (!obbligatoriCompletati) {
            const conferma = confirm(
                '⚠️ ATTENZIONE!\n\n' +
                'Non tutti i documenti obbligatori sono stati verificati.\n\n' +
                'Vuoi procedere comunque?'
            );
            if (!conferma) return;
        }
        
        // Salva dati finali
        salvaTuttiIDati();
        
        // Chiedi nome base per i file
        const ragioneSociale = datiDomanda.impresa?.ragioneSociale || 'MiaImpresa';
        const piva = datiDomanda.impresa?.partitaIva || 'PIVA';
        const timestamp = new Date().toISOString().split('T')[0];
        const nomeDefault = `${ragioneSociale.replace(/[^a-zA-Z0-9]/g, '_')}_${piva}_${timestamp}`;
        
        const nomeBase = prompt(
            '📁 SALVATAGGIO COMPLETO\n\n' +
            'Inserisci il nome base per i file:\n' +
            '(verrà usato per .json, .xlsx e .pdf)\n\n' +
            'Esempio: ' + nomeDefault,
            nomeDefault
        );
        
        if (nomeBase === null) {
            console.log('❌ Salvataggio annullato');
            return;
        }
        
        const nomeBasePulito = (nomeBase.trim() || nomeDefault).replace(/[^a-zA-Z0-9_-]/g, '_');
        
        // Mostra messaggio di elaborazione
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        overlay.innerHTML = `
            <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 500px;">
                <i class="fas fa-cog fa-spin" style="font-size: 48px; color: #0066cc; margin-bottom: 20px;"></i>
                <h3 style="color: #0066cc; margin-bottom: 10px;">Salvataggio e Generazione Documenti</h3>
                <p style="color: #666;" id="progressStatus">Attendere prego...</p>
                <div style="margin-top: 20px;">
                    <div id="progressMsg" style="font-size: 14px; color: #666;"></div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        const progressMsg = overlay.querySelector('#progressMsg');
        const progressStatus = overlay.querySelector('#progressStatus');
        
        // Genera documenti
        setTimeout(() => {
            const codiceId = generaCodiceIdentificativo();
            
            let filesSalvati = [];
            
            // 1. Salva progetto JSON
            progressMsg.textContent = '📄 Salvataggio progetto JSON...';
            try {
                salvaProgettoConNome(nomeBasePulito);
                filesSalvati.push(nomeBasePulito + '.json');
            } catch (error) {
                console.error('Errore salvataggio JSON:', error);
            }
            
            setTimeout(() => {
                // 2. Genera Excel
                progressMsg.textContent = '📊 Generazione Excel...';
                try {
                    esportaExcelConNome(nomeBasePulito);
                    filesSalvati.push(nomeBasePulito + '.xlsx');
                } catch (error) {
                    console.error('Errore Excel:', error);
                }
                
                setTimeout(() => {
                    // 3. Genera PDF
                    progressMsg.textContent = '📄 Generazione PDF...';
                    try {
                        esportaPDFConNome(nomeBasePulito);
                        filesSalvati.push(nomeBasePulito + '.pdf');
                    } catch (error) {
                        console.error('Errore PDF:', error);
                    }
                    
                    setTimeout(() => {
                        // Rimuovi overlay
                        document.body.removeChild(overlay);
                        
                        // Messaggio finale
                        alert(
                            '✅ SALVATAGGIO COMPLETATO!\n\n' +
                            `Codice Domanda: ${codiceId}\n\n` +
                            'File generati:\n' +
                            filesSalvati.map(f => '• ' + f).join('\n') + '\n\n' +
                            '📂 Conserva il file .json per riaprire il progetto in futuro.\n\n' +
                            '🍀 In bocca al lupo per la tua domanda DIGIT IMPRESE!'
                        );
                    }, 1000);
                }, 1000);
            }, 500);
        }, 500);
        
    } catch (error) {
        console.error('❌ ERRORE salvataggio e finalizzazione:', error);
        alert('❌ Errore: ' + error.message);
    }
}

function salvaProgettoConNome(nomeBase) {
    // Salva senza chiedere il nome (già chiesto)
    salvaTuttiIDati();
    
    const progetto = {
        metadata: {
            versione: '1.0',
            applicazione: 'DIGIT IMPRESE - Assistente Compilazione Domanda',
            dataSalvataggio: new Date().toISOString(),
            dataModifica: new Date().toISOString(),
            faseCorrente: currentStep,
            nomeProgetto: datiDomanda.impresa?.ragioneSociale || 'Progetto DIGIT IMPRESE',
            partitaIva: datiDomanda.impresa?.partitaIva || '',
            nomeFile: nomeBase
        },
        datiDomanda: datiDomanda
    };
    
    const jsonStr = JSON.stringify(progetto, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = nomeBase + '.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
    localStorage.setItem('digitImpreseLastSave', new Date().toISOString());
}

function esportaExcelConNome(nomeBase) {
    try {
        // Stessa logica di esportaExcel() ma con nome custom
        salvaTuttiIDati();
        
        const wb = XLSX.utils.book_new();
        
        // ... tutto il codice di esportaExcel() ...
        // (copia tutto il contenuto della funzione esportaExcel esistente)
        
        const filename = nomeBase + '.xlsx';
        XLSX.writeFile(wb, filename);
        
        console.log('✅ Excel esportato:', filename);
        return filename;
        
    } catch (error) {
        console.error('ERRORE export Excel:', error);
        throw error;
    }
}

function esportaPDFConNome(nomeBase) {
    try {
        // Stessa logica di esportaPDF() ma con nome custom
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // ... tutto il codice di esportaPDF() ...
        // (copia tutto il contenuto della funzione esportaPDF esistente)
        
        const filename = nomeBase + '.pdf';
        doc.save(filename);
        
        console.log('✅ PDF esportato:', filename);
        return filename;
        
    } catch (error) {
        console.error('ERRORE export PDF:', error);
        throw error;
    }
}

// Auto-save ogni 2 minuti in localStorage come backup
function salvaAutomaticamente() {
    try {
        salvaDatiFase(currentStep);
        localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
        localStorage.setItem('digitImpreseLastSave', new Date().toISOString());
        console.log('💾 Auto-save:', new Date().toLocaleTimeString());
    } catch (error) {
        console.error('❌ Errore auto-save:', error);
    }
}

// Carica automaticamente da localStorage all'avvio (se presente)
function caricaDatiSalvati() {
    try {
        const saved = localStorage.getItem('digitImpreseDomanda');
        const lastSave = localStorage.getItem('digitImpreseLastSave');
        
        if (saved && lastSave) {
            const dataUltimoSalvataggio = new Date(lastSave);
            const ora = new Date();
            const oreTrascorse = (ora - dataUltimoSalvataggio) / (1000 * 60 * 60);
            
            // Se è passata meno di 1 ora, proponi il ripristino automatico
            if (oreTrascorse < 1) {
                console.log('💾 Backup automatico trovato (salvato ' + Math.round(oreTrascorse * 60) + ' minuti fa)');
                
                // Mostra banner discreto invece di popup
                const banner = document.createElement('div');
                banner.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #0066cc;
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                    z-index: 9999;
                    max-width: 350px;
                `;
                banner.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-right: 10px;"></i>
                        <strong>Backup Automatico Trovato</strong>
                    </div>
                    <p style="margin: 10px 0; font-size: 14px;">Trovato un salvataggio automatico di ${Math.round(oreTrascorse * 60)} minuti fa.</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="this.parentElement.parentElement.remove()" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; border-radius: 5px; cursor: pointer;">
                            Ignora
                        </button>
                        <button onclick="ripristinaBackupAutomatico(); this.parentElement.parentElement.remove();" style="flex: 1; padding: 8px; background: white; border: none; color: #0066cc; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            Ripristina
                        </button>
                    </div>
                `;
                document.body.appendChild(banner);
                
                // Auto-remove dopo 30 secondi
                setTimeout(() => {
                    if (banner.parentElement) {
                        banner.remove();
                    }
                }, 30000);
            }
        }
    } catch (error) {
        console.error('❌ Errore caricamento backup:', error);
    }
}

function ripristinaBackupAutomatico() {
    try {
        const saved = localStorage.getItem('digitImpreseDomanda');
        if (saved) {
            datiDomanda = JSON.parse(saved);
            popolaCampiDaSalvataggio();
            alert('✅ Backup ripristinato con successo!');
        }
    } catch (error) {
        console.error('❌ Errore ripristino backup:', error);
        alert('❌ Errore nel ripristino del backup.');
    }
}

// ============================================
// SALVATAGGIO COMPLETO - TUTTI I DATI
// ============================================

function salvaTuttiIDati() {
    try {
        console.log('💾 Salvataggio completo di tutti i dati...');
        
        // ==========================================
        // FASE 1 - AMMISSIBILITÀ E DATI BASE
        // ==========================================
        datiDomanda.impresa = {
            ragioneSociale: document.getElementById('ragioneSociale')?.value || '',
            partitaIva: document.getElementById('partitaIva')?.value || '',
            codiceFiscale: document.getElementById('codiceFiscale')?.value || '',
            pec: document.getElementById('pec')?.value || '',
            annoCostituzione: document.getElementById('annoCostituzione')?.value || '',
            sedeLegale: document.getElementById('sedeLegale')?.value || '',
            sedeSicilia: document.getElementById('sedeSicilia')?.value || '',
            dimensione: document.getElementById('dimensioneImpresa')?.value || ''
        };
        
        datiDomanda.legaleRappresentante = {
            nome: document.getElementById('lrNome')?.value || '',
            cognome: document.getElementById('lrCognome')?.value || '',
            codiceFiscale: document.getElementById('lrCF')?.value || '',
            luogoNascita: document.getElementById('lrLuogoNascita')?.value || '',
            dataNascita: document.getElementById('lrDataNascita')?.value || '',
            residenza: document.getElementById('lrResidenza')?.value || ''
        };
        
        datiDomanda.requisitiAmmissibilita = {
            checkDURC: document.getElementById('checkDURC')?.checked || false,
            checkAntimafia: document.getElementById('checkAntimafia')?.checked || false,
            checkRevoche: document.getElementById('checkRevoche')?.checked || false,
            checkProgettoDiverso: document.getElementById('checkProgettoDiverso')?.checked || false
        };
        
        // ==========================================
        // FASE 2 - MOL E PROGETTO
        // ==========================================
        datiDomanda.economia = {
            // Periodo riferimento
            annoRiferimento: document.getElementById('annoRiferimento')?.value || '',
            tipoDocumento: document.getElementById('tipoDocumento')?.value || '',
            
            // Componenti MOL
            valoreProduzione: getValoreNumerico('valoreProduzione'),
            materiePrime: getValoreNumerico('materiePrime'),
            costiServizi: getValoreNumerico('costiServizi'),
            costiBeniTerzi: getValoreNumerico('costiBeniTerzi'),
            spesePersonale: getValoreNumerico('spesePersonale'),
            variazioniRimanenze: getValoreNumerico('variazioniRimanenze'),
            oneriDiversi: getValoreNumerico('oneriDiversi'),
            ammortamenti: getValoreNumerico('ammortamenti'),
            mol: datiDomanda.economia?.mol || 0,
            
            // Progetto
            costoTotale: getValoreNumerico('costoTotale'),
            massimale: datiDomanda.economia?.massimale || 0,
            contributoRichiesto: datiDomanda.economia?.contributoRichiesto || 0,
            indicatoreOrdinatore: datiDomanda.economia?.indicatoreOrdinatore || '',
            posizionamento: datiDomanda.economia?.posizionamento || '',
            dentroLimiti: datiDomanda.economia?.dentroLimiti || false,
            
            // Modalità erogazione
            modalitaErogazione: document.getElementById('modalitaErogazione')?.value || '',
            richiestaAnticipo: document.getElementById('richiestaAnticipo')?.value || '',
            
            // Capacità finanziaria
            disponibilitaFinanziaria: getValoreNumerico('disponibilitaFinanziaria'),
            
            // Professionista
            tipoProfessionista: document.getElementById('tipoProfessionista')?.value || '',
            nomeProfessionista: document.getElementById('nomeProfessionista')?.value || '',
            cfProfessionista: document.getElementById('cfProfessionista')?.value || '',
            iscrizioneAlbo: document.getElementById('iscrizioneAlbo')?.value || '',
            sedeProfessionista: document.getElementById('sedeProfessionista')?.value || ''
        };
        
        // ==========================================
        // FASE 3 - PREVENTIVI (già salvati in array)
        // ==========================================
        // datiDomanda.preventivi è già aggiornato
        
        // ==========================================
        // FASE 4 - ISTANZA 2.1
        // ==========================================
        datiDomanda.allegato21 = {
            titoloProgetto: document.getElementById('titoloProgettoIstanza')?.value || '',
            
            // Dichiarazioni
            dichiarazioni: {
                dichA: document.getElementById('dichA')?.checked || false,
                dichB: document.getElementById('dichB')?.checked || false,
                dichC: document.getElementById('dichC')?.checked || false,
                dichD: document.getElementById('dichD')?.checked || false,
                dichE: document.getElementById('dichE')?.checked || false,
                dichF: document.getElementById('dichF')?.checked || false,
                dichG: document.getElementById('dichG')?.checked || false,
                dichH: document.getElementById('dichH')?.checked || false,
                dichI: document.getElementById('dichI')?.checked || false,
                dichL: document.getElementById('dichL')?.checked || false
            },
            
            // Dimensione aziendale
            dimensioneAziendale: {
                ula_dichiarante: getValoreNumerico('ula_dichiarante'),
                fatturato_dichiarante: getValoreNumerico('fatturato_dichiarante'),
                bilancio_dichiarante: getValoreNumerico('bilancio_dichiarante'),
                ula_associate: getValoreNumerico('ula_associate'),
                fatturato_associate: getValoreNumerico('fatturato_associate'),
                bilancio_associate: getValoreNumerico('bilancio_associate'),
                ula_collegate: getValoreNumerico('ula_collegate'),
                fatturato_collegate: getValoreNumerico('fatturato_collegate'),
                bilancio_collegate: getValoreNumerico('bilancio_collegate'),
                ula_totale: document.getElementById('ula_totale')?.textContent || '0',
                fatturato_totale: document.getElementById('fatturato_totale')?.textContent || '0',
                bilancio_totale: document.getElementById('bilancio_totale')?.textContent || '0'
            },
            
            // Classificazione
            tipoImpresa: document.getElementById('tipoImpresa')?.value || '',
            
            // De Minimis
            haDeMinimis: document.getElementById('haDeMinimis')?.value || '',
            fusioni: document.getElementById('fusioni')?.value || '',
            
            // Tabella De Minimis (se presente)
            aiutiDeMinimis: salvaTabellaDeMinimiis(),
            
            // Marca da bollo
            numeroMarcaBollo: document.getElementById('numeroMarcaBollo')?.value || '',
            dataMarcaBollo: document.getElementById('dataMarcaBollo')?.value || ''
        };
        
        // ==========================================
        // FASE 5 - FORMULARIO COMPLETO
        // ==========================================
        datiDomanda.formulario = {
            // Sezione A
            titoloProgetto: document.getElementById('titoloProgetto')?.value || '',
            acronimoProgetto: document.getElementById('acronimoProgetto')?.value || '',
            durataProgetto: document.getElementById('durataProgetto')?.value || '',
            missionAttivita: document.getElementById('missionAttivita')?.value || '',
            
            // Sezione B
            attivitaEconomica: document.getElementById('attivitaEconomica')?.value || '',
            posizionamentoCompetitivo: document.getElementById('posizionamentoCompetitivo')?.value || '',
            
            // Sezione C
            contestualizzazioneFabbisogni: document.getElementById('contestualizzazioneFabbisogni')?.value || '',
            obiettiviPerseguiti: document.getElementById('obiettiviPerseguiti')?.value || '',
            
            // Sezione D
            capacitaAmministrativa: document.getElementById('capacitaAmministrativa')?.value || '',
            gruppoDiLavoro: document.getElementById('gruppoDiLavoro')?.value || '',
            
            // Sezione E
            obiettiviGeneraliSpecifici: document.getElementById('obiettiviGeneraliSpecifici')?.value || '',
            quadroLogico: document.getElementById('quadroLogico')?.value || '',
            implementazioneInnovazioni: document.getElementById('implementazioneInnovazioni')?.value || '',
            coinvolgimentoUtilizzatori: document.getElementById('coinvolgimentoUtilizzatori')?.value || '',
            matriceWP: document.getElementById('matriceWP')?.value || '',
            cronoprogramma: document.getElementById('cronoprogramma')?.value || '',
            
            // Sezione F
            sistemaMonitoraggio: document.getElementById('sistemaMonitoraggio')?.value || '',
            valutazioneImpatto: document.getElementById('valutazioneImpatto')?.value || '',
            
            // Sezione G
            ricaduteOccupazionali: document.getElementById('ricaduteOccupazionali')?.value || '',
            quotaTecnologieAbilitanti: getValoreNumerico('quotaTecnologieAbilitanti'),
            percentualeTecnologieS3: document.getElementById('percentualeTecnologieS3')?.value || '',
            
            // Sezione H - Budget
            giustificazioneSpese: document.getElementById('giustificazioneSpese')?.value || '',
            fontiFinanziamento: document.getElementById('fontiFinanziamento')?.value || '',
            
            // H.2 - Piano Coperture
            pianoCoperture: {
                // Impieghi
                h2_inv_immat_anno1: getValoreNumerico('h2_inv_immat_anno1'),
                h2_inv_immat_tot: getValoreNumerico('h2_inv_immat_tot'),
                h2_inv_mat_anno1: getValoreNumerico('h2_inv_mat_anno1'),
                h2_inv_mat_tot: getValoreNumerico('h2_inv_mat_tot'),
                h2_iva_anno1: getValoreNumerico('h2_iva_anno1'),
                h2_iva_tot: getValoreNumerico('h2_iva_tot'),
                
                // Fonti
                h2_contributo_anno1: getValoreNumerico('h2_contributo_anno1'),
                h2_cap_sociale_anno1: getValoreNumerico('h2_cap_sociale_anno1'),
                h2_cap_sociale_tot: getValoreNumerico('h2_cap_sociale_tot'),
                h2_finanz_soci_anno1: getValoreNumerico('h2_finanz_soci_anno1'),
                h2_finanz_soci_tot: getValoreNumerico('h2_finanz_soci_tot'),
                h2_riserve_anno1: getValoreNumerico('h2_riserve_anno1'),
                h2_riserve_tot: getValoreNumerico('h2_riserve_tot'),
                h2_finanz_ml_anno1: getValoreNumerico('h2_finanz_ml_anno1'),
                h2_finanz_ml_tot: getValoreNumerico('h2_finanz_ml_tot'),
                h2_finanz_breve_anno1: getValoreNumerico('h2_finanz_breve_anno1'),
                h2_finanz_breve_tot: getValoreNumerico('h2_finanz_breve_tot')
            },
            
            // H.3 - Conto Economico
            strategiaSostenibilita: document.getElementById('strategiaSostenibilita')?.value || '',
            contoEconomico: {
                // 2023
                h3_fatt_2023: getValoreNumerico('h3_fatt_2023'),
                h3_altri_2023: getValoreNumerico('h3_altri_2023'),
                h3_mp_2023: getValoreNumerico('h3_mp_2023'),
                h3_serv_2023: getValoreNumerico('h3_serv_2023'),
                h3_god_2023: getValoreNumerico('h3_god_2023'),
                h3_pers_2023: getValoreNumerico('h3_pers_2023'),
                h3_amm_2023: getValoreNumerico('h3_amm_2023'),
                h3_fin_2023: getValoreNumerico('h3_fin_2023'),
                h3_straord_2023: getValoreNumerico('h3_straord_2023'),
                h3_imp_2023: getValoreNumerico('h3_imp_2023'),
		h3_attivo_2023: getValoreNumerico('h3_attivo_2023'),
                
                // 2024
                h3_fatt_2024: getValoreNumerico('h3_fatt_2024'),
                h3_altri_2024: getValoreNumerico('h3_altri_2024'),
                h3_mp_2024: getValoreNumerico('h3_mp_2024'),
                h3_serv_2024: getValoreNumerico('h3_serv_2024'),
                h3_god_2024: getValoreNumerico('h3_god_2024'),
                h3_pers_2024: getValoreNumerico('h3_pers_2024'),
                h3_amm_2024: getValoreNumerico('h3_amm_2024'),
                h3_fin_2024: getValoreNumerico('h3_fin_2024'),
                h3_straord_2024: getValoreNumerico('h3_straord_2024'),
                h3_imp_2024: getValoreNumerico('h3_imp_2024'),
		h3_attivo_2024: getValoreNumerico('h3_attivo_2024'),
                
                // n+1
                h3_fatt_n1: getValoreNumerico('h3_fatt_n1'),
                h3_altri_n1: getValoreNumerico('h3_altri_n1'),
                h3_mp_n1: getValoreNumerico('h3_mp_n1'),
                h3_serv_n1: getValoreNumerico('h3_serv_n1'),
                h3_god_n1: getValoreNumerico('h3_god_n1'),
                h3_pers_n1: getValoreNumerico('h3_pers_n1'),
                h3_amm_n1: getValoreNumerico('h3_amm_n1'),
                h3_fin_n1: getValoreNumerico('h3_fin_n1'),
                h3_straord_n1: getValoreNumerico('h3_straord_n1'),
                h3_imp_n1: getValoreNumerico('h3_imp_n1'),
		h3_attivo_n1: getValoreNumerico('h3_attivo_n1'),
                
                // n+2
                h3_fatt_n2: getValoreNumerico('h3_fatt_n2'),
                h3_altri_n2: getValoreNumerico('h3_altri_n2'),
                h3_mp_n2: getValoreNumerico('h3_mp_n2'),
                h3_serv_n2: getValoreNumerico('h3_serv_n2'),
                h3_god_n2: getValoreNumerico('h3_god_n2'),
                h3_pers_n2: getValoreNumerico('h3_pers_n2'),
                h3_amm_n2: getValoreNumerico('h3_amm_n2'),
                h3_fin_n2: getValoreNumerico('h3_fin_n2'),
                h3_straord_n2: getValoreNumerico('h3_straord_n2'),
                h3_imp_n2: getValoreNumerico('h3_imp_n2'),
		h3_attivo_n2: getValoreNumerico('h3_attivo_n2'),
                
                // n+3
                h3_fatt_n3: getValoreNumerico('h3_fatt_n3'),
                h3_altri_n3: getValoreNumerico('h3_altri_n3'),
                h3_mp_n3: getValoreNumerico('h3_mp_n3'),
                h3_serv_n3: getValoreNumerico('h3_serv_n3'),
                h3_god_n3: getValoreNumerico('h3_god_n3'),
                h3_pers_n3: getValoreNumerico('h3_pers_n3'),
                h3_amm_n3: getValoreNumerico('h3_amm_n3'),
                h3_fin_n3: getValoreNumerico('h3_fin_n3'),
                h3_straord_n3: getValoreNumerico('h3_straord_n3'),
                h3_imp_n3: getValoreNumerico('h3_imp_n3'),
		h3_attivo_n3: getValoreNumerico('h3_attivo_n3')
            },
            
            // H.5, H.6, H.7, H.8
            h5_costibenefici: document.getElementById('h5_costibenefici')?.value || '',
            
            pianoOccupazionale: {
                h6_dir_2024: getValoreNumerico('h6_dir_2024'),
                h6_dir_prev: getValoreNumerico('h6_dir_prev'),
                h6_quad_2024: getValoreNumerico('h6_quad_2024'),
                h6_quad_prev: getValoreNumerico('h6_quad_prev'),
                h6_imp_2024: getValoreNumerico('h6_imp_2024'),
                h6_imp_prev: getValoreNumerico('h6_imp_prev'),
                h6_op_2024: getValoreNumerico('h6_op_2024'),
                h6_op_prev: getValoreNumerico('h6_op_prev')
            },
            
            h7_rischi: document.getElementById('h7_rischi')?.value || '',
            h8_ottimizzazione: document.getElementById('h8_ottimizzazione')?.value || '',
            
            // Allegati
            noteAllegati: document.getElementById('noteAllegati')?.value || ''
        };
        
        // ==========================================
        // FASE 6 - CHECKLIST (già salvata)
        // ==========================================
        // datiDomanda.checklist è già aggiornato
        
        console.log('✅ Tutti i dati salvati con successo');
        return true;
        
    } catch (error) {
        console.error('❌ ERRORE salvataggio completo:', error);
        return false;
    }
}

function salvaTabellaDeMinimiis() {
    try {
        const tbody = document.getElementById('deMinimisRows');
        if (!tbody) return [];
        
        const aiuti = [];
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 4) {
                const ente = inputs[0].value;
                const normativa = inputs[1].value;
                const data = inputs[2].value;
                const importo = parseFloat(inputs[3].value) || 0;
                
                if (ente || normativa || data || importo > 0) {
                    aiuti.push({ ente, normativa, data, importo });
                }
            }
        });
        
        return aiuti;
    } catch (error) {
        console.error('Errore salvataggio De Minimis:', error);
        return [];
    }
}

// ============================================
// POPOLAMENTO COMPLETO - TUTTI I CAMPI
// ============================================

function popolaTuttiICampi() {
    try {
        console.log('🔄 Popolamento completo di tutti i campi...');
        
        // ==========================================
        // FASE 1
        // ==========================================
        if (datiDomanda.impresa) {
            document.getElementById('ragioneSociale').value = datiDomanda.impresa.ragioneSociale || '';
            document.getElementById('partitaIva').value = datiDomanda.impresa.partitaIva || '';
            document.getElementById('codiceFiscale').value = datiDomanda.impresa.codiceFiscale || '';
            document.getElementById('pec').value = datiDomanda.impresa.pec || '';
            document.getElementById('annoCostituzione').value = datiDomanda.impresa.annoCostituzione || '';
            document.getElementById('sedeLegale').value = datiDomanda.impresa.sedeLegale || '';
            document.getElementById('sedeSicilia').value = datiDomanda.impresa.sedeSicilia || '';
            document.getElementById('dimensioneImpresa').value = datiDomanda.impresa.dimensione || '';
        }
        
        if (datiDomanda.legaleRappresentante) {
            document.getElementById('lrNome').value = datiDomanda.legaleRappresentante.nome || '';
            document.getElementById('lrCognome').value = datiDomanda.legaleRappresentante.cognome || '';
            document.getElementById('lrCF').value = datiDomanda.legaleRappresentante.codiceFiscale || '';
            document.getElementById('lrLuogoNascita').value = datiDomanda.legaleRappresentante.luogoNascita || '';
            document.getElementById('lrDataNascita').value = datiDomanda.legaleRappresentante.dataNascita || '';
            document.getElementById('lrResidenza').value = datiDomanda.legaleRappresentante.residenza || '';
        }
        
        if (datiDomanda.requisitiAmmissibilita) {
            document.getElementById('checkDURC').checked = datiDomanda.requisitiAmmissibilita.checkDURC || false;
            document.getElementById('checkAntimafia').checked = datiDomanda.requisitiAmmissibilita.checkAntimafia || false;
            document.getElementById('checkRevoche').checked = datiDomanda.requisitiAmmissibilita.checkRevoche || false;
            document.getElementById('checkProgettoDiverso').checked = datiDomanda.requisitiAmmissibilita.checkProgettoDiverso || false;
        }
        
        // ==========================================
        // FASE 2
        // ==========================================
        if (datiDomanda.economia) {
            document.getElementById('annoRiferimento').value = datiDomanda.economia.annoRiferimento || '';
            document.getElementById('tipoDocumento').value = datiDomanda.economia.tipoDocumento || '';
            
            document.getElementById('valoreProduzione').value = datiDomanda.economia.valoreProduzione || '';
            document.getElementById('materiePrime').value = datiDomanda.economia.materiePrime || '';
            document.getElementById('costiServizi').value = datiDomanda.economia.costiServizi || '';
            document.getElementById('costiBeniTerzi').value = datiDomanda.economia.costiBeniTerzi || '';
            document.getElementById('spesePersonale').value = datiDomanda.economia.spesePersonale || '';
            document.getElementById('variazioniRimanenze').value = datiDomanda.economia.variazioniRimanenze || '';
            document.getElementById('oneriDiversi').value = datiDomanda.economia.oneriDiversi || '';
            document.getElementById('ammortamenti').value = datiDomanda.economia.ammortamenti || '';
            
            document.getElementById('costoTotale').value = datiDomanda.economia.costoTotale || '';
            document.getElementById('modalitaErogazione').value = datiDomanda.economia.modalitaErogazione || '';
            document.getElementById('richiestaAnticipo').value = datiDomanda.economia.richiestaAnticipo || '';
            document.getElementById('disponibilitaFinanziaria').value = datiDomanda.economia.disponibilitaFinanziaria || '';
            
            document.getElementById('tipoProfessionista').value = datiDomanda.economia.tipoProfessionista || '';
            document.getElementById('nomeProfessionista').value = datiDomanda.economia.nomeProfessionista || '';
            document.getElementById('cfProfessionista').value = datiDomanda.economia.cfProfessionista || '';
            document.getElementById('iscrizioneAlbo').value = datiDomanda.economia.iscrizioneAlbo || '';
            document.getElementById('sedeProfessionista').value = datiDomanda.economia.sedeProfessionista || '';
            
            // Ricalcola
            setTimeout(() => {
                calcolaMOLAutomatico();
                aggiornaCalcoliProgetto();
            }, 100);
        }
        
        // ==========================================
        // FASE 3
        // ==========================================
        if (datiDomanda.preventivi && datiDomanda.preventivi.length > 0) {
            mostraPreventivi();
        }
        
        // ==========================================
        // FASE 4
        // ==========================================
        if (datiDomanda.allegato21) {
            document.getElementById('titoloProgettoIstanza').value = datiDomanda.allegato21.titoloProgetto || '';
            
            // Dichiarazioni
            if (datiDomanda.allegato21.dichiarazioni) {
                const dich = datiDomanda.allegato21.dichiarazioni;
                document.getElementById('dichA').checked = dich.dichA || false;
                document.getElementById('dichB').checked = dich.dichB || false;
                document.getElementById('dichC').checked = dich.dichC || false;
                document.getElementById('dichD').checked = dich.dichD || false;
                document.getElementById('dichE').checked = dich.dichE || false;
                document.getElementById('dichF').checked = dich.dichF || false;
                document.getElementById('dichG').checked = dich.dichG || false;
                document.getElementById('dichH').checked = dich.dichH || false;
                document.getElementById('dichI').checked = dich.dichI || false;
                document.getElementById('dichL').checked = dich.dichL || false;
            }
            
            // Dimensione aziendale
            if (datiDomanda.allegato21.dimensioneAziendale) {
                const dim = datiDomanda.allegato21.dimensioneAziendale;
                document.getElementById('ula_dichiarante').value = dim.ula_dichiarante || '';
                document.getElementById('fatturato_dichiarante').value = dim.fatturato_dichiarante || '';
                document.getElementById('bilancio_dichiarante').value = dim.bilancio_dichiarante || '';
                document.getElementById('ula_associate').value = dim.ula_associate || '';
                document.getElementById('fatturato_associate').value = dim.fatturato_associate || '';
                document.getElementById('bilancio_associate').value = dim.bilancio_associate || '';
                document.getElementById('ula_collegate').value = dim.ula_collegate || '';
                document.getElementById('fatturato_collegate').value = dim.fatturato_collegate || '';
                document.getElementById('bilancio_collegate').value = dim.bilancio_collegate || '';
            }
            
            document.getElementById('tipoImpresa').value = datiDomanda.allegato21.tipoImpresa || '';
            document.getElementById('haDeMinimis').value = datiDomanda.allegato21.haDeMinimis || '';
            document.getElementById('fusioni').value = datiDomanda.allegato21.fusioni || '';
            
            // Ripopola tabella De Minimis
            if (datiDomanda.allegato21.aiutiDeMinimis && datiDomanda.allegato21.aiutiDeMinimis.length > 0) {
                popolaTabellaDeMinimiis(datiDomanda.allegato21.aiutiDeMinimis);
            }
            
            document.getElementById('numeroMarcaBollo').value = datiDomanda.allegato21.numeroMarcaBollo || '';
            document.getElementById('dataMarcaBollo').value = datiDomanda.allegato21.dataMarcaBollo || '';
        }
        
        // ==========================================
        // FASE 5 - FORMULARIO COMPLETO
        // ==========================================
        if (datiDomanda.formulario) {
            const f = datiDomanda.formulario;
            
            // Sezione A-G
            document.getElementById('titoloProgetto').value = f.titoloProgetto || '';
            document.getElementById('acronimoProgetto').value = f.acronimoProgetto || '';
            document.getElementById('durataProgetto').value = f.durataProgetto || '';
            document.getElementById('missionAttivita').value = f.missionAttivita || '';
            document.getElementById('attivitaEconomica').value = f.attivitaEconomica || '';
            document.getElementById('posizionamentoCompetitivo').value = f.posizionamentoCompetitivo || '';
            document.getElementById('contestualizzazioneFabbisogni').value = f.contestualizzazioneFabbisogni || '';
            document.getElementById('obiettiviPerseguiti').value = f.obiettiviPerseguiti || '';
            document.getElementById('capacitaAmministrativa').value = f.capacitaAmministrativa || '';
            document.getElementById('gruppoDiLavoro').value = f.gruppoDiLavoro || '';
            document.getElementById('obiettiviGeneraliSpecifici').value = f.obiettiviGeneraliSpecifici || '';
            document.getElementById('quadroLogico').value = f.quadroLogico || '';
            document.getElementById('implementazioneInnovazioni').value = f.implementazioneInnovazioni || '';
            document.getElementById('coinvolgimentoUtilizzatori').value = f.coinvolgimentoUtilizzatori || '';
            document.getElementById('matriceWP').value = f.matriceWP || '';
            document.getElementById('cronoprogramma').value = f.cronoprogramma || '';
            document.getElementById('sistemaMonitoraggio').value = f.sistemaMonitoraggio || '';
            document.getElementById('valutazioneImpatto').value = f.valutazioneImpatto || '';
            document.getElementById('ricaduteOccupazionali').value = f.ricaduteOccupazionali || '';
            document.getElementById('quotaTecnologieAbilitanti').value = f.quotaTecnologieAbilitanti || '';
            
            // Sezione H
            document.getElementById('giustificazioneSpese').value = f.giustificazioneSpese || '';
            document.getElementById('fontiFinanziamento').value = f.fontiFinanziamento || '';
            
            // H.2 Piano Coperture
            if (f.pianoCoperture) {
                const pc = f.pianoCoperture;
                document.getElementById('h2_inv_immat_anno1').value = pc.h2_inv_immat_anno1 || '';
                document.getElementById('h2_inv_immat_tot').value = pc.h2_inv_immat_tot || '';
                document.getElementById('h2_inv_mat_anno1').value = pc.h2_inv_mat_anno1 || '';
                document.getElementById('h2_inv_mat_tot').value = pc.h2_inv_mat_tot || '';
                document.getElementById('h2_iva_anno1').value = pc.h2_iva_anno1 || '';
                document.getElementById('h2_iva_tot').value = pc.h2_iva_tot || '';
                document.getElementById('h2_contributo_anno1').value = pc.h2_contributo_anno1 || '';
                document.getElementById('h2_cap_sociale_anno1').value = pc.h2_cap_sociale_anno1 || '';
                document.getElementById('h2_cap_sociale_tot').value = pc.h2_cap_sociale_tot || '';
                document.getElementById('h2_finanz_soci_anno1').value = pc.h2_finanz_soci_anno1 || '';
                document.getElementById('h2_finanz_soci_tot').value = pc.h2_finanz_soci_tot || '';
                document.getElementById('h2_riserve_anno1').value = pc.h2_riserve_anno1 || '';
                document.getElementById('h2_riserve_tot').value = pc.h2_riserve_tot || '';
                document.getElementById('h2_finanz_ml_anno1').value = pc.h2_finanz_ml_anno1 || '';
                document.getElementById('h2_finanz_ml_tot').value = pc.h2_finanz_ml_tot || '';
                document.getElementById('h2_finanz_breve_anno1').value = pc.h2_finanz_breve_anno1 || '';
                document.getElementById('h2_finanz_breve_tot').value = pc.h2_finanz_breve_tot || '';
                
                setTimeout(() => calcolaH2(), 100);
            }
            
            // H.3 Conto Economico
            document.getElementById('strategiaSostenibilita').value = f.strategiaSostenibilita || '';
            
            if (f.contoEconomico) {
                const ce = f.contoEconomico;
                
                // 2023
                document.getElementById('h3_fatt_2023').value = ce.h3_fatt_2023 || '';
                document.getElementById('h3_altri_2023').value = ce.h3_altri_2023 || '';
                document.getElementById('h3_mp_2023').value = ce.h3_mp_2023 || '';
                document.getElementById('h3_serv_2023').value = ce.h3_serv_2023 || '';
                document.getElementById('h3_god_2023').value = ce.h3_god_2023 || '';
                document.getElementById('h3_pers_2023').value = ce.h3_pers_2023 || '';
                document.getElementById('h3_amm_2023').value = ce.h3_amm_2023 || '';
                document.getElementById('h3_fin_2023').value = ce.h3_fin_2023 || '';
                document.getElementById('h3_straord_2023').value = ce.h3_straord_2023 || '';
                document.getElementById('h3_imp_2023').value = ce.h3_imp_2023 || '';
		document.getElementById('h3_attivo_2023').value = ce.h3_attivo_2023 || '';
                
                // 2024
                document.getElementById('h3_fatt_2024').value = ce.h3_fatt_2024 || '';
                document.getElementById('h3_altri_2024').value = ce.h3_altri_2024 || '';
                document.getElementById('h3_mp_2024').value = ce.h3_mp_2024 || '';
                document.getElementById('h3_serv_2024').value = ce.h3_serv_2024 || '';
                document.getElementById('h3_god_2024').value = ce.h3_god_2024 || '';
                document.getElementById('h3_pers_2024').value = ce.h3_pers_2024 || '';
                document.getElementById('h3_amm_2024').value = ce.h3_amm_2024 || '';
                document.getElementById('h3_fin_2024').value = ce.h3_fin_2024 || '';
                document.getElementById('h3_straord_2024').value = ce.h3_straord_2024 || '';
                document.getElementById('h3_imp_2024').value = ce.h3_imp_2024 || '';
		document.getElementById('h3_attivo_2024').value = ce.h3_attivo_2024 || '';
                
                // n+1, n+2, n+3
                document.getElementById('h3_fatt_n1').value = ce.h3_fatt_n1 || '';
                document.getElementById('h3_altri_n1').value = ce.h3_altri_n1 || '';
                document.getElementById('h3_mp_n1').value = ce.h3_mp_n1 || '';
                document.getElementById('h3_serv_n1').value = ce.h3_serv_n1 || '';
                document.getElementById('h3_god_n1').value = ce.h3_god_n1 || '';
                document.getElementById('h3_pers_n1').value = ce.h3_pers_n1 || '';
                document.getElementById('h3_amm_n1').value = ce.h3_amm_n1 || '';
                document.getElementById('h3_fin_n1').value = ce.h3_fin_n1 || '';
                document.getElementById('h3_straord_n1').value = ce.h3_straord_n1 || '';
                document.getElementById('h3_imp_n1').value = ce.h3_imp_n1 || '';
		document.getElementById('h3_attivo_n1').value = ce.h3_attivo_n1 || '';
                
                document.getElementById('h3_fatt_n2').value = ce.h3_fatt_n2 || '';
                document.getElementById('h3_altri_n2').value = ce.h3_altri_n2 || '';
                document.getElementById('h3_mp_n2').value = ce.h3_mp_n2 || '';
                document.getElementById('h3_serv_n2').value = ce.h3_serv_n2 || '';
                document.getElementById('h3_god_n2').value = ce.h3_god_n2 || '';
                document.getElementById('h3_pers_n2').value = ce.h3_pers_n2 || '';
                document.getElementById('h3_amm_n2').value = ce.h3_amm_n2 || '';
                document.getElementById('h3_fin_n2').value = ce.h3_fin_n2 || '';
                document.getElementById('h3_straord_n2').value = ce.h3_straord_n2 || '';
                document.getElementById('h3_imp_n2').value = ce.h3_imp_n2 || '';
		document.getElementById('h3_attivo_n2').value = ce.h3_attivo_n2 || '';
                
                document.getElementById('h3_fatt_n3').value = ce.h3_fatt_n3 || '';
                document.getElementById('h3_altri_n3').value = ce.h3_altri_n3 || '';
                document.getElementById('h3_mp_n3').value = ce.h3_mp_n3 || '';
                document.getElementById('h3_serv_n3').value = ce.h3_serv_n3 || '';
                document.getElementById('h3_god_n3').value = ce.h3_god_n3 || '';
                document.getElementById('h3_pers_n3').value = ce.h3_pers_n3 || '';
                document.getElementById('h3_amm_n3').value = ce.h3_amm_n3 || '';
                document.getElementById('h3_fin_n3').value = ce.h3_fin_n3 || '';
                document.getElementById('h3_straord_n3').value = ce.h3_straord_n3 || '';
                document.getElementById('h3_imp_n3').value = ce.h3_imp_n3 || '';
		document.getElementById('h3_attivo_n3').value = ce.h3_attivo_n3 || '';
                
                setTimeout(() => calcolaH3(), 100);
            }
            
            // H.5-H.8
            document.getElementById('h5_costibenefici').value = f.h5_costibenefici || '';
            
            if (f.pianoOccupazionale) {
                const po = f.pianoOccupazionale;
                document.getElementById('h6_dir_2024').value = po.h6_dir_2024 || '';
                document.getElementById('h6_dir_prev').value = po.h6_dir_prev || '';
                document.getElementById('h6_quad_2024').value = po.h6_quad_2024 || '';
                document.getElementById('h6_quad_prev').value = po.h6_quad_prev || '';
                document.getElementById('h6_imp_2024').value = po.h6_imp_2024 || '';
                document.getElementById('h6_imp_prev').value = po.h6_imp_prev || '';
                document.getElementById('h6_op_2024').value = po.h6_op_2024 || '';
                document.getElementById('h6_op_prev').value = po.h6_op_prev || '';
                
                setTimeout(() => calcolaVariazioniH6(), 100);
            }
            
            document.getElementById('h7_rischi').value = f.h7_rischi || '';
            document.getElementById('h8_ottimizzazione').value = f.h8_ottimizzazione || '';
            document.getElementById('noteAllegati').value = f.noteAllegati || '';
        }
        
        console.log('✅ Tutti i campi popolati con successo');
        
    } catch (error) {
        console.error('❌ ERRORE popolamento:', error);
        alert('⚠️ Alcuni campi potrebbero non essere stati caricati.\n\nVerifica i dati.');
    }
}

function popolaTabellaDeMinimiis(aiuti) {
    try {
        const tbody = document.getElementById('deMinimisRows');
        if (!tbody || !aiuti || aiuti.length === 0) return;
        
        // Mostra tabella
        document.getElementById('haDeMinimis').value = 'si';
        toggleDeMinimisTable();
        
        // Pulisci righe esistenti
        tbody.innerHTML = '';
        
        // Aggiungi righe
        aiuti.forEach(aiuto => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" value="${aiuto.ente || ''}"></td>
                <td><input type="text" class="form-control form-control-sm" value="${aiuto.normativa || ''}"></td>
                <td><input type="date" class="form-control form-control-sm" value="${aiuto.data || ''}"></td>
                <td><input type="number" class="form-control form-control-sm" step="0.01" value="${aiuto.importo || ''}"></td>
                <td><button class="btn btn-sm btn-danger" onclick="rimuoviRigaDeMinimis(this)"><i class="fas fa-trash"></i></button></td>
            `;
        });
        
    } catch (error) {
        console.error('Errore popolamento De Minimis:', error);
    }
}

// ============================================
// SALVATAGGIO PROGETTO CON SCELTA NOME
// ============================================

function salvaProgettoSuFile() {
    try {
        // SALVA TUTTO
        salvaTuttiIDati();
        
        // Suggerisci nome file
        const ragioneSociale = datiDomanda.impresa?.ragioneSociale || 'MiaImpresa';
        const piva = datiDomanda.impresa?.partitaIva || 'PIVA';
        const timestamp = new Date().toISOString().split('T')[0];
        const nomeDefault = `${ragioneSociale.replace(/[^a-zA-Z0-9]/g, '_')}_${piva}_${timestamp}`;
        
        // Chiedi nome file all'utente
        const nomeFile = prompt(
            '📁 SALVA PROGETTO\n\n' +
            'Inserisci il nome del file (senza estensione .json):\n\n' +
            'Il browser ti chiederà poi dove salvarlo.',
            nomeDefault
        );
        
        // Se l'utente annulla
        if (nomeFile === null) {
            console.log('❌ Salvataggio annullato dall\'utente');
            return;
        }
        
        // Se l'utente non inserisce nulla, usa il default
        const nomeFilePulito = (nomeFile.trim() || nomeDefault).replace(/[^a-zA-Z0-9_-]/g, '_');
        
        // Prepara oggetto completo
        const progetto = {
            metadata: {
                versione: '1.0',
                applicazione: 'DIGIT IMPRESE - Assistente Compilazione Domanda',
                dataSalvataggio: new Date().toISOString(),
                dataModifica: new Date().toISOString(),
                faseCorrente: currentStep,
                nomeProgetto: datiDomanda.impresa?.ragioneSociale || 'Progetto DIGIT IMPRESE',
                partitaIva: datiDomanda.impresa?.partitaIva || '',
                nomeFile: nomeFilePulito
            },
            datiDomanda: datiDomanda
        };
        
        // Crea JSON
        const jsonStr = JSON.stringify(progetto, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        
        // Usa File System Access API se disponibile (Chrome, Edge moderni)
        if ('showSaveFilePicker' in window) {
            salvaConFileSystemAPI(blob, nomeFilePulito, progetto);
        } else {
            // Fallback: download classico
            salvaConDownloadClassico(blob, nomeFilePulito);
        }
        
        // Salva anche in localStorage come backup
        localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
        localStorage.setItem('digitImpreseLastSave', new Date().toISOString());
        
    } catch (error) {
        console.error('❌ ERRORE salvataggio progetto:', error);
        alert('❌ Errore nel salvataggio del progetto:\n' + error.message);
    }
}

async function salvaConFileSystemAPI(blob, nomeFile, progetto) {
    try {
        const opts = {
            types: [{
                description: 'File Progetto DIGIT IMPRESE',
                accept: { 'application/json': ['.json'] }
            }],
            suggestedName: nomeFile + '.json'
        };
        
        const fileHandle = await window.showSaveFilePicker(opts);
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        
        alert('✅ Progetto salvato con successo!\n\n' +
              'File: ' + nomeFile + '.json\n\n' +
              'Potrai riaprirlo in qualsiasi momento cliccando su "Carica Progetto".');
        
        console.log('💾 Progetto salvato con File System API:', nomeFile + '.json');
        
    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('❌ Salvataggio annullato dall\'utente');
            return;
        }
        console.error('❌ ERRORE File System API:', error);
        // Fallback a download classico
        salvaConDownloadClassico(blob, nomeFile);
    }
}

function salvaConDownloadClassico(blob, nomeFile) {
    try {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = nomeFile + '.json';
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert('✅ Progetto salvato con successo!\n\n' +
              'File: ' + nomeFile + '.json\n\n' +
              'Il file è stato scaricato nella cartella Download.\n' +
              'Potrai riaprirlo in qualsiasi momento cliccando su "Carica Progetto".');
        
        console.log('💾 Progetto salvato (download classico):', nomeFile + '.json');
        
    } catch (error) {
        console.error('❌ ERRORE download:', error);
        alert('❌ Errore nel download del file:\n' + error.message);
    }
}

// AGGIORNA la funzione caricaProgettoDaFile per usare popolaTuttiICampi
function caricaProgettoDaFile(event) {
    try {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
            alert('⚠️ Seleziona un file .json valido!');
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const contenuto = e.target.result;
                const progetto = JSON.parse(contenuto);
                
                if (!progetto.metadata || !progetto.datiDomanda) {
                    throw new Error('File non valido: struttura dati mancante');
                }
                
                if (progetto.metadata.applicazione !== 'DIGIT IMPRESE - Assistente Compilazione Domanda') {
                    const conferma = confirm('⚠️ ATTENZIONE!\n\nQuesto file potrebbe non essere compatibile.\n\nContinuare comunque?');
                    if (!conferma) return;
                }
                
                const confermaCarica = confirm(
                    '📂 CARICAMENTO PROGETTO\n\n' +
                    'Progetto: ' + (progetto.metadata.nomeProgetto || 'N/D') + '\n' +
                    'P.IVA: ' + (progetto.metadata.partitaIva || 'N/D') + '\n' +
                    'Salvato il: ' + new Date(progetto.metadata.dataSalvataggio).toLocaleString('it-IT') + '\n' +
                    'Fase: ' + progetto.metadata.faseCorrente + '\n\n' +
                    'Tutti i dati correnti verranno sovrascritti.\n\n' +
                    'Continuare?'
                );
                
                if (!confermaCarica) return;
                
                // Carica dati
                datiDomanda = progetto.datiDomanda;
                
                // Ripopola TUTTI i campi
                popolaTuttiICampi();
                
                // Vai alla fase salvata
                const faseSalvata = progetto.metadata.faseCorrente || 1;
                goToStep(faseSalvata);
                
                // Salva in localStorage come backup
                localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
                
                alert('✅ Progetto caricato con successo!\n\n' +
                      'Progetto: ' + (progetto.metadata.nomeProgetto || 'N/D') + '\n' +
                      'Fase corrente: ' + faseSalvata);
                
                console.log('📂 Progetto caricato:', file.name);
                
            } catch (error) {
                console.error('❌ ERRORE parsing file:', error);
                alert('❌ Errore nel caricamento del file:\n\n' + error.message + '\n\nVerifica che il file sia un progetto DIGIT IMPRESE valido.');
            }
        };
        
        reader.onerror = function() {
            alert('❌ Errore nella lettura del file!');
        };
        
        reader.readAsText(file);
        event.target.value = '';
        
    } catch (error) {
        console.error('❌ ERRORE caricamento file:', error);
        alert('❌ Errore: ' + error.message);
    }
}

// Auto-save migliorato
function salvaAutomaticamente() {
    try {
        salvaTuttiIDati();
        localStorage.setItem('digitImpreseDomanda', JSON.stringify(datiDomanda));
        localStorage.setItem('digitImpreseLastSave', new Date().toISOString());
        console.log('💾 Auto-save completo:', new Date().toLocaleTimeString());
    } catch (error) {
        console.error('❌ Errore auto-save:', error);
    }
}

function calcolaPercentualeS3() {
    try {
        const quotaS3 = getValoreNumerico('quotaTecnologieAbilitanti');
        const costoTotale = datiDomanda.economia?.costoTotale || getValoreNumerico('costoTotale');
        
        const percentualeField = document.getElementById('percentualeTecnologieS3');
        
        if (!percentualeField) return;
        
        if (costoTotale === 0 || !costoTotale) {
            percentualeField.value = 'N/D (inserire costo totale in Fase 2)';
            percentualeField.style.color = '#dc3545';
            return;
        }
        
        if (quotaS3 === 0) {
            percentualeField.value = '0,00%';
            percentualeField.style.color = '#6c757d';
            return;
        }
        
        const percentuale = (quotaS3 / costoTotale) * 100;
        
        // Formatta percentuale
        percentualeField.value = percentuale.toFixed(2).replace('.', ',') + '%';
        
        // Colora in base al valore
        if (percentuale >= 60) {
            percentualeField.style.color = '#28a745'; // Verde
            percentualeField.style.fontWeight = 'bold';
        } else if (percentuale >= 40) {
            percentualeField.style.color = '#ffc107'; // Giallo
            percentualeField.style.fontWeight = 'bold';
        } else if (percentuale >= 20) {
            percentualeField.style.color = '#fd7e14'; // Arancione
            percentualeField.style.fontWeight = 'normal';
        } else {
            percentualeField.style.color = '#dc3545'; // Rosso
            percentualeField.style.fontWeight = 'normal';
        }
        
        console.log('📊 Percentuale S3 calcolata:', percentuale.toFixed(2) + '%');
        
    } catch (error) {
        console.error('❌ Errore calcolo percentuale S3:', error);
    }
}

function calcolaAutomaticoS3DaPreventivi() {
    try {
        if (!datiDomanda.preventivi || datiDomanda.preventivi.length === 0) {
            alert('⚠️ Nessun preventivo trovato!\n\nInserisci prima i preventivi nella Fase 3.');
            return;
        }
        
        // Somma preventivi lett_a e lett_c (tecnologie S3)
        let totaleS3 = 0;
        let preventiviS3 = [];
        
        datiDomanda.preventivi.forEach(prev => {
            if (prev.tipologia === 'lett_b' || prev.tipologia === 'lett_d') {
                totaleS3 += prev.importo;
                preventiviS3.push({
                    tipologia: prev.tipologia,
                    descrizione: prev.descrizione,
                    importo: prev.importo
                });
            }
        });
        
        if (totaleS3 === 0) {
            alert('ℹ️ Nessun preventivo S3 trovato!\n\n' +
                  'I preventivi S3 sono:\n' +
                  '• lett. b) Servizi di consulenza specialistica (S3)\n' +
                  '• lett. d) Tecnologie digitali evolute (S3)\n\n' +
                  'Verifica i preventivi inseriti nella Fase 3.');
            return;
        }
        
        // Mostra dettaglio
        let dettaglio = '📊 PREVENTIVI S3 TROVATI:\n\n';
        preventiviS3.forEach(prev => {
            const tipo = prev.tipologia === 'lett_a' ? 'Consulenza strategica S3' : 'Tecnologie evolute S3';
            dettaglio += `• ${tipo}\n  ${prev.descrizione.substring(0, 40)}...\n  ${formatEuro(prev.importo)}\n\n`;
        });
        dettaglio += `TOTALE S3: ${formatEuro(totaleS3)}\n\n`;
        dettaglio += 'Confermare il calcolo automatico?';
        
        const conferma = confirm(dettaglio);
        
        if (conferma) {
            document.getElementById('quotaTecnologieAbilitanti').value = totaleS3.toFixed(2);
            calcolaPercentualeS3();
            
            alert('✅ Importo S3 calcolato e inserito!\n\n' +
                  'Totale tecnologie abilitanti S3: ' + formatEuro(totaleS3));
        }
        
    } catch (error) {
        console.error('❌ Errore calcolo automatico S3:', error);
        alert('❌ Errore nel calcolo automatico: ' + error.message);
    }
}

function suggerisciTotaleAttivo() {
    const fatt2024 = getValoreNumerico('h3_fatt_2024');
    
    if (fatt2024 === 0) {
        alert('⚠️ Inserire prima il fatturato 2024');
        return;
    }
    
    // Stima tipica: Totale Attivo = 1.2 - 1.8 volte il fatturato
    const moltiplicatore = parseFloat(prompt(
        '📊 STIMA TOTALE ATTIVO\n\n' +
        'Inserisci il moltiplicatore del fatturato\n' +
        '(tipicamente tra 1.2 e 1.8)\n\n' +
        'Totale Attivo = Fatturato × Moltiplicatore',
        '1.5'
    ));
    
    if (isNaN(moltiplicatore)) return;
    
    const anni = ['2023', '2024', 'n1', 'n2', 'n3'];
    anni.forEach(anno => {
        const fatt = getValoreNumerico(`h3_fatt_${anno}`);
        const attivo = fatt * moltiplicatore;
        document.getElementById(`h3_attivo_${anno}`).value = attivo.toFixed(2);
    });
    
    calcolaH3();
    alert('✅ Totale Attivo stimato per tutti gli anni');
}
     
        // Esponi funzioni globali
        window.goToStep = goToStep;
        window.aggiungiPreventivo = aggiungiPreventivo;
        window.rimuoviPreventivo = rimuoviPreventivo;
        window.aggiornaChecklist = aggiornaChecklist;
        window.calcolaTotaliDimensione = calcolaTotaliDimensione;
        window.toggleDeMinimisTable = toggleDeMinimisTable;
        window.aggiungiRigaDeMinimis = aggiungiRigaDeMinimis;
        window.rimuoviRigaDeMinimis = rimuoviRigaDeMinimis;
        window.esportaPDF = esportaPDF;
        window.esportaExcel = esportaExcel;
        window.stampaIstanza = stampaIstanza;
        window.finalizza = finalizza;
        window.compilaAutomaticaWP = compilaAutomaticaWP;
        window.calcolaH2 = calcolaH2;
        window.precompilaDatiH2 = precompilaDatiH2;
        window.calcolaH3 = calcolaH3;
        window.calcolaH4 = calcolaH4;
        window.proiettaEserciziPrevisionali = proiettaEserciziPrevisionali;
        window.calcolaVariazioniH6 = calcolaVariazioniH6;
        window.generaCodiceIdentificativo = generaCodiceIdentificativo;
        window.salvaProgettoSuFile = salvaProgettoSuFile;
        window.caricaProgettoDaFile = caricaProgettoDaFile;
        window.nuovoProgetto = nuovoProgetto;
        window.salvaEFinalizza = salvaEFinalizza;
        window.ripristinaBackupAutomatico = ripristinaBackupAutomatico;
        window.salvaTuttiIDati = salvaTuttiIDati;
        window.popolaTuttiICampi = popolaTuttiICampi;
        window.salvaProgettoConNome = salvaProgettoConNome;
        window.esportaExcelConNome = esportaExcelConNome;
        window.esportaPDFConNome = esportaPDFConNome;
        window.calcolaPercentualeS3 = calcolaPercentualeS3;
        window.calcolaAutomaticoS3DaPreventivi = calcolaAutomaticoS3DaPreventivi;
        
        console.log('✅ Script caricato completamente');
    </script>
</body>
</html>
